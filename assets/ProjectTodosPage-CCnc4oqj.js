import{k as me,r as l,u as pe,h as he,l as ge,j as t,a as fe,L as xe,A as $,P as je,M as be,z as C,an as we,e as ye}from"./index-D-cHbBwn.js";import{T as J}from"./TodoItem-C11xVKdk.js";import{C as _}from"./CollapsibleSection-F92uqtdU.js";import{f as O,c as ve,b as Se}from"./dateFormatter-CUKId3Gl.js";import{A as Te}from"./AddTodoModal-CQJ0H9NW.js";import{E as ke}from"./EditTodoModal-C0ZpT35t.js";import{c as Ne}from"./emailService-Ce1ZuM1T.js";import{i as De}from"./pdfService-D-0A9fw7.js";import{e as Ce}from"./exportUtils-Bak1EFUX.js";import"./RecurrenceEditor-rLx-RXEn.js";const qe=()=>{const{projectId:b}=me(),[r,v]=l.useState(null),[R,F]=l.useState(!0),{addToast:d}=pe(),{settings:E}=he(),[V,I]=l.useState(!1),[G,Y]=l.useState(null),[S,H]=l.useState("all"),[m,K]=l.useState("all"),[M,T]=l.useState(!1),[u,w]=l.useState([]),[p,k]=l.useState([]),[h,N]=l.useState([]),g=l.useCallback(async()=>{if(b){F(!0);try{const e=await ge(b);v(e)}catch{d("Error fetching project todos","error")}finally{F(!1)}}},[b,d]);l.useEffect(()=>{g()},[g]);const q=async e=>{if(!r||!r.todos)return;const o=JSON.parse(JSON.stringify(r)),s=r.todos.find(a=>a.id===e);if(!s)return;let n;if(s.isCompleted)n=r.todos.map(a=>a.id===e?{...a,isCompleted:!1}:a);else{const a={...s,isCompleted:!0};if(n=r.todos.map(i=>i.id===e?a:i),r&&Ne(a,r,E),a.recurrenceType==="recurring"&&a.recurrence&&a.duration){const i=a.startDate?new Date(a.startDate):new Date(a.createdAt),A=ve(i,a.recurrence),ie=Se(A,a.duration),ue={id:ye(),description:a.description,createdAt:new Date().toISOString(),startDate:A.toISOString(),dueDate:ie.toISOString(),recurrenceType:"recurring",recurrence:a.recurrence,duration:a.duration,isCompleted:!1,group:a.group};n.push(ue),d(`נוצרה משימה חוזרת לתאריך ${O(A)}`,"info")}}const c={...r,todos:n,updatedAt:new Date().toISOString()};v(c);try{await C(c),d(s.isCompleted?"המשימה הוחזרה לביצוע":"המשימה הושלמה","success")}catch{d("שגיאה בעדכון המשימה","error"),v(o)}},Q=async e=>{if(!r)return;const o={...r,todos:[...r.todos||[],{...e,projectId:void 0}],updatedAt:new Date().toISOString()};try{await C(o),d("המשימה נוספה בהצלחה","success"),g()}catch{d("שגיאה בהוספת משימה","error")}},L=async e=>{if(r&&window.confirm("האם אתה בטוח שברצונך למחוק משימה זו?"))try{await we(b,e),d("המשימה נמחקה","success"),g()}catch{d("שגיאה במחיקת המשימה","error")}},W=async e=>{if(!r)return;const o={...r,todos:r.todos?.map(s=>s.id===e.id?e:s),updatedAt:new Date().toISOString()};try{await C(o),d("המשימה עודכנה בהצלחה","success"),g()}catch{d("שגיאה בעדכון המשימה","error")}},z=e=>{const o=r?.todos?.find(s=>s.id===e);o&&Y(o)},X=async(e,o)=>{if(!r||!r.todos)return;const s=[...r.todos],n=s.findIndex(i=>i.id===e);if(n===-1)return;const c=o==="up"?n-1:n+1;if(c<0||c>=s.length)return;[s[n],s[c]]=[s[c],s[n]];const a={...r,todos:s,updatedAt:new Date().toISOString()};v(a);try{await C(a)}catch{d("שגיאה בסידור המשימות","error"),g()}},Z=e=>{if(e.isCompleted)return"הושלם";if(!e.dueDate)return"אין תאריך יעד";const o=new Date(e.dueDate),s=new Date;return s.setHours(0,0,0,0),o<s?"פג תוקף":"בתהליך"},ee=()=>{if(!r||!r.todos||r.todos.length===0){d("אין משימות לייצוא","warning");return}const e=(r.todos||[]).map(o=>({תיאור:o.description,"תאריך התחלה":o.startDate?O(o.startDate):"-","תאריך יעד":o.dueDate?O(o.dueDate):"-",סטטוס:Z(o),קבוצה:o.group||"-"}));Ce(e,`todos_${r.name}`)},{uniqueYears:f,uniqueGroups:te}=l.useMemo(()=>{if(!r?.todos)return{uniqueYears:[],uniqueGroups:[]};const e=new Set(r.todos.map(s=>new Date(s.startDate||s.createdAt).getFullYear().toString())),o=new Set(r.todos.map(s=>s.group).filter(Boolean));return{uniqueYears:Array.from(e).sort((s,n)=>n.localeCompare(s)),uniqueGroups:Array.from(o).sort((s,n)=>s.localeCompare(n,"he"))}},[r?.todos]),y=l.useMemo(()=>{if(!r?.todos)return[];const e=new Set;return r.todos.forEach(s=>{e.add(s.group||"__none__")}),Array.from(e).sort((s,n)=>s==="__none__"?1:n==="__none__"?-1:s.localeCompare(n,"he"))},[r?.todos]),x=l.useMemo(()=>r?.todos?r.todos.filter(e=>{const o=new Date(e.startDate||e.createdAt).getFullYear().toString(),s=S==="all"||o===S,n=m==="all"||m===""?!0:m==="__none__"?!e.group:e.group===m;return s&&n}):[],[r?.todos,S,m]),{pendingTodoGroups:D,completedTodoGroups:P,pendingTodosCount:U,completedTodosCount:B}=l.useMemo(()=>{const e=n=>n.reduce((c,a)=>{const i=a.group?.trim()||"כללי";return c[i]||(c[i]=[]),c[i].push(a),c},{}),o=x.filter(n=>!n.isCompleted),s=x.filter(n=>n.isCompleted).sort((n,c)=>new Date(c.createdAt).getTime()-new Date(n.createdAt).getTime());return{pendingTodoGroups:e(o),completedTodoGroups:e(s),pendingTodosCount:o.length,completedTodosCount:s.length}},[x]),se=l.useMemo(()=>{const e=r?.todos?.map(o=>o.group).filter(Boolean);return[...new Set(e)]},[r?.todos]),j=l.useMemo(()=>x.filter(e=>{const o=new Date(e.startDate||e.createdAt).getFullYear().toString(),s=h.length===0||h.includes(o),n=e.group||"__none__",c=p.length===0||p.includes(n);return s&&c}),[x,p,h]);l.useEffect(()=>{M&&w(j.map(e=>e.id))},[j,M]);const oe=()=>{if(x.length===0){d("אין משימות לייצוא","warning");return}k(y),N(f),T(!0)},re=()=>{if(!r||u.length===0){d("יש לבחור לפחות משימה אחת לייצוא","warning");return}const e=r.todos.filter(o=>u.includes(o.id));d("מכין PDF...","info"),De({settings:E,project:r,todos:e}),T(!1)},ne=()=>{const e=j.map(s=>s.id),o=e.length>0&&e.every(s=>u.includes(s));w(o?s=>s.filter(n=>!e.includes(n)):s=>[...new Set([...s,...e])])},ae=e=>{k(o=>o.includes(e)?o.filter(s=>s!==e):[...o,e])},le=e=>{N(o=>o.includes(e)?o.filter(s=>s!==e):[...o,e])},de=()=>{p.length===y.length?k([]):k(y)},ce=()=>{h.length===f.length?N([]):N(f)};return R?t.jsx(fe,{text:"טוען משימות..."}):t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsxs("div",{children:[t.jsx("nav",{className:"text-sm mb-1",children:t.jsx(xe,{to:`/project/${b}`,className:"text-sky-600 hover:underline",children:"חזרה לבניין"})}),t.jsxs("h2",{className:"text-2xl font-semibold text-slate-700",children:["משימות עבור: ",r?.name]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("button",{onClick:oe,className:"btn-secondary flex items-center gap-2",children:[t.jsx($,{className:"w-5 h-5"}),"יצא PDF"]}),t.jsxs("button",{onClick:ee,className:"btn-secondary flex items-center gap-2",children:[t.jsx($,{className:"w-5 h-5"}),"יצא Excel"]}),t.jsxs("button",{onClick:()=>I(!0),className:"bg-sky-600 hover:bg-sky-700 text-white font-medium py-2 px-4 rounded-lg shadow-md flex items-center transition-colors",children:[t.jsx(je,{className:"w-5 h-5 me-2 rtl:ml-2"})," הוסף משימה"]})]})]}),t.jsxs("div",{className:"bg-white p-4 rounded-lg shadow-md border flex flex-wrap items-center gap-4",children:[t.jsxs("div",{className:"flex-1 min-w-[150px]",children:[t.jsx("label",{htmlFor:"groupFilter",className:"block text-sm font-medium text-slate-600",children:"סנן לפי קבוצה:"}),t.jsxs("select",{id:"groupFilter",value:m,onChange:e=>K(e.target.value),className:"w-full mt-1 select-class",children:[t.jsx("option",{value:"all",children:"כל הקבוצות"}),t.jsx("option",{value:"__none__",children:"ללא קבוצה"}),te.map(e=>t.jsx("option",{value:e,children:e},e))]})]}),t.jsxs("div",{className:"flex-1 min-w-[150px]",children:[t.jsx("label",{htmlFor:"yearFilter",className:"block text-sm font-medium text-slate-600",children:"סנן לפי שנה:"}),t.jsxs("select",{id:"yearFilter",value:S,onChange:e=>H(e.target.value),className:"w-full mt-1 select-class",children:[t.jsx("option",{value:"all",children:"כל השנים"}),f.map(e=>t.jsx("option",{value:e,children:e},e))]})]})]}),r?.todos&&r.todos.length>0?t.jsxs("div",{className:"space-y-6",children:[U>0&&t.jsx(_,{title:"משימות לביצוע",count:U,children:t.jsx("div",{className:"space-y-4",children:Object.keys(D).sort().map(e=>t.jsx(_,{title:t.jsx("h4",{className:"text-md font-semibold",children:e}),count:D[e].length,defaultOpen:!0,children:t.jsx("div",{className:"space-y-2",children:D[e].map((o,s)=>t.jsx(J,{todo:o,onToggle:q,onDelete:()=>L(o.id),onEdit:()=>z(o.id),onMove:X,isFirst:s===0,isLast:s===D[e].length-1},o.id))})},e))})}),B>0&&t.jsx(_,{title:"משימות שהושלמו",count:B,defaultOpen:!1,children:t.jsx("div",{className:"space-y-4",children:Object.keys(P).sort().map(e=>t.jsx(_,{title:t.jsx("h4",{className:"text-md font-semibold",children:e}),count:P[e].length,defaultOpen:!0,children:t.jsx("div",{className:"space-y-2",children:P[e].map(o=>t.jsx(J,{todo:o,onToggle:q,onDelete:()=>L(o.id),onEdit:()=>z(o.id)},o.id))})},e))})})]}):t.jsx("div",{className:"text-center p-10 bg-white rounded-lg shadow border",children:t.jsx("p",{className:"text-slate-500",children:"אין משימות בבניין זה."})}),t.jsx(Te,{isOpen:V,onClose:()=>I(!1),onSave:Q,groupSuggestions:se,projects:r?[r]:[]}),t.jsx(ke,{isOpen:!!G,onClose:()=>Y(null),todo:G,onSave:W}),t.jsx(be,{isOpen:M,onClose:()=>T(!1),title:"בחירת משימות להפקת PDF",size:"lg",children:t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4 p-2 bg-slate-50 rounded-md border",children:[t.jsxs("div",{children:[t.jsxs("div",{className:"flex justify-between items-center mb-1",children:[t.jsx("label",{className:"block text-sm font-medium text-slate-600",children:"סנן לפי שנה:"}),t.jsx("button",{onClick:ce,className:"text-xs text-sky-600 hover:underline",children:h.length===f.length?"בטל הכל":"בחר הכל"})]}),t.jsx("div",{className:"max-h-32 overflow-y-auto border rounded-md p-2 space-y-1 bg-white",children:f.map(e=>t.jsxs("label",{className:"flex items-center gap-2 p-1 hover:bg-slate-100 rounded",children:[t.jsx("input",{type:"checkbox",className:"form-checkbox",checked:h.includes(e),onChange:()=>le(e)}),e]},e))})]}),t.jsxs("div",{children:[t.jsxs("div",{className:"flex justify-between items-center mb-1",children:[t.jsx("label",{className:"block text-sm font-medium text-slate-600",children:"סנן לפי קבוצה:"}),t.jsx("button",{onClick:de,className:"text-xs text-sky-600 hover:underline",children:p.length===y.length?"בטל הכל":"בחר הכל"})]}),t.jsx("div",{className:"max-h-32 overflow-y-auto border rounded-md p-2 space-y-1 bg-white",children:y.map(e=>t.jsxs("label",{className:"flex items-center gap-2 p-1 hover:bg-slate-100 rounded",children:[t.jsx("input",{type:"checkbox",className:"form-checkbox",checked:p.includes(e),onChange:()=>ae(e)}),e==="__none__"?"ללא קבוצה":e]},e))})]})]}),t.jsx("button",{onClick:ne,className:"text-sm text-sky-600 hover:underline",children:j.length>0&&j.every(e=>u.includes(e.id))?"בטל בחירת הכל":"בחר הכל"}),t.jsx("div",{className:"max-h-[40vh] overflow-y-auto space-y-2 p-1 border rounded-md",children:j.map(e=>t.jsxs("label",{className:"flex items-center gap-3 p-2 hover:bg-slate-50 rounded-md cursor-pointer",children:[t.jsx("input",{type:"checkbox",className:"w-4 h-4 text-sky-600 rounded focus:ring-sky-500",checked:u.includes(e.id),onChange:o=>{o.target.checked?w(s=>[...s,e.id]):w(s=>s.filter(n=>n!==e.id))}}),t.jsxs("div",{className:"flex-grow",children:[t.jsx("span",{children:e.description}),t.jsxs("span",{className:"text-xs text-slate-500 block",children:[e.group||"ללא קבוצה"," / ",new Date(e.startDate||e.createdAt).getFullYear()]})]})]},e.id))}),t.jsxs("div",{className:"flex justify-end gap-2 pt-4 mt-2 border-t",children:[t.jsx("button",{onClick:()=>T(!1),className:"btn-secondary",children:"ביטול"}),t.jsxs("button",{onClick:re,disabled:u.length===0,className:"btn-primary",children:["הפק PDF (",u.length,")"]})]})]})}),t.jsx("style",{children:`.btn-secondary { padding: 0.5rem 1rem; background-color: #f1f5f9; color: #334155; border: 1px solid #cbd5e1; border-radius: 0.375rem; font-weight: 500; } .btn-secondary:hover { background-color: #e2e8f0; } .select-class { appearance-none; background-color: #fff; border: 1px solid #cbd5e1; border-radius: 0.375rem; padding: 0.5rem 2.5rem 0.5rem 0.75rem; font-size: 0.875rem; color: #334155; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: left 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; } .rtl .select-class { background-position: right 0.5rem center; padding: 0.5rem 0.75rem 0.5rem 2.5rem; } .btn-primary { padding: 0.5rem 1rem; background-color: #0284c7; color: white; border-radius: 0.375rem; font-weight: 500; } .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; } .form-checkbox { border-radius: 0.25rem; border-color: #94a3b8; color: #0284c7; } .form-checkbox:focus { ring-color: #38bdf8; }`})]})};export{qe as default};
