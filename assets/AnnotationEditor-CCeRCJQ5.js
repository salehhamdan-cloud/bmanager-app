import{r as o,e as R,j as t,u as D,M as H,T as P,a as J,aR as T}from"./index-D-cHbBwn.js";const O=(u,f,b)=>{const[d,l,p,w]=u,h=Math.atan2(w-l,p-d),k=b*3+5,g=new fabric.Line(u,{stroke:f,strokeWidth:b,selectable:!1,evented:!1}),n=new fabric.Triangle({left:p,top:w,originX:"center",originY:"center",selectable:!1,evented:!1,angle:h*180/Math.PI,width:k,height:k,fill:f});return new fabric.Group([g,n],{left:d,top:l,selectable:!0,evented:!0})},U=o.forwardRef(({image:u,shapes:f,onShapesChange:b,activeTool:d,toolSettings:l},p)=>{const w=o.useRef(null),h=o.useRef(null),k=o.useRef(null),g=o.useRef(!1),n=o.useRef(null),v=o.useRef(null);return o.useImperativeHandle(p,()=>({deselectShape:()=>{h.current?.discardActiveObject().renderAll()},getSelectedShapeId:()=>h.current?.getActiveObject()?.id,exportCanvas:async()=>{const e=h.current;if(!e)throw new Error("Canvas not available for export");return e.discardActiveObject(),e.renderAll(),e.toDataURL({format:"jpeg",quality:.9})}})),o.useEffect(()=>{if(!w.current||!k.current)return;const e=new fabric.Canvas(w.current,{selection:!0});h.current=e;const c=new ResizeObserver(a=>{const{width:s,height:i}=a[0].contentRect;e.setWidth(s),e.setHeight(i),e.renderAll()});return c.observe(k.current),()=>{c.disconnect(),e&&e.dispose(),h.current=null}},[]),o.useEffect(()=>{const e=h.current;!e||!u||fabric.Image.fromURL(u.src,(c,a)=>{if(a||!c){console.error("Fabric.js failed to load image from URL for annotation:",u.src);return}e.setBackgroundImage(c,e.renderAll.bind(e),{scaleX:e.width/c.width,scaleY:e.height/c.height,originX:"left",originY:"top"})},{crossOrigin:"Anonymous"})},[u]),o.useEffect(()=>{const e=h.current;!e||JSON.stringify(e.toJSON(["id"]).objects)===JSON.stringify(f)||e.loadFromJSON({objects:f},()=>{e.forEachObject(a=>{a.set({borderColor:"#0284c7",cornerColor:"#ffffff",cornerStrokeColor:"#0284c7",cornerSize:10,transparentCorners:!1})}),e.renderAll()})},[f]),o.useEffect(()=>{const e=h.current;if(!e)return;e.off("mouse:down"),e.off("mouse:move"),e.off("mouse:up"),e.off("object:modified"),e.off("path:created"),e.off("editing:exited");const c=()=>b(e.toJSON(["id"]).objects);e.on("object:modified",c),e.on("editing:exited",c),d==="pencil"?(e.isDrawingMode=!0,e.freeDrawingBrush.color=l.strokeColor,e.freeDrawingBrush.width=l.strokeWidth,e.on("path:created",a=>{a.path.set("id",R()),c()})):e.isDrawingMode=!1,["rectangle","circle","arrow","text"].includes(d)?(e.selection=!1,e.forEachObject(a=>a.set("selectable",!1)),e.on("mouse:down",a=>{g.current=!0;const s=e.getPointer(a.e);v.current={x:s.x,y:s.y};const i={left:s.x,top:s.y,stroke:l.strokeColor,strokeWidth:l.strokeWidth,fill:l.fillColor,id:R()};switch(d){case"rectangle":n.current=new fabric.Rect({...i,width:0,height:0});break;case"circle":n.current=new fabric.Circle({...i,radius:0});break;case"arrow":n.current=O([s.x,s.y,s.x,s.y],l.strokeColor,l.strokeWidth),n.current.id=i.id;break;case"text":const x=new fabric.IText("הקלד כאן",{...i,fill:l.strokeColor,fontSize:24,padding:5});e.add(x),e.setActiveObject(x),x.enterEditing(),g.current=!1,n.current=null;break}n.current&&e.add(n.current)}),e.on("mouse:move",a=>{if(!g.current||!v.current||!n.current)return;const s=e.getPointer(a.e),{x:i,y:x}=v.current;switch(d){case"rectangle":n.current.set({width:Math.abs(s.x-i),height:Math.abs(s.y-x),left:Math.min(s.x,i),top:Math.min(s.y,x)});break;case"circle":const S=Math.sqrt(Math.pow(s.x-i,2)+Math.pow(s.y-x,2))/2;n.current.set({radius:S,left:i+(s.x-i)/2,top:x+(s.y-x)/2,originX:"center",originY:"center"});break;case"arrow":e.remove(n.current);const y=O([i,x,s.x,s.y],l.strokeColor,l.strokeWidth);y.id=n.current.id,n.current=y,e.add(n.current);break}e.renderAll()}),e.on("mouse:up",()=>{g.current=!1,n.current&&(c(),n.current=null)})):(e.selection=!0,e.forEachObject(a=>a.set("selectable",!0)))},[d,l,b]),t.jsx("div",{ref:k,className:"w-full h-full touch-none",children:t.jsx("canvas",{ref:w})})}),C=({title:u,active:f,onClick:b,children:d})=>t.jsx("button",{type:"button",title:u,onClick:b,className:`p-2 rounded-lg transition-colors ${f?"bg-sky-600 text-white":"bg-slate-700 text-slate-300 hover:bg-slate-600"}`,children:d}),X=({isOpen:u,onClose:f,onSave:b,imageSrc:d,initialAnnotationData:l})=>{const p=o.useRef(null),{addToast:w}=D(),[h,k]=o.useState(null),[g,n]=o.useState([]),[v,e]=o.useState([[]]),[c,a]=o.useState(0),[s,i]=o.useState("select"),[x,S]=o.useState({strokeColor:"#ff0000",strokeWidth:5,fillColor:"transparent"}),[y,L]=o.useState(!0),N=o.useCallback(()=>{k(null),n([]),e([[]]),a(0),i("select"),L(!0)},[]);o.useEffect(()=>{if(u&&d){const r=new window.Image;r.crossOrigin="Anonymous";const m=()=>{k(r),L(!1);try{const j=JSON.parse(l||"[]"),A=Array.isArray(j)?j.filter(Boolean):[];n(A),e([A]),a(0)}catch{w("Could not load previous annotations.","warning"),n([]),e([[]]),a(0)}};r.onload=m,r.onerror=()=>{w("Failed to load image for annotation.","error"),L(!1),f()},r.src=d,r.complete&&m()}else N()},[u,d,l,w,f,N]);const M=r=>{n(r);const m=v.slice(0,c+1);m.push(r),e(m),a(m.length-1)},I=o.useCallback(()=>{if(c>0){const r=c-1;a(r),n(v[r])}},[v,c]),E=o.useCallback(()=>{if(c<v.length-1){const r=c+1;a(r),n(v[r])}},[v,c]),W=async()=>{if(p.current){p.current?.deselectShape();try{const r=await p.current.exportCanvas(),m=JSON.stringify(g);b({annotatedDataUrl:r,annotationData:m})}catch(r){w("Failed to save annotations.","error"),console.error(r)}}},B=()=>{const r=p.current?.getSelectedShapeId();if(r){const m=g.filter(j=>j.id!==r);M(m),p.current?.deselectShape()}else w("Please select a shape to delete.","info")},z=[{name:"select",title:"Select/Move",icon:t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",className:"w-5 h-5",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M15.042 21.672L13.684 16.6m0 0l-2.51 2.225.569-9.47 5.227 7.917-3.286-.672zM12 2.25a.75.75 0 01.75.75v.008l.008.008.008.008v.008l.008.008.008.008.008.008h.008a.75.75 0 010 1.5h-.008l-.008-.008L12 3.75l-.008.008-.008.008-.008.008v.008l-.008.008-.008.008H11.25a.75.75 0 010-1.5h.008l.008-.008.008-.008.008-.008V3a.75.75 0 01.75-.75z"})})},{name:"pencil",title:"Pencil",icon:t.jsx(T,{className:"w-5 h-5"})},{name:"rectangle",title:"Rectangle",icon:t.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",className:"w-5 h-5",children:[t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M21 12a9 9 0 11-18 0 9 9 0 0118 0z"}),t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M9 9.563C9 9.252 9.252 9 9.563 9h4.874c.311 0 .563.252.563.563v4.874c0 .311-.252.563-.563.563H9.563A.563.563 0 019 14.437V9.563z"})]})},{name:"circle",title:"Circle",icon:t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",className:"w-5 h-5",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})})},{name:"arrow",title:"Arrow",icon:t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",className:"w-5 h-5",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3"})})},{name:"text",title:"Text",icon:t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",className:"w-5 h-5",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M7.5 8.25h9m-9 3H12m-6.75 3h9m-9 3h3.375c.621 0 1.125-.504 1.125-1.125V18.375m-3.375 2.25c.621 0 1.125-.504 1.125-1.125V18.375m-3.375 2.25h13.5m-13.5 0V6.75A2.25 2.25 0 015.25 4.5h9.5A2.25 2.25 0 0117.25 6.75v12.75"})})}];return t.jsx(H,{isOpen:u,onClose:f,title:"Image Editor",size:"full",children:t.jsxs("div",{className:"flex flex-col h-full bg-slate-800",children:[t.jsxs("header",{className:"flex-shrink-0 p-2 bg-slate-900 flex items-center justify-between gap-4",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[z.map(r=>t.jsx(C,{title:r.title,active:s===r.name,onClick:()=>i(r.name),children:r.icon},r.name)),t.jsx(C,{title:"Delete Selected",active:!1,onClick:B,children:t.jsx(P,{className:"w-5 h-5"})})]}),t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsxs("label",{className:"flex items-center gap-2 text-sm text-slate-300",children:["Color:",t.jsx("input",{type:"color",value:x.strokeColor,onChange:r=>S(m=>({...m,strokeColor:r.target.value})),className:"bg-transparent border-0 w-8 h-8 p-0"})]}),t.jsx(C,{title:"Undo",active:!1,onClick:I,children:t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",className:"w-5 h-5",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M9 15L3 9m0 0l6-6M3 9h12a6 6 0 010 12h-3"})})}),t.jsx(C,{title:"Redo",active:!1,onClick:E,children:t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",className:"w-5 h-5",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M15 15l6-6m0 0l-6-6m6 6H9a6 6 0 000 12h3"})})})]})]}),t.jsx("main",{className:"flex-grow relative flex items-center justify-center overflow-auto p-4 bg-slate-800",children:y||!h?t.jsx(J,{text:"Loading image..."}):t.jsx(U,{ref:p,image:h,shapes:g,onShapesChange:M,activeTool:s,toolSettings:x})}),t.jsxs("footer",{className:"flex-shrink-0 p-3 bg-slate-900 flex justify-end gap-3",children:[t.jsx("button",{type:"button",onClick:f,className:"px-4 py-2 text-sm font-medium text-slate-300 bg-slate-700 hover:bg-slate-600 rounded-md",children:"Cancel"}),t.jsx("button",{type:"button",onClick:W,className:"px-6 py-2 text-sm font-medium text-white bg-sky-600 hover:bg-sky-700 rounded-md shadow-sm",children:"Save & Close"})]})]})})};export{X as A,U as a};
