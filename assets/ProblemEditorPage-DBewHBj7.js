import{k as Y,B as z,u as U,h as V,r as l,i as N,l as E,n as W,O as q,j as e,a as S,V as K,M as X,o as _,e as G,X as H,y as Q,E as Z}from"./index-D-cHbBwn.js";import{I as ee}from"./ImageUploader-QK9p397g.js";import{S as se,c as te}from"./aiService-BGt51fXt.js";import{a as ae}from"./emailService-Ce1ZuM1T.js";import"./imageService-DERf2zoE.js";import"./AnnotationEditor-CCeRCJQ5.js";import"./shareUtils-BhFQGnPw.js";import"./dateFormatter-CUKId3Gl.js";const ue=()=>{const{projectId:u,reportId:i,problemId:f}=Y(),h=z(),{addToast:o}=U(),{settings:y}=V(),[t,x]=l.useState({description:"",severity:N.LOW,notes:"",images:[],locationTag:"",workerIds:[],supplierIds:[],tenantIds:[]}),[C,R]=l.useState(null),[F,L]=l.useState([]),[b,j]=l.useState(!0),[v,A]=l.useState(!1),c=!!f,[k,I]=l.useState(!1),[D,w]=l.useState(null),g=l.useRef(null),P=l.useRef(!1),m=l.useMemo(()=>`autosave-problem-${f||`new-${i}`}`,[f,i]),T=l.useCallback(async()=>{if(u){j(!0);try{const[s,n]=await Promise.all([E(u),W()]);if(R(s),L(n),c&&f){const a=await q(f);if(a){x(a);const r=localStorage.getItem(m);if(r){const d=JSON.parse(r);new Date(d.updatedAt)>new Date(a.updatedAt)?(w(d),I(!0)):localStorage.removeItem(m)}}else o("תקלה לא נמצאה","error"),h(`/project/${u}/report/${i}`)}else{const a=localStorage.getItem(m);a&&(w(JSON.parse(a)),I(!0))}}catch(s){console.error("Error fetching data:",s),o("שגיאה בטעינת נתוני התקלה","error")}finally{j(!1),P.current=!0}}},[f,c,o,h,u,i,m]);l.useEffect(()=>{T()},[T]),l.useEffect(()=>{if(!(!P.current||k||b))return g.current&&clearTimeout(g.current),g.current=window.setTimeout(()=>{if(t.description){const s={...t,updatedAt:new Date().toISOString()};localStorage.setItem(m,JSON.stringify(s))}},1500),()=>{g.current&&clearTimeout(g.current)}},[t,m,k,b]);const p=s=>{const{name:n,value:a}=s.target;if(s.target.multiple){const r=Array.from(s.target.selectedOptions,d=>d.value);x(d=>({...d,[n]:r}))}else x(r=>({...r,[n]:a}))},$=s=>{x(n=>({...n,images:s}))},M=async()=>{if(!t.images||t.images.length===0){o("יש להעלות תמונה תחילה כדי להשתמש בתיאור AI","warning");return}A(!0);try{const s=t.images[0],n=s.dataUrl.split(",")[1];if(!n)throw new Error("Invalid image data");const a=await te(n,s.mimeType);x(r=>({...r,description:a})),o("תיאור AI נוצר בהצלחה","success")}catch(s){console.error("AI description error:",s),o(s instanceof Error?s.message:"שגיאה ביצירת תיאור AI","error")}finally{A(!1)}},B=async s=>{if(s.preventDefault(),!t.description||!i){o("תיאור התקלה הוא שדה חובה","warning");return}j(!0);let n=t.order??0;c||(n=(await _(i)).length);const a={id:c&&t.id?t.id:G(),reportId:i,description:t.description,severity:t.severity||N.LOW,notes:t.notes||"",images:t.images||[],locationTag:t.locationTag||"",workerIds:t.workerIds||[],supplierIds:t.supplierIds||[],tenantIds:t.tenantIds||[],createdAt:c&&t.createdAt?t.createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),order:n};try{if(c?(await H(a),o("התקלה עודכנה בהצלחה","success")):(await Q(a),o("תקלה חדשה נוספה בהצלחה","success")),a.severity===N.CRITICAL&&y.enableEmailNotifications&&y.notifyOnCriticalIssues)if(y.notificationEmailAddress){const r=await Z(i),d=await E(u);r&&d&&ae(a,r,d,y)}else o("לא הוגדרה כתובת מייל למשלוח התראות בהגדרות.","warning");localStorage.removeItem(m),h(`/project/${u}/report/${i}`)}catch(r){console.error("Error saving problem:",r),o("שגיאה בשמירת התקלה","error"),j(!1)}},J=()=>{D&&(x(D),o("התקדמות שוחזרה","success")),I(!1),w(null)},O=()=>{localStorage.removeItem(m),o("טיוטה נמחקה","info"),I(!1),w(null)};return b?e.jsx(S,{text:"טוען פרטי תקלה..."}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"max-w-2xl mx-auto bg-white p-6 sm:p-8 rounded-lg shadow-xl animate-fadeIn",children:[e.jsx("h2",{className:"text-2xl font-semibold text-sky-700 mb-6 border-b pb-3",children:c?"עריכת תקלה":"הוספת תקלה חדשה"}),e.jsxs("form",{onSubmit:B,className:"space-y-6",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("label",{htmlFor:"description",className:"block text-sm font-medium text-slate-700",children:"תיאור התקלה"}),e.jsxs("button",{type:"button",onClick:M,disabled:v||!t.images?.length,className:"flex items-center gap-1.5 px-2 py-1 text-xs font-medium text-purple-700 bg-purple-100 rounded-md hover:bg-purple-200 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",title:"צור תיאור אוטומטי מהתמונה הראשונה שהועלתה",children:[v?e.jsx(S,{size:"sm"}):e.jsx(se,{className:"w-4 h-4"}),v?"מעבד...":"צור תיאור עם AI"]})]}),e.jsx("textarea",{name:"description",id:"description",value:t.description,onChange:p,rows:3,required:!0,className:"mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"severity",className:"block text-sm font-medium text-slate-700",children:"רמת חומרה"}),e.jsx("select",{name:"severity",id:"severity",value:t.severity,onChange:p,className:"mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm",children:K.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"locationTag",className:"block text-sm font-medium text-slate-700",children:"תגית מיקום (אופציונלי)"}),e.jsx("input",{type:"text",name:"locationTag",id:"locationTag",value:t.locationTag||"",onChange:p,placeholder:"לדוגמה: מטבח, קומה 2 - חדר 201",className:"mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"notes",className:"block text-sm font-medium text-slate-700",children:"הערות נוספות"}),e.jsx("textarea",{name:"notes",id:"notes",value:t.notes,onChange:p,rows:4,className:"mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm"})]}),e.jsxs("div",{className:"space-y-4 pt-4 border-t",children:[e.jsx("h3",{className:"text-md font-semibold text-slate-700",children:"שיוך גורמים (אופציונלי)"}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"workerIds",className:"block text-sm font-medium text-slate-700",children:"עובדים"}),e.jsx("select",{multiple:!0,name:"workerIds",id:"workerIds",value:t.workerIds||[],onChange:p,className:"mt-1 block w-full input-class h-24",children:(C?.workers||[]).map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"supplierIds",className:"block text-sm font-medium text-slate-700",children:"ספקים"}),e.jsx("select",{multiple:!0,name:"supplierIds",id:"supplierIds",value:t.supplierIds||[],onChange:p,className:"mt-1 block w-full input-class h-24",children:F.map(s=>e.jsxs("option",{value:s.id,children:[s.name," (",s.group,")"]},s.id))})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"tenantIds",className:"block text-sm font-medium text-slate-700",children:"דיירים"}),e.jsx("select",{multiple:!0,name:"tenantIds",id:"tenantIds",value:t.tenantIds||[],onChange:p,className:"mt-1 block w-full input-class h-24",children:(C?.tenants||[]).map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))})]})]}),e.jsx(ee,{images:t.images||[],onImagesChange:$}),e.jsxs("div",{className:"flex justify-end space-x-3 rtl:space-x-reverse pt-4 border-t mt-6",children:[e.jsx("button",{type:"button",onClick:()=>h(`/project/${u}/report/${i}`),disabled:b,className:"px-4 py-2 text-sm font-medium text-slate-700 bg-slate-100 hover:bg-slate-200 rounded-md shadow-sm disabled:opacity-50",children:"ביטול"}),e.jsxs("button",{type:"submit",disabled:b,className:"px-6 py-2 text-sm font-medium text-white bg-sky-600 hover:bg-sky-700 rounded-md shadow-sm flex items-center justify-center disabled:opacity-50",children:[b&&e.jsx(S,{size:"sm"}),c?"שמור שינויים":"הוסף תקלה"]})]})]}),e.jsx("style",{children:`
          .input-class { display: block; width: 100%; border: 1px solid #cbd5e1; border-radius: 0.375rem; padding: 0.5rem 0.75rem; }
          @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
          }
          .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
        `})]}),e.jsxs(X,{isOpen:k,onClose:O,title:"שחזור התקדמות",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-slate-600",children:"נמצאו שינויים שלא נשמרו עבור תקלה זו. האם תרצה לשחזר אותם?"}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx("button",{onClick:O,className:"btn-secondary",children:"מחק טיוטה"}),e.jsx("button",{onClick:J,className:"btn-primary",children:"שחזר התקדמות"})]})]}),e.jsx("style",{children:".btn-primary { padding: 0.5rem 1rem; background-color: #0284c7; color: white; border-radius: 0.375rem; font-weight: 500; } .btn-secondary { padding: 0.5rem 1rem; background-color: #f1f5f9; color: #334155; border: 1px solid #cbd5e1; border-radius: 0.375rem; font-weight: 500; }"})]})]})};export{ue as default};
