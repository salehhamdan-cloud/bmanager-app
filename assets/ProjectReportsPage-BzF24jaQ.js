import{k as v,r as l,u as S,h as k,l as R,b as D,j as e,a as I,L as C,P as O,M as P,d as T,e as E,x as L}from"./index-D-cHbBwn.js";import{R as F}from"./ReportItem-D8suSJUd.js";import{t as M}from"./emailService-Ce1ZuM1T.js";import"./dateFormatter-CUKId3Gl.js";const z=()=>{const{projectId:r}=v(),[m,g]=l.useState(null),[u,j]=l.useState([]),[f,x]=l.useState(!0),{addToast:a}=S(),{settings:b}=k(),[w,n]=l.useState(!1),[s,h]=l.useState({title:"",description:"",group:"",date:new Date().toISOString().split("T")[0]}),i=l.useCallback(async()=>{if(r){x(!0);try{const[t,o]=await Promise.all([R(r),D(r)]);g(t),j(o.sort((d,p)=>new Date(p.date).getTime()-new Date(d.date).getTime()))}catch{a("Error fetching reports","error")}finally{x(!1)}}},[r,a]);l.useEffect(()=>{i()},[i]);const y=async t=>{if(window.confirm("האם אתה בטוח שברצונך למחוק דוח זה וכל התקלות הקשורות אליו?"))try{await T(t),a("הדוח נמחק בהצלחה","success"),i()}catch{a("שגיאה במחיקת הדוח","error")}},c=t=>{const{name:o,value:d}=t.target;h(p=>({...p,[o]:d}))},N=async t=>{if(t.preventDefault(),!s.title||!r){a("כותרת הדוח היא שדה חובה","warning");return}const o={id:E(),projectId:r,title:s.title,date:s.date?new Date(s.date).toISOString():new Date().toISOString(),description:s.description||"",group:s.group?.trim()||void 0,files:[],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};try{await L(o),a("דוח חדש נוסף בהצלחה","success"),m&&M(o,m,b),n(!1),h({title:"",description:"",group:"",date:new Date().toISOString().split("T")[0]}),i()}catch{a("שגיאה בהוספת הדוח","error")}};return f?e.jsx(I,{text:"טוען דוחות..."}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("nav",{className:"text-sm mb-1",children:e.jsx(C,{to:`/project/${r}`,className:"text-sky-600 hover:underline",children:"חזרה לבניין"})}),e.jsxs("h2",{className:"text-2xl font-semibold text-slate-700",children:["דוחות עבור: ",m?.name]})]}),e.jsxs("button",{onClick:()=>n(!0),className:"bg-sky-600 hover:bg-sky-700 text-white font-medium py-2 px-4 rounded-lg shadow-md flex items-center transition-colors",children:[e.jsx(O,{className:"w-5 h-5 me-2 rtl:ml-2"})," הוסף דוח"]})]}),u.length>0?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6",children:u.map(t=>e.jsx(F,{report:t,onDelete:y},t.id))}):e.jsx("div",{className:"text-center p-10 bg-white rounded-lg shadow border",children:e.jsx("p",{className:"text-slate-500",children:"לא נמצאו דוחות עבור בניין זה."})}),e.jsx(P,{isOpen:w,onClose:()=>n(!1),title:"הוספת דוח חדש",children:e.jsxs("form",{onSubmit:N,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"report-title",className:"block text-sm font-medium text-slate-700",children:"כותרת הדוח"}),e.jsx("input",{type:"text",name:"title",id:"report-title",value:s.title||"",onChange:c,required:!0,className:"mt-1 block w-full input-class"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"report-date",className:"block text-sm font-medium text-slate-700",children:"תאריך הדוח"}),e.jsx("input",{type:"date",name:"date",id:"report-date",value:s.date||"",onChange:c,required:!0,className:"mt-1 block w-full input-class"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"report-group",className:"block text-sm font-medium text-slate-700",children:"קבוצה (אופציונלי)"}),e.jsx("input",{type:"text",name:"group",id:"report-group",value:s.group||"",onChange:c,className:"mt-1 block w-full input-class",placeholder:"לדוגמה: בדיקות איטום"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"report-description",className:"block text-sm font-medium text-slate-700",children:"תיאור (אופציונלי)"}),e.jsx("textarea",{name:"description",id:"report-description",value:s.description||"",onChange:c,rows:4,className:"mt-1 block w-full input-class"})]}),e.jsxs("div",{className:"flex justify-end space-x-3 rtl:space-x-reverse pt-2",children:[e.jsx("button",{type:"button",onClick:()=>n(!1),className:"px-4 py-2 text-sm font-medium text-slate-700 bg-slate-100 hover:bg-slate-200 rounded-md shadow-sm",children:"ביטול"}),e.jsx("button",{type:"submit",className:"px-4 py-2 text-sm font-medium text-white bg-sky-600 hover:bg-sky-700 rounded-md shadow-sm",children:"צור דוח"})]})]})}),e.jsx("style",{children:".input-class { border: 1px solid #cbd5e1; border-radius: 0.375rem; padding: 0.5rem 0.75rem; width: 100%; } .input-class:focus { outline: none; border-color: #0284c7; box-shadow: 0 0 0 1px #0284c7; }"})]})};export{z as default};
