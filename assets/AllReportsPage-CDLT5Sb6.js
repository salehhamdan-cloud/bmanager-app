import{r as l,u as ae,h as le,ae as oe,g as ne,n as ie,j as e,a as U,P as ce,af as de,M as q,d as me,e as D,x as B,i as pe,y as ue}from"./index-D-cHbBwn.js";import{C as xe}from"./CollapsibleSection-F92uqtdU.js";import{S as he,g as ge}from"./aiService-BGt51fXt.js";import{c as fe,a as je}from"./pdfUtils-CkvU2BMR.js";import{t as be}from"./emailService-Ce1ZuM1T.js";import{R as we}from"./ReportItem-D8suSJUd.js";import"./dateFormatter-CUKId3Gl.js";const j=({label:f,value:I,currentValue:x,onClick:P})=>e.jsx("button",{onClick:()=>P(I),className:`px-3 py-1.5 text-sm font-medium rounded-md transition-colors ${x===I?"bg-sky-600 text-white shadow":"bg-slate-100 text-slate-700 hover:bg-slate-200"}`,children:f}),Ae=()=>{const[f,I]=l.useState([]),[x,P]=l.useState([]),[G,$]=l.useState([]),[z,T]=l.useState(!0),[b,v]=l.useState("date-desc"),[h,O]=l.useState(""),[W,y]=l.useState(!1),[a,k]=l.useState({projectId:"",title:"",date:new Date().toISOString().split("T")[0],description:"",workerIds:[],supplierIds:[],tenantIds:[]}),{addToast:i}=ae(),{settings:K}=le(),[N,H]=l.useState(""),[J,S]=l.useState(!1),[Q,C]=l.useState(!1),[p,L]=l.useState(null),[A,M]=l.useState(""),_=l.useRef(null),w=l.useCallback(async()=>{T(!0);try{const[t,r,s]=await Promise.all([oe(),ne(),ie()]),c=t.map(d=>{const n=r.find(o=>o.id===d.projectId);return{...d,projectName:n?.name||"Unknown Project"}});I(c),P(r),$(s)}catch(t){console.error("Error fetching all reports:",t),i("שגיאה בטעינת הדוחות","error")}finally{T(!1)}},[i]);l.useEffect(()=>{w()},[w]);const X=async t=>{if(window.confirm("האם אתה בטוח שברצונך למחוק דוח זה וכל התקלות והטפסים הקשורים אליו?"))try{await me(t),i("הדוח נמחק בהצלחה","success"),w()}catch(r){console.error("Error deleting report:",r),i("שגיאה במחיקת הדוח","error")}},g=t=>{const{name:r,value:s}=t.target;if(t.target.multiple){const c=Array.from(t.target.selectedOptions,d=>d.value);k(d=>({...d,[r]:c}))}else k(c=>({...c,[r]:s})),r==="projectId"&&k(c=>({...c,workerIds:[],tenantIds:[]}))},Y=async t=>{if(t.preventDefault(),!a.projectId||!a.title){i("יש לבחור בניין ולהזין כותרת לדוח","warning");return}const r={id:D(),projectId:a.projectId,title:a.title,date:new Date(a.date).toISOString(),group:a.group?.trim()||void 0,description:a.description,workerIds:a.workerIds||[],supplierIds:a.supplierIds||[],tenantIds:a.tenantIds||[],files:[],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};try{await B(r);const s=x.find(c=>c.id===a.projectId);s&&be(r,s,K),i("דוח חדש נוסף בהצלחה","success"),y(!1),k({projectId:"",title:"",date:new Date().toISOString().split("T")[0],description:"",workerIds:[],supplierIds:[],tenantIds:[]}),w()}catch{i("שגיאה בהוספת הדוח","error")}},Z=()=>{_.current?.click()},ee=async t=>{const r=t.target.files?.[0];if(r){S(!0),i("מעבד PDF (זה עשוי לקחת מספר דקות)...","info");try{const s=await new Promise((o,m)=>{const u=new FileReader;u.onload=R=>o(R.target?.result),u.onerror=R=>m(R),u.readAsDataURL(r)});i("שלב 1/3: מחלץ טקסט ותמונות מה-PDF...","info");const[c,d]=await Promise.all([fe(s),je(s)]);i("שלב 2/3: שולח לניתוח AI...","info");const n=await ge(c,d);L({report:n,pageImages:d}),M(x.length===1?x[0].id:""),C(!0)}catch(s){console.error("Error creating report from PDF:",s),i(s instanceof Error?s.message:"שגיאה ביצירת הדוח","error")}finally{S(!1),t.target&&(t.target.value="")}}},te=async()=>{if(!p||!A){i("יש לבחור בניין ליצירת הדוח","warning");return}S(!0),i("יוצר דוח ובעיות...","info");try{const t={id:D(),projectId:A,title:p.report.title,date:p.report.date?new Date(p.report.date).toISOString():new Date().toISOString(),description:p.report.description,files:[],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()},r=p.report.problems.map((s,c)=>{const n=(s.images||[]).map(o=>{const m=p.pageImages[o.imageIndex];return m?{id:D(),name:`Image from page ${o.imageIndex+1}.jpg`,mimeType:"image/jpeg",dataUrl:m,originalDataUrl:m,annotationData:"[]",createdAt:new Date().toISOString(),caption:o.caption||`From page ${o.imageIndex+1}`}:null}).filter(o=>o!==null);return{id:D(),reportId:t.id,description:s.description||"No description from AI",severity:s.severity||pe.LOW,notes:"",images:n,locationTag:s.locationTag,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),order:c,isFixed:!1}});await B(t),await Promise.all(r.map(s=>ue(s))),i("דוח נוצר בהצלחה מ-PDF!","success"),C(!1),L(null),w()}catch(t){console.error("Error confirming AI import:",t),i("שגיאה בשמירת הדוח","error")}finally{S(!1)}},se=l.useMemo(()=>{const t=new Set(f.map(r=>r.group).filter(Boolean));return Array.from(t).sort((r,s)=>r.localeCompare(s,"he"))},[f]),E=l.useMemo(()=>{let t=[...f];if(N){const n=N.toLowerCase();t=t.filter(o=>o.title.toLowerCase().includes(n)||o.projectName.toLowerCase().includes(n)||o.group&&o.group.toLowerCase().includes(n))}const s=[...t.filter(n=>h?h==="__none__"?!n.group:n.group===h:!0)],[c,d]=b.split("-");return s.sort((n,o)=>{let m,u;switch(c){case"projectName":m=n.projectName.toLowerCase(),u=o.projectName.toLowerCase();break;case"title":m=n.title.toLowerCase(),u=o.title.toLowerCase();break;case"date":default:m=new Date(n.date).getTime(),u=new Date(o.date).getTime();break}return m<u?d==="asc"?-1:1:m>u?d==="asc"?1:-1:0}),s},[f,b,h,N]),F=l.useMemo(()=>E.reduce((t,r)=>{const s=r.projectName;return t[s]||(t[s]={projectId:r.projectId,reports:[]}),t[s].reports.push(r),t},{}),[E]),re=l.useMemo(()=>Object.keys(F).sort((t,r)=>t.localeCompare(r,"he")),[F]);if(z)return e.jsx(U,{text:"טוען דוחות..."});const V=x.find(t=>t.id===a.projectId);return e.jsxs("div",{className:"animate-fadeIn",children:[J&&e.jsx("div",{className:"fixed inset-0 bg-slate-900 bg-opacity-60 backdrop-blur-sm z-[1001] flex items-center justify-center",children:e.jsx(U,{text:"מעבד קובץ בעזרת AI..."})}),e.jsx("input",{type:"file",ref:_,onChange:ee,accept:"application/pdf",className:"hidden"}),e.jsxs("div",{className:"flex justify-between items-center mb-6 flex-wrap gap-4",children:[e.jsx("h2",{className:"text-2xl font-bold text-slate-800",children:"כל הדוחות"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:Z,className:"bg-purple-100 hover:bg-purple-200 text-purple-800 font-medium py-2 px-4 rounded-lg shadow-md flex items-center transition-colors",children:[e.jsx(he,{className:"w-5 h-5 me-2 rtl:ml-2"})," הוסף דוח (AI)"]}),e.jsxs("button",{onClick:()=>y(!0),className:"bg-sky-600 hover:bg-sky-700 text-white font-medium py-2 px-4 rounded-lg shadow-md flex items-center transition-colors",children:[e.jsx(ce,{className:"w-5 h-5 me-2 rtl:ml-2"}),"הוסף דוח"]})]})]}),e.jsxs("div",{className:"bg-white p-4 rounded-lg shadow-md border mb-6 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 mb-2",children:"סנן לפי קבוצה:"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(j,{label:"הכל",value:"",currentValue:h,onClick:O}),e.jsx(j,{label:"ללא קבוצה",value:"__none__",currentValue:h,onClick:O}),se.map(t=>e.jsx(j,{label:t,value:t,currentValue:h,onClick:O},t))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 mb-2",children:"מיין לפי:"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(j,{label:"תאריך (החדש ביותר)",value:"date-desc",currentValue:b,onClick:v}),e.jsx(j,{label:"תאריך (הישן ביותר)",value:"date-asc",currentValue:b,onClick:v}),e.jsx(j,{label:"בניין (א-ת)",value:"projectName-asc",currentValue:b,onClick:v}),e.jsx(j,{label:"כותרת (א-ת)",value:"title-asc",currentValue:b,onClick:v})]})]}),e.jsxs("div",{className:"relative pt-2",children:[e.jsx("span",{className:"absolute inset-y-0 left-0 flex items-center pl-3 pt-2 rtl:right-0 rtl:pl-0 rtl:pr-3",children:e.jsx(de,{className:"w-5 h-5 text-slate-400"})}),e.jsx("input",{type:"search",placeholder:"חיפוש דוחות...",value:N,onChange:t=>H(t.target.value),className:"w-full pl-10 pr-4 py-2 rtl:pr-10 rtl:pl-4 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500"})]})]}),f.length===0?e.jsxs("div",{className:"text-center py-16 bg-white rounded-lg shadow-md border",children:[e.jsx("h3",{className:"text-2xl font-semibold text-slate-700",children:"לא נמצאו דוחות"}),e.jsx("p",{className:"text-slate-500 mt-2",children:h?"אין דוחות התואמים לסינון שנבחר.":"עדיין לא נוצרו דוחות באף בניין."})]}):e.jsx("div",{className:"space-y-4",children:re.map(t=>{const r=F[t];return e.jsx(xe,{count:r.reports.length,title:e.jsx("h3",{className:"text-xl font-semibold",children:t}),children:e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4",children:r.reports.map(s=>e.jsx(we,{report:s,onDelete:X},s.id))})},t)})}),e.jsx(q,{isOpen:W,onClose:()=>y(!1),title:"הוספת דוח חדש",size:"lg",children:e.jsxs("form",{onSubmit:Y,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"projectId",className:"block text-sm font-medium text-slate-700",children:"בניין"}),e.jsxs("select",{id:"projectId",name:"projectId",value:a.projectId,onChange:g,required:!0,className:"mt-1 block w-full input-class",children:[e.jsx("option",{value:"",disabled:!0,children:"בחר בניין..."}),x.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"title",className:"block text-sm font-medium text-slate-700",children:"כותרת הדוח"}),e.jsx("input",{type:"text",name:"title",value:a.title,onChange:g,required:!0,className:"mt-1 block w-full input-class"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"date",className:"block text-sm font-medium text-slate-700",children:"תאריך הדוח"}),e.jsx("input",{type:"date",name:"date",value:a.date,onChange:g,required:!0,className:"mt-1 block w-full input-class"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"group",className:"block text-sm font-medium text-slate-700",children:"קבוצה (אופציונלי)"}),e.jsx("input",{type:"text",name:"group",value:a.group||"",onChange:g,className:"mt-1 block w-full input-class",placeholder:"לדוגמה: בדיקות איטום"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"description",className:"block text-sm font-medium text-slate-700",children:"תיאור (אופציונלי)"}),e.jsx("textarea",{name:"description",value:a.description,onChange:g,rows:3,className:"mt-1 block w-full input-class"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"report-workers",className:"block text-sm font-medium text-slate-700",children:"עובדים משויכים"}),e.jsx("select",{multiple:!0,name:"workerIds",id:"report-workers",disabled:!a.projectId,value:a.workerIds||[],onChange:g,className:"mt-1 block w-full input-class h-24",children:(V?.workers||[]).map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"report-suppliers",className:"block text-sm font-medium text-slate-700",children:"ספקים משויכים"}),e.jsx("select",{multiple:!0,name:"supplierIds",id:"report-suppliers",value:a.supplierIds||[],onChange:g,className:"mt-1 block w-full input-class h-24",children:G.map(t=>e.jsxs("option",{value:t.id,children:[t.name," (",t.group,")"]},t.id))})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"report-tenants",className:"block text-sm font-medium text-slate-700",children:"דיירים משויכים"}),e.jsx("select",{multiple:!0,name:"tenantIds",id:"report-tenants",disabled:!a.projectId,value:a.tenantIds||[],onChange:g,className:"mt-1 block w-full input-class h-24",children:(V?.tenants||[]).map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4",children:[e.jsx("button",{type:"button",onClick:()=>y(!1),className:"px-4 py-2 text-sm font-medium text-slate-700 bg-slate-100 hover:bg-slate-200 rounded-md",children:"ביטול"}),e.jsx("button",{type:"submit",className:"px-4 py-2 text-sm font-medium text-white bg-sky-600 hover:bg-sky-700 rounded-md",children:"הוסף דוח"})]})]})}),e.jsx(q,{isOpen:Q,onClose:()=>C(!1),title:"אישור דוח מ-AI",children:p&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"כותרת דוח:"})," ",p.report.title]}),e.jsxs("p",{children:[e.jsx("strong",{children:"נמצאו:"})," ",p.report.problems.length," תקלות"]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700",children:"שייך לבניין:"}),e.jsxs("select",{value:A,onChange:t=>M(t.target.value),className:"input-class w-full mt-1",children:[e.jsx("option",{value:"",disabled:!0,children:"בחר בניין..."}),x.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4",children:[e.jsx("button",{type:"button",onClick:()=>C(!1),className:"px-4 py-2 text-sm font-medium text-slate-700 bg-slate-100 hover:bg-slate-200 rounded-md",children:"ביטול"}),e.jsx("button",{type:"button",onClick:te,disabled:!A,className:"px-4 py-2 text-sm font-medium text-white bg-sky-600 hover:bg-sky-700 rounded-md",children:"צור דוח"})]})]})})]})};export{Ae as default};
