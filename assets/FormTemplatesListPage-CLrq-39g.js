import{r as x,u as Q,G as V,j as e,a as O,P,p as W,T as w,M as F,a4 as S,a5 as D,a6 as p,a7 as Z,e as f,a8 as ee,a9 as se}from"./index-D-cHbBwn.js";import{a as te}from"./dateFormatter-CUKId3Gl.js";import{C as ae}from"./CollapsibleSection-F92uqtdU.js";import{S as A,d as le}from"./aiService-BGt51fXt.js";import{c as re}from"./pdfUtils-CkvU2BMR.js";const ne=[{value:p.YES_NO,label:"כן/לא"},{value:p.OK_NOT_OK,label:"תקין/לא"},{value:p.OK_NOT_OK_NA,label:"תקין/לא/לא רלוונטי"},{value:p.OPTIONS,label:"אפשרויות"},{value:p.TEXT,label:"טקסט"},{value:p.DATE,label:"תאריך"}],pe=()=>{const[y,E]=x.useState([]),[_,C]=x.useState(!0),[M,u]=x.useState(!1),[l,d]=x.useState(null),{addToast:o}=Q(),[G,v]=x.useState(!1),[b,T]=x.useState(null),[K,j]=x.useState(!1),N=x.useCallback(async()=>{C(!0);try{const s=await V();E(s.sort((r,t)=>new Date(t.createdAt).getTime()-new Date(r.createdAt).getTime()))}catch{o("שגיאה בטעינת תבניות","error")}finally{C(!1)}},[o]);x.useEffect(()=>{N()},[N]);const L=()=>{d({name:"",description:"",groups:[]}),u(!0)},q=s=>{d(JSON.parse(JSON.stringify(s))),u(!0)},z=async s=>{if(window.confirm("האם למחוק תבנית זו? לא ניתן לשחזר פעולה זו."))try{await Z(s),o("התבנית נמחקה","success"),N()}catch{o("שגיאה במחיקת התבנית","error")}},R=async()=>{if(!l||!l.name){o("שם התבנית הוא שדה חובה","warning");return}const s={id:l.id||f(),name:l.name,description:l.description||"",groups:l.groups||[],createdAt:l.createdAt||new Date().toISOString(),updatedAt:new Date().toISOString()};try{l.id?(await ee(s),o("התבנית עודכנה","success")):(await se(s),o("תבנית חדשה נוצרה","success")),u(!1),d(null),N()}catch{o("שגיאה בשמירת התבנית","error")}},U=()=>{if(!l)return;const s={id:f(),name:"קבוצה חדשה",items:[]};d(r=>({...r,groups:[...r.groups||[],s]}))},J=s=>{l&&d(r=>({...r,groups:r.groups?.filter(t=>t.id!==s)}))},X=(s,r,t)=>{l&&d(n=>({...n,groups:n.groups?.map(a=>a.id===s?{...a,[r]:t}:a)}))},k=(s,r)=>{if(!l||!l.groups)return;const t=[...l.groups],n=t.findIndex(i=>i.id===s);if(n===-1)return;const a=r==="up"?n-1:n+1;a<0||a>=t.length||([t[n],t[a]]=[t[a],t[n]],d(i=>({...i,groups:t})))},h=(s,r)=>{if(!l)return;const t={id:f(),label:"שאלה חדשה",description:"",type:r,required:!1,...r==="options"&&{options:["אפשרות 1","אפשרות 2"]}};d(n=>({...n,groups:n.groups?.map(a=>a.id===s?{...a,items:[...a.items,t]}:a)}))},Y=(s,r)=>{l&&d(t=>({...t,groups:t.groups?.map(n=>n.id===s?{...n,items:n.items.filter(a=>a.id!==r)}:n)}))},g=(s,r,t,n)=>{l&&d(a=>({...a,groups:a.groups?.map(i=>i.id!==s?i:{...i,items:i.items.map(c=>{if(c.id!==r)return c;const m={...c,[t]:n};return t==="type"&&n==="options"&&!m.options&&(m.options=["אפשרות 1","אפשרות 2"]),m})})}))},I=(s,r,t)=>{if(!l||!l.groups)return;const n=l.groups.map(a=>{if(a.id===s){const i=[...a.items],c=i.findIndex(H=>H.id===r);if(c===-1)return a;const m=t==="up"?c-1:c+1;return m<0||m>=i.length?a:([i[c],i[m]]=[i[m],i[c]],{...a,items:i})}return a});d(a=>({...a,groups:n}))},$=async()=>{if(!b){o("יש לבחור קובץ PDF","warning");return}j(!0);try{const s=new FileReader;s.readAsDataURL(b),s.onload=async r=>{try{const t=r.target?.result;if(!t)throw new Error("Could not read file.");o("מעבד PDF... שלב 1/2: קריאת טקסט","info");const n=await re(t);if(!n.trim())throw new Error("לא נמצא טקסט בקובץ ה-PDF.");o("מעבד PDF... שלב 2/2: בניית טופס עם AI","info");const a=await le(n),i=(a.groups||[]).map(c=>({...c,id:c.id||f(),items:(c.items||[]).map(m=>({...m,id:m.id||f(),required:m.required??!1,description:m.description||""}))}));d({name:a.name||b.name.replace(/\.pdf$/i,""),description:a.description||"",groups:i}),v(!1),u(!0),o("הטופס נוצר! בדוק וערוך לפני השמירה.","success")}catch(t){console.error(t),o(t instanceof Error?t.message:"שגיאה בהמרת ה-PDF","error")}finally{j(!1),T(null)}},s.onerror=()=>{o("שגיאה בקריאת הקובץ","error"),j(!1)}}catch{o("שגיאה לא צפויה","error"),j(!1)}};if(_)return e.jsx(O,{text:"טוען תבניות..."});const B=()=>e.jsx(F,{isOpen:M,onClose:()=>u(!1),title:l?.id?"עריכת תבנית":"יצירת תבנית חדשה",size:"xl",children:l&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label-class",children:"שם התבנית"}),e.jsx("input",{type:"text",value:l.name,onChange:s=>d({...l,name:s.target.value}),className:"input-class"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label-class",children:"תיאור (אופציונלי)"}),e.jsx("input",{type:"text",value:l.description,onChange:s=>d({...l,description:s.target.value}),className:"input-class"})]}),e.jsxs("div",{className:"pt-4 border-t",children:[e.jsxs("div",{className:"flex justify-between items-center mb-3",children:[e.jsx("h4",{className:"text-lg font-medium text-slate-800",children:"קבוצות פריטים"}),e.jsxs("button",{onClick:U,className:"btn-secondary flex items-center gap-1 text-sm",children:[e.jsx(P,{className:"w-4 h-4"}),"הוסף קבוצה"]})]}),e.jsxs("div",{className:"space-y-4 max-h-[50vh] overflow-y-auto p-2 bg-slate-50 rounded-lg border",children:[l.groups?.map((s,r)=>e.jsxs("div",{className:"p-3 bg-white border rounded-md shadow-sm space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("button",{type:"button",onClick:()=>k(s.id,"up"),disabled:r===0,className:"p-1 text-slate-400 hover:text-slate-600 disabled:opacity-30",children:e.jsx(S,{className:"w-4 h-4"})}),e.jsx("button",{type:"button",onClick:()=>k(s.id,"down"),disabled:r===(l.groups?.length||0)-1,className:"p-1 text-slate-400 hover:text-slate-600 disabled:opacity-30",children:e.jsx(D,{className:"w-4 h-4"})})]}),e.jsx("input",{type:"text",placeholder:"שם הקבוצה",value:s.name,onChange:t=>X(s.id,"name",t.target.value),className:"input-class font-semibold flex-grow"}),e.jsx("button",{onClick:()=>J(s.id),className:"p-2 text-red-500 hover:text-red-700 rounded-full hover:bg-red-50",children:e.jsx(w,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"pl-4 border-r-2 border-slate-200 space-y-2",children:[s.items.map((t,n)=>e.jsx("div",{className:"p-2 bg-slate-50 border rounded-md",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsxs("div",{className:"flex flex-col pt-1",children:[e.jsx("button",{type:"button",onClick:()=>I(s.id,t.id,"up"),disabled:n===0,className:"p-1 text-slate-400 hover:text-slate-600 disabled:opacity-30",children:e.jsx(S,{className:"w-4 h-4"})}),e.jsx("button",{type:"button",onClick:()=>I(s.id,t.id,"down"),disabled:n===s.items.length-1,className:"p-1 text-slate-400 hover:text-slate-600 disabled:opacity-30",children:e.jsx(D,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"flex-grow space-y-2",children:[e.jsxs("div",{className:"flex flex-wrap sm:flex-nowrap justify-between items-center gap-2",children:[e.jsx("input",{type:"text",value:t.label,onChange:a=>g(s.id,t.id,"label",a.target.value),className:"input-class flex-grow",placeholder:"תוכן השאלה"}),e.jsx("select",{value:t.type,onChange:a=>g(s.id,t.id,"type",a.target.value),className:"input-class text-sm py-1 bg-slate-100 border-slate-200",children:ne.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))}),e.jsx("button",{onClick:()=>Y(s.id,t.id),className:"p-1 text-red-400 hover:text-red-600 rounded-full",children:e.jsx(w,{className:"w-4 h-4"})})]}),e.jsx("textarea",{value:t.description||"",onChange:a=>g(s.id,t.id,"description",a.target.value),rows:2,className:"input-class text-sm w-full",placeholder:"הוסף תיאור/הסבר לפריט (אופציונלי)"}),t.type==="options"&&e.jsx("textarea",{value:t.options?.join(`
`),onChange:a=>g(s.id,t.id,"options",a.target.value.split(`
`)),rows:2,className:"input-class text-sm",placeholder:"כל אפשרות בשורה חדשה"})]})]})},t.id)),e.jsxs("div",{className:"flex flex-wrap gap-2 pt-2",children:[e.jsx("button",{onClick:()=>h(s.id,p.YES_NO),className:"btn-tertiary",children:"כן/לא"}),e.jsx("button",{onClick:()=>h(s.id,p.OK_NOT_OK),className:"btn-tertiary",children:"תקין/לא"}),e.jsx("button",{onClick:()=>h(s.id,p.OK_NOT_OK_NA),className:"btn-tertiary",children:"תקין/לא/לא רלוונטי"}),e.jsx("button",{onClick:()=>h(s.id,p.OPTIONS),className:"btn-tertiary",children:"אפשרויות"}),e.jsx("button",{onClick:()=>h(s.id,p.TEXT),className:"btn-tertiary",children:"טקסט"}),e.jsx("button",{onClick:()=>h(s.id,p.DATE),className:"btn-tertiary",children:"תאריך"})]})]})]},s.id)),l.groups?.length===0&&e.jsx("p",{className:"text-slate-500 text-center p-4",children:"הוסף קבוצה כדי להתחיל לבנות את הטופס."})]})]}),e.jsxs("div",{className:"flex justify-end space-x-3 rtl:space-x-reverse pt-4",children:[e.jsx("button",{onClick:()=>u(!1),className:"btn-secondary",children:"ביטול"}),e.jsx("button",{onClick:R,className:"btn-primary",children:"שמור תבנית"})]})]})});return e.jsxs("div",{className:"animate-fadeIn",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h2",{className:"text-2xl font-semibold text-slate-700",children:"תבניות טפסים"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:()=>v(!0),className:"btn-secondary flex items-center gap-2",children:[e.jsx(A,{className:"w-5 h-5 text-purple-600"})," המר PDF (AI)"]}),e.jsxs("button",{onClick:L,className:"btn-primary flex items-center",children:[e.jsx(P,{className:"w-5 h-5 me-2 rtl:ml-2"})," צור תבנית חדשה"]})]})]}),y.length===0?e.jsx("div",{className:"text-center py-10 bg-white rounded-lg shadow",children:e.jsx("p",{className:"text-slate-500",children:"לא נמצאו תבניות. צור תבנית חדשה כדי להתחיל."})}):e.jsx(ae,{title:e.jsx("h3",{className:"text-xl font-semibold",children:"רשימת תבניות"}),count:y.length,children:e.jsx("div",{className:"space-y-4",children:y.map(s=>e.jsxs("div",{className:"bg-white shadow-md rounded-lg p-4 flex justify-between items-center border",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-sky-700",children:s.name}),e.jsx("p",{className:"text-sm text-slate-600",children:s.description}),e.jsxs("p",{className:"text-xs text-slate-400 mt-1",children:["קבוצות: ",s.groups.length," | עודכן לאחרונה: ",te(s.updatedAt)]})]}),e.jsxs("div",{className:"flex items-center space-x-2 rtl:space-x-reverse",children:[e.jsx("button",{onClick:()=>q(s),className:"p-2 text-slate-500 hover:text-sky-600 rounded-full hover:bg-sky-50",children:e.jsx(W,{className:"w-5 h-5"})}),e.jsx("button",{onClick:()=>z(s.id),className:"p-2 text-slate-500 hover:text-red-600 rounded-full hover:bg-red-50",children:e.jsx(w,{className:"w-5 h-5"})})]})]},s.id))})}),B(),e.jsx(F,{isOpen:G,onClose:()=>v(!1),title:"המר PDF לטופס באמצעות AI",children:K?e.jsx(O,{text:"ממיר קובץ PDF..."}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-slate-600",children:"העלה קובץ PDF (בעברית) והמערכת תנסה להפוך אותו לתבנית טופס באופן אוטומטי."}),e.jsxs("div",{children:[e.jsx("label",{className:"label-class",children:"בחר קובץ PDF"}),e.jsx("input",{type:"file",accept:"application/pdf",onChange:s=>T(s.target.files?s.target.files[0]:null),className:"block w-full text-sm text-slate-500 file:mr-4 file:rtl:ml-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100"})]}),e.jsx("div",{className:"flex justify-end pt-4",children:e.jsxs("button",{onClick:$,disabled:!b,className:"btn-primary flex items-center gap-2",children:[e.jsx(A,{className:"w-5 h-5"})," המר קובץ"]})})]})}),e.jsx("style",{children:`
                .label-class { display: block; text-align: right; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 500; color: #334155; }
                .input-class { display: block; width: 100%; border: 1px solid #cbd5e1; border-radius: 0.375rem; padding: 0.5rem 0.75rem; transition: border-color 0.2s; }
                .input-class:focus { border-color: #0284c7; outline: none; box-shadow: 0 0 0 1px #0284c7; }
                .btn-primary { padding: 0.5rem 1rem; background-color: #0284c7; color: white; border-radius: 0.375rem; font-weight: 500; }
                .btn-primary:hover:not(:disabled) { background-color: #0369a1; }
                .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }
                .btn-secondary { padding: 0.5rem 1rem; background-color: #f1f5f9; color: #334155; border: 1px solid #cbd5e1; border-radius: 0.375rem; font-weight: 500; }
                .btn-secondary:hover { background-color: #e2e8f0; }
                .btn-tertiary { padding: 0.25rem 0.5rem; background-color: #e0f2fe; color: #0c4a6e; border-radius: 0.375rem; font-weight: 500; font-size: 0.75rem; }
                .btn-tertiary:hover { background-color: #bae6fd; }
                @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
                .animate-fadeIn { animation: fadeIn 0.5s ease-in-out; }
            `})]})};export{pe as default};
