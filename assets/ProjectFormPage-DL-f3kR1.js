import{r as i,u as A,j as e,p as B,M as L,T as W,k as _,B as H,aa as K,ab as V,a as q,ac as G}from"./index-D-cHbBwn.js";import{I as Q}from"./ImageUploader-QK9p397g.js";import{e as Z}from"./exportUtils-Bak1EFUX.js";import{f as ee}from"./dateFormatter-CUKId3Gl.js";import"./imageService-DERf2zoE.js";import"./AnnotationEditor-CCeRCJQ5.js";import"./shareUtils-BhFQGnPw.js";const P=({title:k,onSave:S,onClear:w,signatureUrl:v})=>{const d=i.useRef(null),[n,u]=i.useState(!1),[x,M]=i.useState(!1),[N,b]=i.useState(!1),{addToast:C}=A(),h=()=>d.current?.getContext("2d"),I=()=>{const a=d.current;if(!a)return;const o=h();if(!o)return;const m=a.parentElement;if(m){const g=m.clientWidth;a.width=g,a.height=g/2}o.strokeStyle="#333",o.lineWidth=2,o.lineCap="round",o.lineJoin="round",M(!1)};i.useEffect(()=>(N&&(setTimeout(I,50),window.addEventListener("resize",I)),()=>window.removeEventListener("resize",I)),[N]);const D=a=>{a.preventDefault();const o=h();if(!o)return;const m=f(a);o.beginPath(),o.moveTo(m.x,m.y),u(!0),M(!0)},j=a=>{if(!n)return;a.preventDefault();const o=h();if(!o)return;const m=f(a);o.lineTo(m.x,m.y),o.stroke()},T=a=>{if(!n)return;a.preventDefault();const o=h();o&&(o.closePath(),u(!1))},f=a=>{const o=d.current;if(!o)return{x:0,y:0};const m=o.getBoundingClientRect();let g,E;return"touches"in a?(g=a.touches[0].clientX,E=a.touches[0].clientY):(g=a.clientX,E=a.clientY),{x:g-m.left,y:E-m.top}},R=()=>{const a=d.current,o=h();a&&o&&(o.clearRect(0,0,a.width,a.height),M(!1))},O=()=>{const a=d.current;a&&x&&a.toDataURL().length>2e3?(S(a.toDataURL("image/png")),C("חתימה נשמרה","success"),b(!1)):C("אנא חתום לפני השמירה","warning")};return e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700",children:k}),e.jsx("div",{className:"border border-slate-300 rounded-md bg-white p-2 min-h-[100px] flex items-center justify-center",children:v?e.jsxs("div",{className:"text-center w-full",children:[e.jsx("img",{src:v,alt:"חתימה",className:"max-h-24 mx-auto object-contain cursor-pointer",onClick:()=>b(!0),title:"ערוך חתימה"}),e.jsx("button",{type:"button",onClick:w,className:"mt-2 text-sm text-red-600 hover:underline",children:"מחק חתימה"})]}):e.jsxs("button",{type:"button",onClick:()=>b(!0),className:"flex items-center gap-2 text-sky-600 hover:text-sky-700 font-medium py-4",children:[e.jsx(B,{className:"w-5 h-5"}),"הוסף חתימה"]})}),e.jsxs(L,{isOpen:N,onClose:()=>b(!1),title:"חתימה",children:[e.jsx("div",{className:"bg-slate-100 border-2 border-dashed border-slate-300 rounded-md touch-none",children:e.jsx("canvas",{ref:d,onMouseDown:D,onMouseMove:j,onMouseUp:T,onMouseLeave:T,onTouchStart:D,onTouchMove:j,onTouchEnd:T,className:"cursor-crosshair w-full"})}),e.jsxs("div",{className:"flex justify-between items-center mt-4",children:[e.jsxs("button",{type:"button",onClick:R,className:"flex items-center gap-2 text-sm font-medium text-slate-600 hover:text-red-600",children:[e.jsx(W,{className:"w-5 h-5"}),"נקה"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{type:"button",onClick:()=>b(!1),className:"px-4 py-2 text-sm font-medium text-slate-700 bg-slate-100 hover:bg-slate-200 rounded-md shadow-sm",children:"ביטול"}),e.jsx("button",{type:"button",onClick:O,className:"px-4 py-2 text-sm font-medium text-white bg-sky-600 hover:bg-sky-700 rounded-md shadow-sm",children:"שמור חתימה"})]})]})]})]})},ce=()=>{const{projectId:k,reportId:S,formId:w}=_(),v=H(),{addToast:d}=A(),[n,u]=i.useState(null),[x,M]=i.useState(null),[N,b]=i.useState(!0),[C,h]=i.useState(!1),[I,D]=i.useState(null),j=i.useRef(null),T=i.useRef(!1),f=i.useMemo(()=>`autosave-form-${w}`,[w]),R=i.useCallback(async()=>{if(w){b(!0);try{const t=await K(w);if(t){u(t);const r=await V(t.formTemplateId);if(r){M(r);const l=localStorage.getItem(f);if(l){const c=JSON.parse(l);new Date(c.updatedAt)>new Date(t.updatedAt)?(D(c),h(!0)):localStorage.removeItem(f)}}else throw new Error("Template not found")}else throw new Error("Form not found")}catch(t){console.error("Error fetching form data:",t),d("שגיאה בטעינת הטופס","error"),v(`/project/${k}/report/${S}`)}finally{b(!1),T.current=!0}}},[w,k,S,v,d,f]);i.useEffect(()=>{R()},[R]),i.useEffect(()=>{if(!(!T.current||C||!n||N))return j.current&&clearTimeout(j.current),j.current=window.setTimeout(()=>{const t={...n,updatedAt:new Date().toISOString()};localStorage.setItem(f,JSON.stringify(t))},1500),()=>{j.current&&clearTimeout(j.current)}},[n,f,C,N]);const O=(t,r)=>{if(!n)return;const l=n.answers.findIndex(p=>p.formItemId===t);let c=[...n.answers];l>-1?c[l]={...c[l],...r}:c.push({formItemId:t,value:null,description:"",photos:[],...r}),u({...n,answers:c})},a=(t,r)=>{O(t,{value:r})},o=(t,r)=>{O(t,{description:r})},m=(t,r)=>{if(!n)return;const l={dataUrl:r,signedAt:new Date().toISOString()};u(t==="reporter"?c=>({...c,reporterSignature:l}):c=>({...c,managerSignature:l}))},g=t=>{n&&u(t==="reporter"?r=>{const{reporterSignature:l,...c}=r;return c}:r=>{const{managerSignature:l,...c}=r;return c})},E=(t,r)=>{n&&u(t==="reporter"?l=>({...l,reporterComments:r}):l=>({...l,managerComments:r}))},U=async()=>{if(n)try{await G({...n,updatedAt:new Date().toISOString()}),localStorage.removeItem(f),d("הטופס נשמר בהצלחה","success"),v(`/project/${k}/report/${S}/forms`)}catch{d("שגיאה בשמירת הטופס","error")}},z=()=>{I&&(u(I),d("התקדמות שוחזרה","success")),h(!1),D(null)},$=()=>{localStorage.removeItem(f),d("טיוטה נמחקה","info"),h(!1),D(null)},J=t=>n?.answers.find(r=>r.formItemId===t),X=()=>{if(!n||!x)return;const t=[];x.groups.forEach(r=>{r.items.forEach(l=>{const c=n.answers.find(s=>s.formItemId===l.id),p=c?.value;let y="-";typeof p=="boolean"?y=p?"כן":"לא":p==="ok"?y="תקין":p==="not-ok"?y="לא תקין":p==="na"?y="לא רלוונטי":p&&(y=String(p)),t.push({קבוצה:r.name,שאלה:l.label,תשובה:y,הערות:c?.description||""})})}),n.reporterComments&&t.push({קבוצה:"סיכום",שאלה:"הערות מדווח",תשובה:n.reporterComments,הערות:""}),n.managerComments&&t.push({קבוצה:"סיכום",שאלה:"הערות מנהל",תשובה:n.managerComments,הערות:""}),Z(t,`form_${x.name}_${ee(n.formDate)}`),d("הטופס יוצא לקובץ Excel...","success")},Y=t=>{const r=J(t.id),l=r?.photos||[],c=s=>{O(t.id,{photos:s})},p=`מטופס: "${x?.name}"
שאלה: "${t.label}"`,y=s=>{if(!s||typeof s!="string")return"";try{return new Date(s).toISOString().split("T")[0]}catch{return""}};return e.jsxs("div",{className:"bg-white p-4 rounded-lg shadow-sm border border-slate-200 space-y-3",children:[e.jsx("label",{className:"block text-md font-semibold text-slate-800",children:t.label}),t.description&&e.jsx("p",{className:"text-sm text-amber-900 bg-amber-100 p-3 rounded-md border-r-4 border-amber-400 rtl:border-l-4 rtl:border-r-0 my-2",children:t.description}),t.type==="yes-no"&&e.jsx("div",{className:"flex gap-4",children:["כן","לא"].map(s=>e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:t.id,checked:r?.value===(s==="כן"),onChange:()=>a(t.id,s==="כן"),className:"w-4 h-4 text-sky-600 focus:ring-sky-500"}),s]},s))}),t.type==="ok-not-ok"&&e.jsx("div",{className:"flex gap-4",children:["תקין","לא תקין"].map(s=>e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:t.id,checked:r?.value===(s==="תקין"),onChange:()=>a(t.id,s==="תקין"),className:"w-4 h-4 text-sky-600 focus:ring-sky-500"}),s]},s))}),t.type==="ok-not-ok-na"&&e.jsx("div",{className:"flex flex-wrap gap-4",children:["תקין","לא תקין","לא רלוונטי"].map(s=>{let F;return s==="תקין"?F="ok":s==="לא תקין"?F="not-ok":F="na",e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:t.id,checked:r?.value===F,onChange:()=>a(t.id,F),className:"w-4 h-4 text-sky-600 focus:ring-sky-500"}),s]},s)})}),t.type==="options"&&e.jsxs("select",{value:String(r?.value||""),onChange:s=>a(t.id,s.target.value),className:"input-class",children:[e.jsx("option",{value:"",children:"בחר..."}),t.options?.map(s=>e.jsx("option",{value:s,children:s},s))]}),t.type==="text"&&e.jsx("textarea",{value:String(r?.value||""),onChange:s=>a(t.id,s.target.value),rows:3,className:"input-class"}),t.type==="date"&&e.jsx("input",{type:"date",value:y(r?.value),onChange:s=>a(t.id,s.target.value?new Date(s.target.value).toISOString():""),className:"input-class"}),e.jsxs("div",{className:"pt-3",children:[e.jsx("label",{htmlFor:`desc-${t.id}`,className:"block text-sm font-medium text-slate-600 mb-1",children:"הערות / תיאור לתשובה (יופיע ב-PDF)"}),e.jsx("textarea",{id:`desc-${t.id}`,value:r?.description||"",onChange:s=>o(t.id,s.target.value),rows:2,className:"input-class w-full text-sm",placeholder:"הוסף הערה או הסבר לבחירה שלך..."})]}),e.jsx("div",{className:"pt-3 border-t",children:e.jsx(Q,{images:l,onImagesChange:c,maxImages:10,allowSharing:!0,shareContextText:p})})]},t.id)};return N?e.jsx(q,{text:"טוען טופס..."}):!n||!x?e.jsx("div",{className:"text-center text-red-500",children:"לא ניתן לטעון את הטופס."}):e.jsxs("div",{className:"max-w-3xl mx-auto animate-fadeIn space-y-6",children:[e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-xl",children:[e.jsx("h2",{className:"text-2xl font-bold text-sky-700",children:x.name}),e.jsx("p",{className:"text-slate-600",children:x.description})]}),e.jsx("div",{className:"space-y-6",children:x.groups.map(t=>e.jsxs("section",{className:"bg-slate-50 p-4 rounded-lg shadow-md",children:[e.jsx("h3",{className:"text-xl font-semibold text-slate-800 border-b-2 border-sky-200 pb-2 mb-4",children:t.name}),e.jsx("div",{className:"space-y-4",children:t.items.map(Y)})]},t.id))}),e.jsxs("section",{className:"bg-slate-50 p-4 rounded-lg shadow-md mt-6",children:[e.jsx("h3",{className:"text-xl font-semibold text-slate-800 border-b-2 border-sky-200 pb-2 mb-4",children:"אישורים וחתימות"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsx("label",{htmlFor:"reporterComments",className:"block text-md font-semibold text-slate-800",children:"הערות מדווח"}),e.jsx("textarea",{id:"reporterComments",value:n?.reporterComments||"",onChange:t=>E("reporter",t.target.value),rows:3,className:"input-class w-full",placeholder:"הוסף הערות סיכום..."}),e.jsx(P,{title:"חתימת מדווח",onSave:t=>m("reporter",t),onClear:()=>g("reporter"),signatureUrl:n?.reporterSignature?.dataUrl})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("label",{htmlFor:"managerComments",className:"block text-md font-semibold text-slate-800",children:"הערות מנהל בניין"}),e.jsx("textarea",{id:"managerComments",value:n?.managerComments||"",onChange:t=>E("manager",t.target.value),rows:3,className:"input-class w-full",placeholder:"הוסף הערות סיכום..."}),e.jsx(P,{title:"חתימת מנהל בניין",onSave:t=>m("manager",t),onClear:()=>g("manager"),signatureUrl:n?.managerSignature?.dataUrl})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-4 mt-6",children:[e.jsx("button",{type:"button",onClick:()=>v(`/project/${k}/report/${S}/forms`),className:"btn-secondary",children:"ביטול"}),e.jsx("button",{type:"button",onClick:X,className:"btn-secondary",children:"יצא לאקסל"}),e.jsx("button",{type:"button",onClick:U,className:"btn-primary",children:"שמור טופס"})]}),e.jsx(L,{isOpen:C,onClose:$,title:"שחזור התקדמות",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-slate-600",children:"נמצאו שינויים שלא נשמרו עבור טופס זה. האם תרצה לשחזר אותם?"}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx("button",{onClick:$,className:"btn-secondary",children:"מחק טיוטה"}),e.jsx("button",{onClick:z,className:"btn-primary",children:"שחזר התקדמות"})]})]})}),e.jsx("style",{children:`
                .input-class { display: block; width: 100%; border: 1px solid #cbd5e1; border-radius: 0.375rem; padding: 0.5rem 0.75rem; transition: border-color 0.2s; }
                .input-class:focus { border-color: #0284c7; outline: none; box-shadow: 0 0 0 1px #0284c7; }
                .btn-primary { padding: 0.6rem 1.5rem; background-color: #0284c7; color: white; border-radius: 0.375rem; font-weight: 600; }
                .btn-primary:hover { background-color: #0369a1; }
                .btn-secondary { padding: 0.6rem 1.5rem; background-color: #f1f5f9; color: #334155; border: 1px solid #cbd5e1; border-radius: 0.375rem; font-weight: 600; }
                .btn-secondary:hover { background-color: #e2e8f0; }
                @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
                .animate-fadeIn { animation: fadeIn 0.5s ease-in-out; }
            `})]})};export{ce as default};
