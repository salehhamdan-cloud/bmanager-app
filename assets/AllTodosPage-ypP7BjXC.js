import{r as u,u as Z,h as ee,am as te,g as oe,j as o,a as se,A as F,P as re,z as O,l as L,an as ae,e as ne}from"./index-BU7E-q7q.js";import{f as E,c as ce,b as de}from"./dateFormatter-CUKId3Gl.js";import{C as S}from"./CollapsibleSection-BbrEhqCk.js";import{E as le}from"./EditTodoModal-CWzl5Ai4.js";import{A as ie}from"./AddTodoModal-fZggYYCI.js";import{c as ue}from"./emailService-Ce1ZuM1T.js";import{d as pe}from"./pdfService-Th-ePIZW.js";import{e as me}from"./exportUtils-Bak1EFUX.js";import{T as ge}from"./TodoItem-BtyccVcW.js";import"./RecurrenceEditor-Bj-SDiXW.js";const h=({label:c,value:p,currentValue:j,onClick:b})=>o.jsx("button",{onClick:()=>b(p),className:`px-3 py-1.5 text-sm font-medium rounded-md transition-colors ${j===p?"bg-sky-600 text-white shadow":"bg-slate-100 text-slate-700 hover:bg-slate-200"}`,children:c}),xe=(c,p)=>{if(c.isCompleted)return{text:"הושלם",color:"text-blue-800",bg:"bg-blue-100",isDueSoon:!1};if(!c.dueDate)return{text:"אין תאריך יעד",color:"text-slate-500",bg:"bg-slate-100",isDueSoon:!1};const j=new Date(c.dueDate),b=new Date;b.setHours(0,0,0,0);const N=j.getTime()-b.getTime(),m=Math.ceil(N/(1e3*60*60*24));if(m<0)return{text:"פג תוקף",color:"text-red-800",bg:"bg-red-100",isDueSoon:!1};if(m<=p){const g=m===1?"יום":"ימים";return{text:`יעד: ${m>0?`בעוד ${m} ${g}`:"היום"}`,color:"text-amber-800",bg:"bg-amber-100",isDueSoon:!0}}return{text:"בתוקף",color:"text-green-800",bg:"bg-green-100",isDueSoon:!1}},Ne=()=>{const[c,p]=u.useState([]),[j,b]=u.useState([]),[N,m]=u.useState(!0),[g,T]=u.useState("dueDate-asc"),[x,k]=u.useState(""),{addToast:d}=Z(),{settings:v}=ee(),[U,I]=u.useState(!1),[y,A]=u.useState(null),D=u.useCallback(async()=>{m(!0);try{const[t,e]=await Promise.all([te(),oe()]);p(t),b(e)}catch(t){console.error("Error fetching data:",t),d("שגיאה בטעינת המשימות","error")}finally{m(!1)}},[d]);u.useEffect(()=>{D()},[D]);const K=async(t,e)=>{const r=c.find(n=>n.id===e);if(r&&window.confirm(`האם אתה בטוח שברצונך למחוק את המשימה "${r.description}"?`))try{await ae(t,e),d("המשימה נמחקה בהצלחה","success"),D()}catch(n){console.error("Error deleting todo:",n),d("שגיאה במחיקת המשימה","error")}},B=async t=>{const e=c.find(s=>s.id===t);if(!e)return;const r=await L(e.projectId);if(!r||!r.todos)return;JSON.parse(JSON.stringify(r));let n,a=[...c];if(e.isCompleted){const s={...e,isCompleted:!1};n=r.todos.map(l=>l.id===t?s:l),a=c.map(l=>l.id===t?s:l)}else{const s={...e,isCompleted:!0};if(n=r.todos.map(l=>l.id===t?s:l),a=c.map(l=>l.id===t?s:l),ue(s,r,v),s.recurrenceType==="recurring"&&s.recurrence&&s.duration){const l=s.startDate?new Date(s.startDate):new Date(s.createdAt),w=ce(l,s.recurrence),P=de(w,s.duration),C={id:ne(),description:s.description,createdAt:new Date().toISOString(),startDate:w.toISOString(),dueDate:P.toISOString(),recurrenceType:"recurring",recurrence:s.recurrence,duration:s.duration,isCompleted:!1,group:s.group};n.push(C),a.push({...C,projectId:r.id,projectName:r.name}),d(`נוצרה משימה חוזרת לתאריך ${E(w)}`,"info")}}const i={...r,todos:n,updatedAt:new Date().toISOString()};p(a);try{await O(i),d(e.isCompleted?"המשימה הוחזרה לביצוע":"המשימה הושלמה","success")}catch{d("שגיאה בעדכון המשימה","error"),p(c),D()}},R=async t=>{const e=j.find(n=>n.id===t.projectId);if(!e){d("Project not found to add todo","error");return}const r={...e,todos:[...e.todos||[],t],updatedAt:new Date().toISOString()};try{await O(r),d("משימה חדשה נוספה","success"),D()}catch{d("שגיאה בהוספת המשימה","error")}},G=async t=>{if(y)try{const e=await L(y.projectId);if(!e)throw new Error("Project not found");e.todos=e.todos?.map(r=>r.id===t.id?t:r),e.updatedAt=new Date().toISOString(),await O(e),d("המשימה עודכנה בהצלחה","success"),D()}catch{d("שגיאה בעדכון המשימה","error")}finally{A(null)}},J=t=>{A(t)},q=u.useMemo(()=>{const t=new Set(c.map(e=>e.group).filter(Boolean));return Array.from(t).sort((e,r)=>e.localeCompare(r,"he"))},[c]),f=u.useMemo(()=>{const e=[...c.filter(a=>x?x==="__none__"?!a.group:a.group===x:!0)],[r,n]=g.split("-");return e.sort((a,i)=>{let s=0;switch(r){case"dueDate":{const P=a.dueDate?new Date(a.dueDate).getTime():1/0,C=i.dueDate?new Date(i.dueDate).getTime():1/0;s=P-C;break}case"projectName":s=a.projectName.localeCompare(i.projectName,"he");break;case"group":const l=a.group?.toLowerCase()||"￿",w=i.group?.toLowerCase()||"￿";s=l.localeCompare(w,"he");break;case"createdAt":default:s=new Date(a.createdAt).getTime()-new Date(i.createdAt).getTime();break}return s===0?new Date(i.createdAt).getTime()-new Date(a.createdAt).getTime():n==="desc"?s*-1:s}),e},[c,g,x]),_=t=>t.reduce((e,r)=>{const n=r.projectName;return e[n]||(e[n]={projectId:r.projectId,todos:[]}),e[n].todos.push(r),e},{}),{pendingTodos:M,completedTodos:V,groupedPending:z,groupedCompleted:H,sortedPendingKeys:Q,sortedCompletedKeys:W}=u.useMemo(()=>{const t=f.filter(a=>!a.isCompleted),e=f.filter(a=>a.isCompleted),r=_(t),n=_(e);return{pendingTodos:t,completedTodos:e,groupedPending:r,groupedCompleted:n,sortedPendingKeys:Object.keys(r).sort((a,i)=>a.localeCompare(i,"he")),sortedCompletedKeys:Object.keys(n).sort((a,i)=>a.localeCompare(i,"he"))}},[f]),X=()=>{if(f.length===0){d("אין משימות לייצוא","warning");return}d("מכין PDF...","info"),pe({settings:v,todos:f})},Y=()=>{if(f.length===0){d("אין משימות לייצוא","warning");return}const t=f.map(e=>({בניין:e.projectName,תיאור:e.description,"תאריך התחלה":e.startDate?E(e.startDate):"-","תאריך יעד":e.dueDate?E(e.dueDate):"-",סטטוס:xe(e,v.notificationDays).text,קבוצה:e.group||"-"}));me(t,"all_todos_list"),d("קובץ Excel יוצא...","success")};if(N)return o.jsx(se,{text:"טוען משימות..."});const $=t=>o.jsx(ge,{todo:t,onToggle:B,onDelete:()=>K(t.projectId,t.id),onEdit:()=>J(t)},t.id);return o.jsxs("div",{className:"animate-fadeIn",children:[o.jsxs("div",{className:"flex justify-between items-center mb-6 flex-wrap gap-4",children:[o.jsx("h2",{className:"text-2xl font-bold text-slate-800",children:"כל המשימות"}),o.jsxs("div",{className:"flex items-center gap-2",children:[o.jsxs("button",{onClick:X,className:"btn-secondary flex items-center gap-2",children:[o.jsx(F,{className:"w-5 h-5"}),"יצא PDF"]}),o.jsxs("button",{onClick:Y,className:"btn-secondary flex items-center gap-2",children:[o.jsx(F,{className:"w-5 h-5"}),"יצא Excel"]}),o.jsxs("button",{onClick:()=>I(!0),className:"bg-sky-600 hover:bg-sky-700 text-white font-medium py-2 px-4 rounded-lg shadow-md flex items-center transition-colors",children:[o.jsx(re,{className:"w-5 h-5 me-2 rtl:ml-2"}),"הוסף משימה"]})]})]}),o.jsxs("div",{className:"bg-white p-4 rounded-lg shadow-md border mb-6 space-y-4",children:[o.jsxs("div",{children:[o.jsx("label",{className:"block text-sm font-medium text-slate-600 mb-2",children:"סנן לפי קבוצה:"}),o.jsxs("div",{className:"flex flex-wrap gap-2",children:[o.jsx(h,{label:"הכל",value:"",currentValue:x,onClick:k}),o.jsx(h,{label:"ללא קבוצה",value:"__none__",currentValue:x,onClick:k}),q.map(t=>o.jsx(h,{label:t,value:t,currentValue:x,onClick:k},t))]})]}),o.jsxs("div",{children:[o.jsx("label",{className:"block text-sm font-medium text-slate-600 mb-2",children:"מיין לפי:"}),o.jsxs("div",{className:"flex flex-wrap gap-2",children:[o.jsx(h,{label:"תאריך יעד (הקרוב ביותר)",value:"dueDate-asc",currentValue:g,onClick:T}),o.jsx(h,{label:"נוצר לאחרונה",value:"createdAt-desc",currentValue:g,onClick:T}),o.jsx(h,{label:"בניין (א-ת)",value:"projectName-asc",currentValue:g,onClick:T}),o.jsx(h,{label:"קבוצה (א-ת)",value:"group-asc",currentValue:g,onClick:T})]})]})]}),c.length===0?o.jsxs("div",{className:"text-center py-16 bg-white rounded-lg shadow-md border",children:[o.jsx("h3",{className:"text-2xl font-semibold text-slate-700",children:"אין משימות להצגה"}),o.jsx("p",{className:"text-slate-500 mt-2",children:x?"אין משימות התואמות לסינון שנבחר.":"עדיין לא נוספו משימות לאף בניין."})]}):o.jsxs("div",{className:"space-y-8",children:[M.length>0&&o.jsx(S,{title:o.jsx("h3",{className:"text-xl font-semibold",children:"משימות לביצוע"}),count:M.length,children:o.jsx("div",{className:"space-y-4",children:Q.map(t=>{const e=z[t];return o.jsx(S,{title:o.jsx("h4",{className:"text-md font-semibold",children:t}),count:e.todos.length,defaultOpen:!0,children:o.jsx("div",{className:"space-y-3",children:e.todos.map($)})},t)})})}),V.length>0&&o.jsx(S,{title:o.jsx("h3",{className:"text-xl font-semibold",children:"משימות שהושלמו"}),count:V.length,defaultOpen:!1,children:o.jsx("div",{className:"space-y-4",children:W.map(t=>{const e=H[t];return o.jsx(S,{title:o.jsx("h4",{className:"text-md font-semibold",children:t}),count:e.todos.length,defaultOpen:!0,children:o.jsx("div",{className:"space-y-3",children:e.todos.map($)})},t)})})})]}),o.jsx(ie,{isOpen:U,onClose:()=>I(!1),projects:j,onSave:R}),o.jsx(le,{isOpen:!!y,onClose:()=>A(null),todo:y,onSave:G}),o.jsx("style",{children:".btn-secondary { padding: 0.5rem 1rem; background-color: #f1f5f9; color: #334155; border: 1px solid #cbd5e1; border-radius: 0.375rem; font-weight: 500; } .btn-secondary:hover { background-color: #e2e8f0; }"})]})};export{Ne as default};
