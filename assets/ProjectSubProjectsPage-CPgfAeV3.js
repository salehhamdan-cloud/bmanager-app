import{k as R,B as W,u as _,r as m,l as q,j as e,a as G,L as S,P as C,p as H,T as D,M as J,z as P,e as I}from"./index-BU7E-q7q.js";import{I as E}from"./ImageUploader-DcmZM9_9.js";import{f as O}from"./dateFormatter-CUKId3Gl.js";import"./imageService-tma56vZK.js";import"./AnnotationEditor-Brb4Zcq3.js";import"./shareUtils-BhFQGnPw.js";const K=n=>{switch(n){case"פעיל":return{bg:"bg-green-100",text:"text-green-800"};case"הושלם":return{bg:"bg-blue-100",text:"text-blue-800"};case"בהמתנה":return{bg:"bg-amber-100",text:"text-amber-800"};case"בוטל":return{bg:"bg-slate-100",text:"text-slate-600"};default:return{bg:"bg-gray-100",text:"text-gray-800"}}},Q=n=>n?n.split(" ").map(u=>u[0]).slice(0,2).join("").toUpperCase():"",N=({label:n,value:u,currentSort:i,setSort:o})=>e.jsx("button",{onClick:()=>o(u),className:`px-3 py-1.5 text-sm font-medium rounded-md transition-colors ${i===u?"bg-white shadow text-sky-600":"text-slate-600 hover:bg-white/60"}`,children:n}),se=()=>{const{projectId:n}=R(),u=W(),{addToast:i}=_(),[o,T]=m.useState(null),[L,k]=m.useState(!0),[M,g]=m.useState(!1),[a,d]=m.useState(null),[x,b]=m.useState("name-asc"),j=m.useCallback(async()=>{if(n){k(!0);try{const t=await q(n);t?T(t):(i("Bניין לא נמצא","error"),u("/"))}catch{i("שגיאה בטעינת פרויקטים","error")}finally{k(!1)}}},[n,i,u]);m.useEffect(()=>{j()},[j]);const f=o?.subProjects||[],$=m.useMemo(()=>[...f].sort((t,s)=>{const[r,l]=x.split("-");let c,p;switch(r){case"status":c=t.status,p=s.status;break;case"startDate":c=t.workStartDate?new Date(t.workStartDate).getTime():0,p=s.workStartDate?new Date(s.workStartDate).getTime():0;break;case"name":default:c=t.name.toLowerCase(),p=s.name.toLowerCase();break}return c<p?l==="asc"?-1:1:c>p?l==="asc"?1:-1:0}),[f,x]),y=(t=null)=>{d(t?{...t}:{name:"",description:"",status:"פעיל",photos:[],files:[],rejects:[],contractors:[],checker:{name:"",phone:"",email:""},workStartDate:void 0,workEndDate:void 0,budget:void 0,coverPhoto:void 0}),g(!0)},A=async()=>{if(!a||!a.name?.trim()||!o){i("שם הפרויקט הוא שדה חובה","warning");return}const t={...a,workStartDate:a.workStartDate?new Date(a.workStartDate).toISOString():void 0,workEndDate:a.workEndDate?new Date(a.workEndDate).toISOString():void 0};let s;if(a.id)s=(o.subProjects||[]).map(l=>l.id===a.id?t:l);else{const l={id:I(),...t,name:a.name.trim(),budget:a.budget||0};s=[...o.subProjects||[],l]}const r={...o,subProjects:s,updatedAt:new Date().toISOString()};try{await P(r),i("הפרויקט נשמר","success"),g(!1),d(null),j()}catch{i("שגיאה בשמירת הפרויקט","error")}},F=async t=>{if(!o||!window.confirm("האם למחוק פרויקט זה וכל תכולתו?"))return;const s={...o,subProjects:(o.subProjects||[]).filter(r=>r.id!==t),updatedAt:new Date().toISOString()};try{await P(s),i("הפרויקט נמחק","success"),j()}catch{i("שגיאה במחיקת הפרויקט","error")}},h=t=>{const{name:s,value:r,type:l}=t.target;d(l==="number"?c=>({...c,[s]:r===""?void 0:parseFloat(r)}):c=>({...c,[s]:r}))},v=(t,s,r)=>{if(!a)return;const l=[...a.contractors||[]];l[t]={...l[t],[s]:r},d(c=>({...c,contractors:l}))},B=()=>{const t={id:I(),name:"",phone:"",email:""};d(s=>({...s,contractors:[...s?.contractors||[],t]}))},U=t=>{d(s=>({...s,contractors:s?.contractors?.filter((r,l)=>l!==t)}))},w=(t,s)=>{d(r=>({...r,checker:{...r?.checker||{},[t]:s}}))},z=t=>{const s=a?.photoFolder||"",r=t.map(l=>({...l,folder:s}));d(l=>({...l,photos:r}))};return L?e.jsx(G,{text:"טוען פרויקטים..."}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("nav",{className:"text-sm mb-1",children:e.jsx(S,{to:`/project/${n}`,className:"text-sky-600 hover:underline",children:"חזרה לבניין"})}),e.jsxs("h1",{className:"text-2xl font-bold text-slate-800",children:["פרויקטים: ",o?.name]})]}),e.jsxs("button",{onClick:()=>y(),className:"btn-primary flex items-center gap-2",children:[e.jsx(C,{className:"w-5 h-5"}),"הוסף פרויקט"]})]}),e.jsxs("div",{className:"bg-slate-100 p-2 rounded-lg flex items-center justify-center gap-1 flex-wrap mb-6",children:[e.jsx(N,{label:"שם (א-ת)",value:"name-asc",currentSort:x,setSort:b}),e.jsx(N,{label:"תאריך התחלה",value:"startDate-asc",currentSort:x,setSort:b}),e.jsx(N,{label:"סטטוס",value:"status-asc",currentSort:x,setSort:b})]}),f.length===0?e.jsx("div",{className:"text-center p-10 bg-white rounded-lg shadow border",children:e.jsx("p",{className:"text-slate-500",children:"לא נמצאו פרויקטים בבניין זה."})}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:$.map(t=>{const s=K(t.status),r=t.coverPhoto?.url||t.coverPhoto?.dataUrl;return e.jsxs("div",{className:"bg-white rounded-xl shadow-md border border-slate-200/80 overflow-hidden flex flex-col transition-all duration-300 hover:shadow-lg hover:border-sky-200",children:[e.jsx(S,{to:`/project/${n}/sub-project/${t.id}`,className:"block",children:e.jsxs("div",{className:"h-40 bg-slate-200 flex items-center justify-center relative group",children:[r?e.jsx("img",{src:r,alt:t.name,className:"w-full h-full object-cover"}):e.jsx("span",{className:"text-4xl font-bold text-slate-400",children:Q(t.name)}),e.jsx("div",{className:"absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center",children:e.jsx("span",{className:"text-white font-semibold",children:"צפה בפרטים"})})]})}),e.jsxs("div",{className:"p-4 flex-grow flex flex-col",children:[e.jsxs("div",{className:"flex-grow",children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsx("h2",{className:"text-lg font-semibold text-sky-700 truncate",children:t.name}),e.jsx("span",{className:`text-xs font-semibold px-2 py-0.5 rounded-full self-start whitespace-nowrap ${s.bg} ${s.text}`,children:t.status})]}),e.jsx("p",{className:"text-sm text-slate-500 line-clamp-2 h-10",children:t.description}),(t.workStartDate||t.workEndDate)&&e.jsxs("div",{className:"text-xs text-slate-500 mt-2 border-t pt-2",children:[e.jsx("span",{children:"תאריכי עבודה: "}),e.jsx("span",{className:"font-medium",children:t.workStartDate?O(t.workStartDate):"N/A"}),e.jsx("span",{children:" - "}),e.jsx("span",{className:"font-medium",children:t.workEndDate?O(t.workEndDate):"N/A"})]})]}),e.jsx("div",{className:"flex justify-end items-center mt-auto pt-3 border-t",children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:()=>y(t),className:"p-1.5 text-slate-500 hover:bg-slate-100 rounded-full",title:"ערוך",children:e.jsx(H,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>F(t.id),className:"p-1.5 text-red-500 hover:bg-red-100 rounded-full",title:"מחק",children:e.jsx(D,{className:"w-4 h-4"})})]})})]})]},t.id)})}),e.jsx(J,{isOpen:M,onClose:()=>g(!1),title:a?.id?"עריכת פרויקט":"הוספת פרויקט חדש",size:"lg",children:a&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("input",{type:"text",placeholder:"שם הפרויקט",name:"name",value:a.name||"",onChange:h,className:"input-class w-full"}),e.jsx("textarea",{placeholder:"תיאור הפרויקט",name:"description",value:a.description||"",onChange:h,className:"input-class w-full",rows:3}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4 pt-4 border-t",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label-class",children:"סטטוס"}),e.jsxs("select",{name:"status",value:a.status||"פעיל",onChange:h,className:"input-class w-full",children:[e.jsx("option",{value:"פעיל",children:"פעיל"}),e.jsx("option",{value:"בהמתנה",children:"בהמתנה"}),e.jsx("option",{value:"הושלם",children:"הושלם"}),e.jsx("option",{value:"בוטל",children:"בוטל"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label-class",children:"תקציב (₪)"}),e.jsx("input",{type:"number",name:"budget",placeholder:"0",value:a.budget||"",onChange:h,className:"input-class"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label-class",children:"תאריך התחלה"}),e.jsx("input",{type:"date",name:"workStartDate",value:a.workStartDate?.split("T")[0]||"",onChange:h,className:"input-class"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label-class",children:"תאריך סיום"}),e.jsx("input",{type:"date",name:"workEndDate",value:a.workEndDate?.split("T")[0]||"",onChange:h,className:"input-class"})]})]}),e.jsxs("div",{className:"pt-4 border-t",children:[e.jsx("h3",{className:"text-md font-medium text-slate-800 mb-2",children:"תמונת נושא"}),e.jsx(E,{images:a.coverPhoto?[a.coverPhoto]:[],onImagesChange:t=>d(s=>({...s,coverPhoto:t[0]||void 0})),maxImages:1,allowNotes:!1})]}),e.jsxs("div",{className:"pt-4 border-t",children:[e.jsx("h3",{className:"text-md font-medium text-slate-800 mb-2",children:"תמונות גלריה"}),e.jsx("input",{type:"text",placeholder:"שם תיקיית תמונות (אופציונלי)",name:"photoFolder",value:a.photoFolder||"",onChange:h,className:"input-class w-full mb-2"}),e.jsx(E,{images:a.photos||[],onImagesChange:z,maxImages:20})]}),e.jsxs("div",{className:"pt-4 border-t",children:[e.jsx("h3",{className:"text-md font-medium text-slate-800 mb-2",children:"קבלנים"}),a.contractors?.map((t,s)=>e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-4 gap-2 items-center mb-2 p-2 bg-slate-50 rounded",children:[e.jsx("input",{type:"text",placeholder:"שם",value:t.name,onChange:r=>v(s,"name",r.target.value),className:"input-class"}),e.jsx("input",{type:"text",placeholder:"טלפון",value:t.phone,onChange:r=>v(s,"phone",r.target.value),className:"input-class"}),e.jsx("input",{type:"email",placeholder:"מייל",value:t.email,onChange:r=>v(s,"email",r.target.value),className:"input-class"}),e.jsx("button",{onClick:()=>U(s),className:"p-2 text-red-500 hover:bg-red-100 rounded-full justify-self-end",children:e.jsx(D,{className:"w-5 h-5"})})]},t.id)),e.jsxs("button",{onClick:B,className:"btn-secondary text-sm flex items-center gap-1",children:[e.jsx(C,{className:"w-4 h-4"}),"הוסף קבלן"]})]}),e.jsxs("div",{className:"pt-4 border-t",children:[e.jsx("h3",{className:"text-md font-medium text-slate-800 mb-2",children:"מפקח"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-2",children:[e.jsx("input",{type:"text",placeholder:"שם",value:a.checker?.name||"",onChange:t=>w("name",t.target.value),className:"input-class"}),e.jsx("input",{type:"text",placeholder:"טלפון",value:a.checker?.phone||"",onChange:t=>w("phone",t.target.value),className:"input-class"}),e.jsx("input",{type:"email",placeholder:"מייל",value:a.checker?.email||"",onChange:t=>w("email",t.target.value),className:"input-class"})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4",children:[e.jsx("button",{onClick:()=>g(!1),className:"btn-secondary",children:"ביטול"}),e.jsx("button",{onClick:A,className:"btn-primary",children:"שמור"})]})]})}),e.jsx("style",{children:`
                .label-class { display: block; text-align: right; margin-bottom: 0.25rem; font-size: 0.8rem; font-weight: 500; color: #475569; }
                .input-class { display: block; width: 100%; border: 1px solid #cbd5e1; border-radius: 0.375rem; padding: 0.5rem 0.75rem; }
                .btn-primary { padding: 0.5rem 1rem; background-color: #0284c7; color: white; border-radius: 0.375rem; font-weight: 500; }
                .btn-secondary { padding: 0.5rem 1rem; background-color: #f1f5f9; color: #334155; border: 1px solid #cbd5e1; border-radius: 0.375rem; font-weight: 500; }
            `})]})};export{se as default};
