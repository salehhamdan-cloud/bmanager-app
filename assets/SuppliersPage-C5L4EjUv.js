import{r as l,u as Y,h as Z,n as ee,j as e,a as P,p as E,P as se,A as T,af as te,T as A,M as ae,e as D,aw as M,ax as re,ay as ne,az as le}from"./index-D-cHbBwn.js";import{C as oe}from"./CollapsibleSection-F92uqtdU.js";import{S as ce,e as ie}from"./aiService-BGt51fXt.js";import{c as de}from"./pdfUtils-CkvU2BMR.js";import{e as pe}from"./exportUtils-Bak1EFUX.js";import{k as me}from"./pdfService-D-0A9fw7.js";import{P as ue,E as xe,M as he}from"./ContactIcons-B1NAvYGF.js";import"./dateFormatter-CUKId3Gl.js";const ve=()=>{const[m,O]=l.useState([]),[L,N]=l.useState(!0),{addToast:n}=Y(),{settings:$}=Z(),[F,g]=l.useState(!1),[o,u]=l.useState(null),[G,S]=l.useState(!1),v=l.useRef(null),[f,R]=l.useState(""),[i,z]=l.useState(!1),[x,y]=l.useState({}),d=Object.keys(x).length,h=l.useCallback(async()=>{N(!0);try{const s=await ee();O(s)}catch{n("שגיאה בטעינת ספקים","error")}finally{N(!1)}},[n]);l.useEffect(()=>{h()},[h]),l.useEffect(()=>{i||y({})},[i]);const k=(s=null)=>{u(s?{...s}:{group:"",name:"",phone:"",email:"",companyId:"",address:""}),g(!0)},U=async()=>{if(!o||!o.name?.trim()||!o.group?.trim()){n("שם, וקבוצה הם שדות חובה","warning");return}try{if(o.id){const s={...o,updatedAt:new Date().toISOString()};await le(s),n("הספק עודכן","success")}else{const s={id:D(),...o,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};await M(s),n("ספק חדש נוסף","success")}g(!1),u(null),h()}catch{n("שגיאה בשמירת הספק","error")}},_=async s=>{if(window.confirm("האם למחוק ספק זה?"))try{await re(s),n("הספק נמחק","success"),h()}catch{n("שגיאה במחיקת הספק","error")}},K=()=>{v.current?.click()},V=async s=>{const t=s.target.files?.[0];if(t){S(!0),n("מעבד קובץ ספקים...","info");try{let a="";if(t.type==="application/pdf"){const c=await new Promise((W,X)=>{const w=new FileReader;w.onload=b=>W(b.target?.result),w.onerror=b=>X(b),w.readAsDataURL(t)});a=await de(c)}else if(t.type==="text/csv")a=await t.text();else throw new Error("סוג קובץ לא נתמך. יש להעלות PDF או CSV.");const p=(await ie(a)).map(c=>({id:D(),group:c.group||"כללי",name:c.name||"N/A",phone:c.phone||"",email:c.email||"",address:c.address||"",companyId:c.companyId||"",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}));await Promise.all(p.map(c=>M(c))),n(`${p.length} ספקים נוספו בהצלחה!`,"success"),h()}catch(a){n(a instanceof Error?a.message:"שגיאה ביבוא הספקים","error")}finally{S(!1),s.target&&(s.target.value="")}}},q=()=>{const s=d>0?m.filter(a=>x[a.id]):m;if(s.length===0){n("לא נבחרו ספקים לייצוא","warning");return}const t=s.map(a=>({תחום:a.group,שם:a.name,טלפון:a.phone,מייל:a.email,כתובת:a.address||"","ח.פ":a.companyId}));pe(t,d>0?"selected_suppliers":"suppliers_list")},B=()=>{const s=d>0?m.filter(t=>x[t.id]):m;if(s.length===0){n("לא נבחרו ספקים לייצוא","warning");return}me({settings:$,suppliers:s})},C=l.useMemo(()=>{if(!f)return m;const s=f.toLowerCase();return m.filter(t=>t.name.toLowerCase().includes(s)||t.group.toLowerCase().includes(s)||t.phone.toLowerCase().includes(s)||t.email.toLowerCase().includes(s)||t.companyId.toLowerCase().includes(s))},[m,f]),j=l.useMemo(()=>C.reduce((s,t)=>{const a=t.group||"ללא קבוצה";return s[a]||(s[a]=[]),s[a].push(t),s},{}),[C]),H=l.useMemo(()=>Object.keys(j).sort((s,t)=>s.localeCompare(t,"he")),[j]),J=(s,t)=>{const a=j[s].map(r=>r.id);y(r=>{const p={...r};return t?a.forEach(c=>p[c]=!0):a.forEach(c=>delete p[c]),p})},I=s=>{y(t=>{const a={...t};return a[s]?delete a[s]:a[s]=!0,a})},Q=async()=>{if(d!==0&&window.confirm(`האם למחוק ${d} ספקים נבחרים?`)){const s=Object.keys(x);try{await ne(s),n(`${d} ספקים נמחקו`,"success"),y({}),h()}catch{n("שגיאה במחיקת ספקים","error")}}};return L?e.jsx(P,{text:"טוען ספקים..."}):e.jsxs("div",{className:"space-y-6",children:[G&&e.jsx("div",{className:"fixed inset-0 bg-slate-900 bg-opacity-60 backdrop-blur-sm z-[1001] flex items-center justify-center",children:e.jsx(P,{text:"מייבא ספקים בעזרת AI..."})}),e.jsx("input",{type:"file",ref:v,onChange:V,accept:"application/pdf,text/csv",className:"hidden"}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h1",{className:"text-2xl font-bold text-slate-800",children:"רשימת ספקים"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:()=>z(!i),className:`btn-secondary text-sm flex items-center gap-2 ${i?"bg-sky-100 text-sky-700 ring-2 ring-sky-200":""}`,children:[e.jsx(E,{className:"w-4 h-4"})," ",i?"סיום עריכה":"ערוך"]}),e.jsxs("button",{onClick:K,className:"btn-secondary flex items-center gap-2 text-sm",children:[e.jsx(ce,{className:"w-5 h-5 text-purple-600"})," יבא"]}),e.jsxs("button",{onClick:()=>k(),className:"btn-primary flex items-center gap-2 text-sm",children:[e.jsx(se,{className:"w-4 h-4"})," הוסף ספק"]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:B,className:"btn-secondary text-sm flex items-center gap-2",children:[e.jsx(T,{className:"w-4 h-4"})," יצא ל-PDF ",i&&d>0&&`(${d})`]}),e.jsxs("button",{onClick:q,className:"btn-secondary text-sm flex items-center gap-2",children:[e.jsx(T,{className:"w-4 h-4"})," יצא ל-Excel ",i&&d>0&&`(${d})`]})]}),e.jsxs("div",{className:"relative my-4",children:[e.jsx("span",{className:"absolute inset-y-0 left-0 flex items-center pl-3 rtl:right-0 rtl:pl-0 rtl:pr-3",children:e.jsx(te,{className:"w-5 h-5 text-slate-400"})}),e.jsx("input",{type:"search",placeholder:"חיפוש ספקים...",value:f,onChange:s=>R(s.target.value),className:"w-full pl-10 pr-4 py-2 rtl:pr-10 rtl:pl-4 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500"})]}),m.length===0?e.jsx("div",{className:"text-center p-10 bg-white rounded-lg shadow border",children:e.jsx("p",{className:"text-slate-500",children:"לא נמצאו ספקים."})}):e.jsx("div",{className:"space-y-4",children:H.map(s=>{const t=j[s],a=t.length>0&&t.every(r=>x[r.id]);return e.jsx(oe,{count:t.length,title:e.jsxs("div",{className:"flex items-center gap-3",children:[i&&e.jsx("input",{type:"checkbox",className:"form-checkbox h-5 w-5 rounded text-sky-600 focus:ring-sky-500",checked:a,onChange:r=>J(s,r.target.checked),onClick:r=>r.stopPropagation()}),e.jsx("span",{children:s})]}),children:e.jsx("div",{className:"space-y-3",children:t.map(r=>e.jsxs("div",{className:`bg-white p-4 rounded-lg shadow-sm border flex items-center gap-4 transition-all duration-200 ${i?"cursor-pointer":""} ${x[r.id]?"bg-sky-50 border-sky-300 ring-2 ring-sky-200":"hover:shadow-md hover:border-sky-200"}`,onClick:i?()=>I(r.id):void 0,children:[i&&e.jsx("input",{type:"checkbox",className:"form-checkbox h-5 w-5 rounded text-sky-600 focus:ring-sky-500 flex-shrink-0",checked:!!x[r.id],onChange:()=>I(r.id),onClick:p=>p.stopPropagation()}),e.jsxs("div",{className:"flex-grow space-y-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-bold text-slate-800 text-base",children:r.name}),r.companyId&&e.jsxs("p",{className:"text-xs text-slate-500",children:["ח.פ: ",r.companyId]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-1",children:[e.jsxs("p",{className:"flex items-center gap-2",children:[e.jsx(ue,{className:"w-4 h-4 text-slate-400"})," ",e.jsx("a",{href:`tel:${r.phone}`,className:"text-sky-600 hover:underline",children:r.phone})]}),e.jsxs("p",{className:"flex items-center gap-2 truncate",children:[e.jsx(xe,{className:"w-4 h-4 text-slate-400"})," ",e.jsx("a",{href:`mailto:${r.email}`,className:"text-sky-600 hover:underline truncate",children:r.email})]}),r.address&&e.jsxs("p",{className:"flex items-center gap-2 sm:col-span-2",children:[e.jsx(he,{className:"w-4 h-4 text-slate-400"})," ",r.address]})]})]}),i&&e.jsxs("div",{className:"flex-shrink-0 flex items-center gap-2",children:[e.jsx("button",{onClick:p=>{p.stopPropagation(),k(r)},className:"p-1.5 text-slate-500 hover:bg-slate-100 rounded-full",children:e.jsx(E,{className:"w-4 h-4"})}),e.jsx("button",{onClick:p=>{p.stopPropagation(),_(r.id)},className:"p-1.5 text-red-500 hover:bg-red-100 rounded-full",children:e.jsx(A,{className:"w-4 h-4"})})]})]},r.id))})},s)})}),i&&d>0&&e.jsxs("div",{className:"fixed bottom-24 inset-x-4 z-40 bg-slate-800 text-white rounded-lg shadow-lg p-4 flex justify-between items-center animate-fadeInUp",children:[e.jsxs("span",{children:[d," ספקים נבחרו"]}),e.jsxs("button",{onClick:Q,className:"flex items-center gap-2 px-3 py-1.5 bg-red-500 hover:bg-red-600 rounded-md text-sm font-medium",children:[e.jsx(A,{className:"w-5 h-5"})," מחק נבחרים"]})]}),e.jsx(ae,{isOpen:F,onClose:()=>g(!1),title:o?.id?"עריכת ספק":"הוספת ספק חדש",size:"md",children:o&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsx("input",{type:"text",placeholder:"שם",value:o.name||"",onChange:s=>u(t=>({...t,name:s.target.value})),className:"input-class"}),e.jsx("input",{type:"text",placeholder:"קבוצה/תחום",value:o.group||"",onChange:s=>u(t=>({...t,group:s.target.value})),className:"input-class"}),e.jsx("input",{type:"tel",placeholder:"טלפון",value:o.phone||"",onChange:s=>u(t=>({...t,phone:s.target.value})),className:"input-class"}),e.jsx("input",{type:"email",placeholder:"אימייל",value:o.email||"",onChange:s=>u(t=>({...t,email:s.target.value})),className:"input-class"})]}),e.jsx("input",{type:"text",placeholder:"כתובת",value:o.address||"",onChange:s=>u(t=>({...t,address:s.target.value})),className:"input-class w-full"}),e.jsx("input",{type:"text",placeholder:"ח.פ / מספר עוסק",value:o.companyId||"",onChange:s=>u(t=>({...t,companyId:s.target.value})),className:"input-class w-full"}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4",children:[e.jsx("button",{onClick:()=>g(!1),className:"btn-secondary",children:"ביטול"}),e.jsx("button",{onClick:U,className:"btn-primary",children:"שמור"})]})]})}),e.jsx("style",{children:`
                .input-class { display: block; width: 100%; border: 1px solid #cbd5e1; border-radius: 0.375rem; padding: 0.5rem 0.75rem; }
                .btn-primary { padding: 0.5rem 1rem; background-color: #0284c7; color: white; border-radius: 0.375rem; font-weight: 500; }
                .btn-secondary { padding: 0.5rem 1rem; background-color: #f1f5f9; color: #334155; border: 1px solid #cbd5e1; border-radius: 0.375rem; font-weight: 500; }
            `})]})};export{ve as default};
