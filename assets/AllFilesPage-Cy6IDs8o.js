import{r as i,u as ge,h as xe,ai as je,g as we,j as s,a as ye,p as be,A as B,af as Se,P as ve,T as ke,aj as Ne,ak as Ae,M as Ce,z as D,l as W,e as q,al as De}from"./index-D-cHbBwn.js";import{f as K}from"./dateFormatter-CUKId3Gl.js";import{F as Fe,i as Pe,E as Ie}from"./FileItem-Bn3NXJhM.js";import{C as Te}from"./CollapsibleSection-F92uqtdU.js";import{A as Ee}from"./AddFileModal-Dsl0kVwl.js";import{A as Me}from"./AnnotationEditor-CCeRCJQ5.js";import{e as Ue}from"./exportUtils-Bak1EFUX.js";import{c as Oe}from"./pdfService-D-0A9fw7.js";import{R as $e}from"./RenewFileModal-C1lYahW7.js";import"./RecurrenceEditor-rLx-RXEn.js";import"./shareUtils-BhFQGnPw.js";const _e=({file:l,onClose:d})=>{if(!l)return null;const p=l.url||l.dataUrl;return s.jsx(Ce,{isOpen:!!l,onClose:d,title:`תצוגה מקדימה: ${l.name}`,size:"xl",children:s.jsx("div",{className:"w-full h-[75vh] bg-slate-200 rounded-md",children:p&&l.mimeType.startsWith("image/")?s.jsx("img",{src:p,alt:l.name,className:"w-full h-full object-contain"}):p&&l.mimeType==="application/pdf"?s.jsx("iframe",{src:p,title:l.name,className:"w-full h-full border-0"}):s.jsx("div",{className:"flex items-center justify-center h-full text-slate-600",children:s.jsx("p",{children:"לא ניתן להציג תצוגה מקדימה עבור קובץ מסוג זה."})})})})},M=({label:l,value:d,currentValue:p,onClick:f})=>s.jsx("button",{onClick:()=>f(d),className:`px-3 py-1.5 text-sm font-medium rounded-md transition-colors ${p===d?"bg-sky-600 text-white shadow":"bg-slate-100 text-slate-700 hover:bg-slate-200"}`,children:l}),Le=l=>{if(!l)return"#d1d5db";let d=0;for(let f=0;f<l.length;f++)d=l.charCodeAt(f)+((d<<5)-d),d|=0;return`hsl(${d%360}, 60%, 80%)`},Ye=()=>{const[l,d]=i.useState([]),[p,f]=i.useState([]),[H,k]=i.useState(!0),[J,U]=i.useState(null),[O,Re]=i.useState("uploadedAt-desc"),[g,F]=i.useState(""),[Q,$]=i.useState(!1),[N,P]=i.useState(null),{addToast:n}=ge(),{settings:X}=xe(),[_,L]=i.useState(""),[A,Y]=i.useState(""),[x,b]=i.useState(null),[Z,I]=i.useState(""),[R,T]=i.useState(null),[u,G]=i.useState(!1),[S,C]=i.useState({}),v=Object.keys(S).length,h=i.useCallback(async()=>{k(!0);try{const[e,t]=await Promise.all([je(),we()]);d(e),f(t)}catch(e){console.error("Error fetching all files:",e),n("שגיאה בטעינת הקבצים","error")}finally{k(!1)}},[n]);i.useEffect(()=>{h()},[h]),i.useEffect(()=>{u||C({})},[u]);const ee=async(e,t)=>{if(window.confirm("האם אתה בטוח שברצונך למחוק קובץ זה?"))try{await Ne(e,t),n("הקובץ נמחק בהצלחה","success"),h()}catch(a){console.error("Error deleting file:",a),n("שגיאה במחיקת הקובץ","error")}},te=async e=>{if(!_)return;const t=p.find(a=>a.id===_);if(t)try{const a={...t,files:[...t.files,...e],updatedAt:new Date().toISOString()};await D(a),n(`${e.length} ${e.length>1?"קבצים הועלו":"קובץ הועלה"} בהצלחה`,"success"),h()}catch{n("שגיאה בהעלאת הקבצים","error")}},re=async e=>{if(N)try{const t=await W(N.projectId);if(!t)throw new Error("Project not found");t.files=t.files.map(a=>a.id===e.id?e:a),t.updatedAt=new Date().toISOString(),await D(t),n("הקובץ עודכן בהצלחה","success"),h()}catch{n("שגיאה בעדכון הקובץ","error")}finally{P(null)}},se=e=>{b(e);const t=e.originalUrl||e.originalDataUrl||e.url||e.dataUrl;if(!t){n("שגיאה בטעינת הקובץ לעריכה.","error");return}I(t)},ae=async e=>{if(!x)return;const t=await W(x.projectId);if(!t){n("Project not found for this file","error"),b(null);return}const a=t.files.find(o=>o.id===x.id);if(!a){n("File not found in project","error"),b(null);return}const r={...a,dataUrl:e.annotatedDataUrl,annotationData:e.annotationData,originalDataUrl:a.originalDataUrl||a.dataUrl,originalUrl:a.originalUrl||a.url,originalStoragePath:a.originalStoragePath||a.storagePath,url:void 0,storagePath:void 0},c={...t,files:t.files.map(o=>o.id===r.id?r:o),updatedAt:new Date().toISOString()};try{await D(c),n("הערות תמונה נשמרו בהצלחה!","success"),h()}catch{n("שגיאה בשמירת הערות.","error")}finally{b(null),I("")}},oe=e=>{L(e),$(!0)},V=e=>{C(t=>{const a={...t};return a[e]?delete a[e]:a[e]=!0,a})},ne=(e,t)=>{const a=e.map(r=>r.id);C(r=>{const c={...r};return t?a.forEach(o=>c[o]=!0):a.forEach(o=>delete c[o]),c})},le=async()=>{if(v!==0&&window.confirm(`האם אתה בטוח שברצונך למחוק ${v} קבצים נבחרים?`)){const t=l.filter(a=>S[a.id]).map(a=>({fileId:a.id,projectId:a.projectId}));try{await Ae(t),n(`${v} קבצים נמחקו בהצלחה`,"success"),C({}),G(!1),h()}catch{n("שגיאה במחיקת הקבצים","error")}}},ie=e=>{T(e)},ce=async(e,t,a)=>{if(!("projectId"in e)){n("Project context missing for file renewal.","error");return}const r=e,c=p.find(o=>o.id===r.projectId);if(!c){n("Project not found for this file","error");return}k(!0);try{const o=q(),{url:m,storagePath:w}=await De(t,`projects/${c.id}/files`,o),y={id:q(),name:r.name,mimeType:r.mimeType,uploadedAt:r.uploadedAt||r.createdAt,dueDate:r.dueDate,url:r.url,storagePath:r.storagePath},he={id:r.id,name:r.name,group:r.group,startDate:r.startDate,recurrenceType:r.recurrenceType,recurrence:r.recurrence,duration:r.duration,annotationData:r.annotationData,caption:r.caption,folder:r.folder,originalDataUrl:void 0,originalStoragePath:r.originalStoragePath,originalUrl:r.originalUrl,mimeType:t.type,uploadedAt:new Date().toISOString(),createdAt:r.createdAt,dueDate:a,url:m,storagePath:w,history:[y,...r.history||[]]},fe={...c,files:c.files.map(z=>z.id===r.id?he:z),updatedAt:new Date().toISOString()};await D(fe),n("הקובץ חודש בהצלחה","success"),h(),T(null)}catch(o){n("שגיאה בחידוש הקובץ","error"),console.error(o)}finally{k(!1)}},de=i.useMemo(()=>{const e=new Set(l.map(t=>t.group).filter(Boolean));return Array.from(e).sort((t,a)=>t.localeCompare(a,"he"))},[l]),j=i.useMemo(()=>{let e=[...l];if(A){const o=A.toLowerCase();e=e.filter(m=>m.name.toLowerCase().includes(o)||m.projectName.toLowerCase().includes(o)||m.group&&m.group.toLowerCase().includes(o))}const a=[...e.filter(o=>g?g==="__none__"?!o.group:o.group===g:!0)],[r,c]=O.split("-");return a.sort((o,m)=>{let w,y;switch(r){case"projectName":w=o.projectName.toLowerCase(),y=m.projectName.toLowerCase();break;case"uploadedAt":default:w=new Date(o.uploadedAt).getTime(),y=new Date(m.uploadedAt).getTime();break}return w<y?c==="asc"?-1:1:w>y?c==="asc"?1:-1:0}),a},[l,O,g,A]),E=i.useMemo(()=>j.reduce((e,t)=>{const a=t.projectName;return e[a]||(e[a]={projectId:t.projectId,files:[]}),e[a].files.push(t),e},{}),[j]),ue=i.useMemo(()=>Object.keys(E).sort((e,t)=>e.localeCompare(t,"he")),[E]),pe=()=>{if(j.length===0){n("אין קבצים לייצוא","warning");return}n("מכין PDF...","info"),Oe({settings:X,files:j})},me=()=>{if(j.length===0){n("אין קבצים לייצוא","warning");return}const e=j.map(t=>({בניין:t.projectName,"שם הקובץ":t.name,קבוצה:t.group||"-","תאריך התחלה":t.startDate?K(t.startDate):"-","תאריך תפוגה":t.dueDate?K(t.dueDate):"-",חוזר:t.recurrenceType==="recurring"?"כן":"לא"}));Ue(e,"all_files_list"),n("קובץ Excel יוצא...","success")};return H?s.jsx(ye,{text:"טוען קבצים..."}):s.jsxs("div",{className:"animate-fadeIn",children:[s.jsxs("div",{className:"flex justify-between items-center mb-6 flex-wrap gap-4",children:[s.jsx("h2",{className:"text-2xl font-bold text-slate-800",children:"כל הקבצים"}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs("button",{onClick:()=>G(!u),className:`btn-secondary flex items-center gap-2 ${u?"bg-sky-100 text-sky-700 ring-2 ring-sky-200":""}`,children:[s.jsx(be,{className:"w-5 h-5"})," ",u?"סיום":"ערוך"]}),s.jsxs("button",{onClick:pe,className:"btn-secondary flex items-center gap-2",children:[s.jsx(B,{className:"w-5 h-5"}),"יצא PDF"]}),s.jsxs("button",{onClick:me,className:"btn-secondary flex items-center gap-2",children:[s.jsx(B,{className:"w-5 h-5"}),"יצא Excel"]})]})]}),s.jsxs("div",{className:"bg-white p-4 rounded-lg shadow-md border mb-6 space-y-4",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-slate-600 mb-2",children:"סנן לפי קבוצה:"}),s.jsxs("div",{className:"flex flex-wrap gap-2",children:[s.jsx(M,{label:"הכל",value:"",currentValue:g,onClick:F}),s.jsx(M,{label:"ללא קבוצה",value:"__none__",currentValue:g,onClick:F}),de.map(e=>s.jsx(M,{label:e,value:e,currentValue:g,onClick:F},e))]})]}),s.jsxs("div",{className:"relative pt-2",children:[s.jsx("span",{className:"absolute inset-y-0 left-0 flex items-center pl-3 pt-2 rtl:right-0 rtl:pl-0 rtl:pr-3",children:s.jsx(Se,{className:"w-5 h-5 text-slate-400"})}),s.jsx("input",{type:"search",placeholder:"חיפוש קבצים...",value:A,onChange:e=>Y(e.target.value),className:"w-full pl-10 pr-4 py-2 rtl:pr-10 rtl:pl-4 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500"})]})]}),l.length===0?s.jsx("div",{className:"text-center py-16 bg-white rounded-lg shadow-md border",children:s.jsx("h3",{className:"text-2xl font-semibold text-slate-700",children:"לא נמצאו קבצים"})}):s.jsx("div",{className:"space-y-4",children:ue.map(e=>{const t=E[e],a=t.files.length>0&&t.files.every(r=>S[r.id]);return s.jsx(Te,{count:t.files.length,title:s.jsxs("div",{className:"flex items-center gap-3",children:[u&&s.jsx("input",{type:"checkbox",className:"form-checkbox h-5 w-5 rounded text-sky-600 focus:ring-sky-500",checked:a,onChange:r=>ne(t.files,r.target.checked),onClick:r=>r.stopPropagation()}),s.jsx("h3",{className:"text-xl font-semibold",children:e})]}),children:s.jsxs("div",{className:"space-y-3",children:[s.jsx("div",{className:"flex justify-end",children:s.jsxs("button",{onClick:()=>oe(t.projectId),className:"flex items-center gap-1 text-sm bg-sky-100 text-sky-700 px-3 py-1 rounded-md hover:bg-sky-200",children:[s.jsx(ve,{className:"w-4 h-4"})," הוסף קובץ לבניין זה"]})}),t.files.map(r=>s.jsxs("div",{className:`relative transition-all duration-200 ${u?"cursor-pointer":""} ${S[r.id]?"bg-sky-50 rounded-lg":""}`,onClick:u?()=>V(r.id):void 0,children:[u&&s.jsx("input",{type:"checkbox",className:"form-checkbox h-5 w-5 rounded text-sky-600 focus:ring-sky-500 absolute top-3 left-3 rtl:right-3 rtl:left-auto",checked:!!S[r.id],onChange:()=>V(r.id),onClick:c=>c.stopPropagation()}),s.jsx(Fe,{file:r,onView:Pe(r.mimeType)?()=>U(r):void 0,onDelete:()=>ee(r.projectId,r.id),onEdit:()=>P(r),onAnnotate:()=>se(r),onRenew:()=>ie(r),className:`border-l-4 rtl:border-r-4 rtl:border-l-0 ${u?"pl-10 rtl:pr-10":""}`,style:{borderColor:Le(r.group||"")}})]},r.id))]})},e)})}),u&&v>0&&s.jsxs("div",{className:"fixed bottom-24 inset-x-4 z-40 bg-slate-800 text-white rounded-lg shadow-lg p-4 flex justify-between items-center animate-fadeInUp",children:[s.jsxs("span",{children:[v," קבצים נבחרו"]}),s.jsxs("button",{onClick:le,className:"flex items-center gap-2 px-3 py-1.5 bg-red-500 hover:bg-red-600 rounded-md text-sm font-medium",children:[s.jsx(ke,{className:"w-5 h-5"})," מחק נבחרים"]})]}),s.jsx(_e,{file:J,onClose:()=>U(null)}),s.jsx(Ee,{isOpen:Q,onClose:()=>{$(!1),L("")},onSave:te}),s.jsx(Ie,{isOpen:!!N,onClose:()=>P(null),onSave:re,file:N}),x&&s.jsx(Me,{isOpen:!!x,onClose:()=>{b(null),I("")},onSave:ae,imageSrc:Z,initialAnnotationData:x?.annotationData||"[]"}),s.jsx($e,{isOpen:!!R,onClose:()=>T(null),file:R,onSave:ce}),s.jsx("style",{children:".btn-secondary { padding: 0.5rem 1rem; background-color: #f1f5f9; color: #334155; border: 1px solid #cbd5e1; border-radius: 0.375rem; font-weight: 500; }"})]})};export{Ye as default};
