import{k as Pe,r as l,u as Ae,h as Ce,l as Me,j as t,a as _e,L as Te,p as Ie,A as K,P as Oe,T as Ee,M as X,z as k,aj as Ue,e as J,al as Ge}from"./index-D-cHbBwn.js";import{F as Ye,i as $e,E as Re}from"./FileItem-Bn3NXJhM.js";import{A as qe}from"./AddFileModal-Dsl0kVwl.js";import{A as Ve}from"./AnnotationEditor-CCeRCJQ5.js";import{e as ze}from"./exportUtils-Bak1EFUX.js";import{h as Le}from"./pdfService-D-0A9fw7.js";import{f as Q}from"./dateFormatter-CUKId3Gl.js";import{C as He}from"./CollapsibleSection-F92uqtdU.js";import{R as Be}from"./RenewFileModal-C1lYahW7.js";import"./RecurrenceEditor-rLx-RXEn.js";import"./shareUtils-BhFQGnPw.js";const We=({file:c,onClose:n})=>{if(!c)return null;const x=c.url||c.dataUrl;return t.jsx(X,{isOpen:!!c,onClose:n,title:`תצוגה מקדימה: ${c.name}`,size:"xl",children:t.jsx("div",{className:"w-full h-[75vh] bg-slate-200 rounded-md",children:x&&c.mimeType.startsWith("image/")?t.jsx("img",{src:x,alt:c.name,className:"w-full h-full object-contain"}):x&&c.mimeType==="application/pdf"?t.jsx("iframe",{src:x,title:c.name,className:"w-full h-full border-0"}):t.jsx("div",{className:"flex items-center justify-center h-full text-slate-600",children:t.jsx("p",{children:"לא ניתן להציג תצוגה מקדימה עבור קובץ מסוג זה."})})})})},lt=()=>{const{projectId:c}=Pe(),[n,x]=l.useState(null),[Z,g]=l.useState(!0),{addToast:i}=Ae(),{settings:ee}=Ce(),[te,R]=l.useState(null),[se,q]=l.useState(!1),[V,z]=l.useState(null),[f,re]=l.useState("all"),[A,ae]=l.useState("all"),[C,ne]=l.useState("all"),[S,M]=l.useState(null),[le,U]=l.useState(""),[L,G]=l.useState(null),[Y,_]=l.useState(!1),[p,N]=l.useState([]),[j,T]=l.useState([]),[y,I]=l.useState([]),[u,H]=l.useState(!1),[D,$]=l.useState({}),F=Object.keys(D).length,m=l.useCallback(async()=>{if(c){g(!0);try{const e=await Me(c);x(e)}catch{i("Error fetching project files","error")}finally{g(!1)}}},[c,i]);l.useEffect(()=>{m()},[m]),l.useEffect(()=>{u||$({})},[u]);const oe=async e=>{if(window.confirm("האם אתה בטוח שברצונך למחוק קובץ זה?"))try{await Ue(c,e),i("הקובץ נמחק בהצלחה","success"),m()}catch{i("שגיאה במחיקת הקובץ","error")}},ie=async()=>{if(!(!n||F===0)&&window.confirm(`האם אתה בטוח שברצונך למחוק ${F} קבצים?`)){const e=Object.keys(D),s={...n,files:n.files.filter(r=>!e.includes(r.id)),updatedAt:new Date().toISOString()};try{await k(s),i(`${F} קבצים נמחקו`,"success"),m(),H(!1)}catch{i("שגיאה במחיקת קבצים","error")}}},ce=async e=>{if(!n)return;const s={...n,files:[...n.files||[],...e],updatedAt:new Date().toISOString()};try{await k(s),i(`${e.length} ${e.length>1?"קבצים נוספו":"קובץ נוסף"} בהצלחה`,"success"),m()}catch{i("שגיאה בהוספת קבצים","error")}},de=async e=>{if(!n)return;const s={...n,files:n.files.map(r=>r.id===e.id?e:r),updatedAt:new Date().toISOString()};try{await k(s),i("הקובץ עודכן בהצלחה","success"),m()}catch{i("שגיאה בעדכון הקובץ","error")}},ue=e=>{M(e);const s=e.originalUrl||e.originalDataUrl||e.url||e.dataUrl;if(!s){i("שגיאה בטעינת הקובץ לעריכה.","error");return}U(s)},me=async e=>{if(!S||!n)return;const s=n.files.find(o=>o.id===S.id);if(!s){i("File not found","error"),M(null);return}const r={...s,dataUrl:e.annotatedDataUrl,annotationData:e.annotationData,originalDataUrl:s.originalDataUrl||s.dataUrl,originalUrl:s.originalUrl||s.url,originalStoragePath:s.originalStoragePath||s.storagePath,url:void 0,storagePath:void 0},a={...n,files:n.files.map(o=>o.id===r.id?r:o),updatedAt:new Date().toISOString()};try{await k(a),i("הערות תמונה נשמרו בהצלחה!","success"),m()}catch{i("שגיאה בשמירת הערות.","error")}finally{M(null),U("")}},he=e=>{G(e)},pe=async(e,s,r)=>{if(n){g(!0);try{const a=J(),{url:o,storagePath:h}=await Ge(s,`projects/${n.id}/files`,a),E={id:J(),name:e.name,mimeType:e.mimeType,uploadedAt:e.uploadedAt||e.createdAt,dueDate:e.dueDate,url:e.url,storagePath:e.storagePath},d={...e,name:e.name,mimeType:s.type,uploadedAt:new Date().toISOString(),dueDate:r,url:o,storagePath:h,history:[E,...e.history||[]],dataUrl:void 0,originalDataUrl:void 0},Fe={...n,files:n.files.map(W=>W.id===e.id?d:W),updatedAt:new Date().toISOString()};await k(Fe),i("הקובץ חודש בהצלחה","success"),m(),G(null)}catch(a){i("שגיאה בחידוש הקובץ","error"),console.error(a)}finally{g(!1)}}},xe=async(e,s)=>{if(!n||!window.confirm("האם אתה בטוח שברצונך למחוק גרסה היסטורית זו? לא ניתן לבטל פעולה זו."))return;const r=n.files.find(o=>o.id===e);if(!(!r||!r.history||!r.history.find(o=>o.id===s))){g(!0);try{const o=r.history.filter(d=>d.id!==s),h={...r,history:o},E={...n,files:n.files.map(d=>d.id===e?h:d),updatedAt:new Date().toISOString()};await k(E),i("גרסה היסטורית נמחקה","success"),m()}catch(o){i("שגיאה במחיקת הגרסה","error"),console.error("Error deleting history file:",o)}finally{g(!1)}}},{uniqueGroups:ge,uniqueYears:b}=l.useMemo(()=>{if(!n?.files)return{uniqueGroups:[],uniqueYears:[]};const e=new Set(n.files.map(r=>r.group).filter(Boolean)),s=new Set(n.files.map(r=>new Date(r.startDate||r.uploadedAt||r.createdAt).getFullYear().toString()));return{uniqueGroups:Array.from(e).sort((r,a)=>r.localeCompare(a,"he")),uniqueYears:Array.from(s).sort((r,a)=>a.localeCompare(r))}},[n?.files]),P=l.useMemo(()=>{if(!n?.files)return[];const e=new Set;return n.files.forEach(r=>{e.add(r.group||"__none__")}),Array.from(e).sort((r,a)=>r==="__none__"?1:a==="__none__"?-1:r.localeCompare(a,"he"))},[n?.files]),w=l.useMemo(()=>n?.files?n.files.filter(e=>{const s=new Date(e.startDate||e.uploadedAt||e.createdAt).getFullYear().toString(),r=A==="all"||s===A,a=f==="all"||f===""?!0:f==="__none__"?!e.group:e.group===f;return r&&a&&(()=>{if(C==="all"||!e.dueDate)return!0;const h=new Date,d=(new Date(e.dueDate).getTime()-h.getTime())/(1e3*3600*24);switch(C){case"expired":return d<0;case"week":return d>=0&&d<=7;case"month":return d>7&&d<=30;case"year":return d>30&&d<=365;default:return!0}})()}):[],[n?.files,f,A,C]),O=l.useMemo(()=>w?w.reduce((e,s)=>{const r=s.group||"ללא קבוצה";return e[r]||(e[r]=[]),e[r].push(s),e},{}):{},[w]),fe=l.useMemo(()=>Object.keys(O).sort((e,s)=>e==="ללא קבוצה"?1:s==="ללא קבוצה"?-1:e.localeCompare(s,"he")),[O]),v=l.useMemo(()=>w.filter(e=>{const s=new Date(e.startDate||e.uploadedAt||e.createdAt).getFullYear().toString(),r=y.length===0||y.includes(s),a=e.group||"__none__",o=j.length===0||j.includes(a);return r&&o}),[w,j,y]);l.useEffect(()=>{Y&&N(v.map(e=>e.id))},[v,Y]);const je=()=>{if(w.length===0){i("אין קבצים לייצוא","warning");return}T(P),I(b),_(!0)},ye=()=>{if(!n||p.length===0){i("יש לבחור לפחות קובץ אחד לייצוא","warning");return}const e=n.files.filter(s=>p.includes(s.id));i("מכין PDF...","info"),Le({settings:ee,project:n,files:e}),_(!1)},be=()=>{if(!n||!n.files||n.files.length===0){i("אין קבצים לייצוא","warning");return}const e=(n.files||[]).map(s=>({"שם הקובץ":s.name,קבוצה:s.group||"-","תאריך התחלה":s.startDate?Q(s.startDate):"-","תאריך תפוגה":s.dueDate?Q(s.dueDate):"-",חוזר:s.recurrenceType==="recurring"?"כן":"לא"}));ze(e,`files_${n.name}`)},B=e=>{$(s=>{const r={...s};return r[e]?delete r[e]:r[e]=!0,r})},we=(e,s)=>{const r=e.map(a=>a.id);$(a=>{const o={...a};return s?r.forEach(h=>o[h]=!0):r.forEach(h=>delete o[h]),o})},ve=()=>{const e=v.map(r=>r.id),s=e.length>0&&e.every(r=>p.includes(r));N(s?r=>r.filter(a=>!e.includes(a)):r=>[...new Set([...r,...e])])},ke=e=>{T(s=>s.includes(e)?s.filter(r=>r!==e):[...s,e])},Se=e=>{I(s=>s.includes(e)?s.filter(r=>r!==e):[...s,e])},Ne=()=>{j.length===P.length?T([]):T(P)},De=()=>{y.length===b.length?I([]):I(b)};return Z?t.jsx(_e,{text:"טוען קבצים..."}):t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"flex justify-between items-center flex-wrap gap-4",children:[t.jsxs("div",{children:[t.jsx("nav",{className:"text-sm mb-1",children:t.jsx(Te,{to:`/project/${c}`,className:"text-sky-600 hover:underline",children:"חזרה לבניין"})}),t.jsxs("h2",{className:"text-2xl font-semibold text-slate-700",children:["קבצים עבור: ",n?.name]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("button",{onClick:()=>H(!u),className:`btn-secondary flex items-center gap-2 ${u?"bg-sky-100 text-sky-700 ring-2 ring-sky-200":""}`,children:[t.jsx(Ie,{className:"w-5 h-5"})," ",u?"סיום":"ערוך"]}),t.jsxs("button",{onClick:je,className:"btn-secondary flex items-center gap-2",children:[t.jsx(K,{className:"w-5 h-5"}),"יצא PDF"]}),t.jsxs("button",{onClick:be,className:"btn-secondary flex items-center gap-2",children:[t.jsx(K,{className:"w-5 h-5"}),"יצא Excel"]}),t.jsxs("button",{onClick:()=>q(!0),className:"bg-sky-600 hover:bg-sky-700 text-white font-medium py-2 px-4 rounded-lg shadow-md flex items-center transition-colors",children:[t.jsx(Oe,{className:"w-5 h-5 me-2 rtl:ml-2"})," הוסף קובץ"]})]})]}),t.jsxs("div",{className:"bg-white p-4 rounded-lg shadow-md border flex flex-wrap items-center gap-4",children:[t.jsxs("div",{className:"flex-1 min-w-[150px]",children:[t.jsx("label",{htmlFor:"groupFilter",className:"block text-sm font-medium text-slate-600",children:"סנן לפי קבוצה:"}),t.jsxs("select",{id:"groupFilter",value:f,onChange:e=>re(e.target.value),className:"w-full mt-1 select-class",children:[t.jsx("option",{value:"all",children:"כל הקבוצות"}),t.jsx("option",{value:"__none__",children:"ללא קבוצה"}),ge.map(e=>t.jsx("option",{value:e,children:e},e))]})]}),t.jsxs("div",{className:"flex-1 min-w-[150px]",children:[t.jsx("label",{htmlFor:"yearFilter",className:"block text-sm font-medium text-slate-600",children:"סנן לפי שנה:"}),t.jsxs("select",{id:"yearFilter",value:A,onChange:e=>ae(e.target.value),className:"w-full mt-1 select-class",children:[t.jsx("option",{value:"all",children:"כל השנים"}),b.map(e=>t.jsx("option",{value:e,children:e},e))]})]}),t.jsxs("div",{className:"flex-1 min-w-[150px]",children:[t.jsx("label",{htmlFor:"validityFilter",className:"block text-sm font-medium text-slate-600",children:"סנן לפי תוקף:"}),t.jsxs("select",{id:"validityFilter",value:C,onChange:e=>ne(e.target.value),className:"w-full mt-1 select-class",children:[t.jsx("option",{value:"all",children:"הכל"}),t.jsx("option",{value:"expired",children:"פג תוקף"}),t.jsx("option",{value:"week",children:"יפוג השבוע"}),t.jsx("option",{value:"month",children:"יפוג החודש"}),t.jsx("option",{value:"year",children:"יפוג השנה"})]})]})]}),Object.keys(O).length>0?t.jsx("div",{className:"space-y-6",children:fe.map(e=>{const s=O[e],r=s.length>0&&s.every(a=>D[a.id]);return t.jsx(He,{title:t.jsxs("div",{className:"flex items-center gap-3",children:[u&&t.jsx("input",{type:"checkbox",className:"form-checkbox h-5 w-5 rounded text-sky-600 focus:ring-sky-500",checked:r,onChange:a=>we(s,a.target.checked),onClick:a=>a.stopPropagation()}),t.jsx("h3",{className:"text-lg font-semibold",children:e})]}),count:s.length,defaultOpen:!0,children:t.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4",children:s.map(a=>t.jsxs("div",{className:`relative transition-all duration-200 ${u?"cursor-pointer":""} ${D[a.id]?"bg-sky-50 rounded-lg":""}`,onClick:u?()=>B(a.id):void 0,children:[u&&t.jsx("input",{type:"checkbox",className:"form-checkbox h-5 w-5 rounded text-sky-600 focus:ring-sky-500 absolute top-3 left-3 rtl:right-3 rtl:left-auto",checked:!!D[a.id],onChange:()=>B(a.id),onClick:o=>o.stopPropagation()}),t.jsx(Ye,{file:a,onView:$e(a.mimeType)?()=>R(a):void 0,onDelete:()=>oe(a.id),onEdit:()=>z(a),onAnnotate:a.mimeType.startsWith("image/")?()=>ue(a):void 0,onRenew:()=>he(a),onDeleteHistory:xe,className:u?"pl-10 rtl:pr-10":""},a.id)]},a.id))})},e)})}):t.jsx("div",{className:"text-center p-10 bg-white rounded-lg shadow border",children:t.jsx("p",{className:"text-slate-500",children:"לא נמצאו קבצים התואמים לסינון."})}),u&&F>0&&t.jsxs("div",{className:"fixed bottom-24 inset-x-4 z-40 bg-slate-800 text-white rounded-lg shadow-lg p-4 flex justify-between items-center animate-fadeInUp",children:[t.jsxs("span",{children:[F," קבצים נבחרו"]}),t.jsxs("button",{onClick:ie,className:"flex items-center gap-2 px-3 py-1.5 bg-red-500 hover:bg-red-600 rounded-md text-sm font-medium",children:[t.jsx(Ee,{className:"w-5 h-5"})," מחק נבחרים"]})]}),t.jsx(We,{file:te,onClose:()=>R(null)}),t.jsx(qe,{isOpen:se,onClose:()=>q(!1),onSave:ce}),t.jsx(Re,{isOpen:!!V,onClose:()=>z(null),onSave:de,file:V}),S&&t.jsx(Ve,{isOpen:!!S,onClose:()=>{M(null),U("")},onSave:me,imageSrc:le,initialAnnotationData:S?.annotationData||"[]"}),t.jsx(Be,{isOpen:!!L,onClose:()=>G(null),file:L,onSave:pe}),t.jsx(X,{isOpen:Y,onClose:()=>_(!1),title:"בחירת קבצים להפקת PDF",size:"lg",children:t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4 p-2 bg-slate-50 rounded-md border",children:[t.jsxs("div",{children:[t.jsxs("div",{className:"flex justify-between items-center mb-1",children:[t.jsx("label",{className:"block text-sm font-medium text-slate-600",children:"סנן לפי שנה:"}),t.jsx("button",{onClick:De,className:"text-xs text-sky-600 hover:underline",children:y.length===b.length?"בטל הכל":"בחר הכל"})]}),t.jsx("div",{className:"max-h-32 overflow-y-auto border rounded-md p-2 space-y-1 bg-white",children:b.map(e=>t.jsxs("label",{className:"flex items-center gap-2 p-1 hover:bg-slate-100 rounded",children:[t.jsx("input",{type:"checkbox",className:"form-checkbox",checked:y.includes(e),onChange:()=>Se(e)}),e]},e))})]}),t.jsxs("div",{children:[t.jsxs("div",{className:"flex justify-between items-center mb-1",children:[t.jsx("label",{className:"block text-sm font-medium text-slate-600",children:"סנן לפי קבוצה:"}),t.jsx("button",{onClick:Ne,className:"text-xs text-sky-600 hover:underline",children:j.length===P.length?"בטל הכל":"בחר הכל"})]}),t.jsx("div",{className:"max-h-32 overflow-y-auto border rounded-md p-2 space-y-1 bg-white",children:P.map(e=>t.jsxs("label",{className:"flex items-center gap-2 p-1 hover:bg-slate-100 rounded",children:[t.jsx("input",{type:"checkbox",className:"form-checkbox",checked:j.includes(e),onChange:()=>ke(e)}),e==="__none__"?"ללא קבוצה":e]},e))})]})]}),t.jsx("button",{onClick:ve,className:"text-sm text-sky-600 hover:underline",children:v.length>0&&v.every(e=>p.includes(e.id))?"בטל בחירת הכל":"בחר הכל"}),t.jsx("div",{className:"max-h-[40vh] overflow-y-auto space-y-2 p-1 border rounded-md",children:v.map(e=>t.jsxs("label",{className:"flex items-center gap-3 p-2 hover:bg-slate-50 rounded-md cursor-pointer",children:[t.jsx("input",{type:"checkbox",className:"w-4 h-4 text-sky-600 rounded focus:ring-sky-500",checked:p.includes(e.id),onChange:s=>{s.target.checked?N(r=>[...r,e.id]):N(r=>r.filter(a=>a!==e.id))}}),t.jsxs("div",{className:"flex-grow",children:[t.jsx("span",{children:e.name}),t.jsxs("span",{className:"text-xs text-slate-500 block",children:[e.group||"ללא קבוצה"," / ",new Date(e.startDate||e.uploadedAt||e.createdAt).getFullYear()]})]})]},e.id))}),t.jsxs("div",{className:"flex justify-end gap-2 pt-4 mt-2 border-t",children:[t.jsx("button",{onClick:()=>_(!1),className:"btn-secondary",children:"ביטול"}),t.jsxs("button",{onClick:ye,disabled:p.length===0,className:"btn-primary",children:["הפק PDF (",p.length,")"]})]})]})}),t.jsx("style",{children:`.btn-secondary { padding: 0.5rem 1rem; background-color: #f1f5f9; color: #334155; border: 1px solid #cbd5e1; border-radius: 0.375rem; font-weight: 500; } .select-class { appearance-none; background-color: #fff; border: 1px solid #cbd5e1; border-radius: 0.375rem; padding: 0.5rem 2.5rem 0.5rem 0.75rem; font-size: 0.875rem; color: #334155; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: left 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; } .rtl .select-class { background-position: right 0.5rem center; padding: 0.5rem 0.75rem 0.5rem 2.5rem; } .btn-primary { padding: 0.5rem 1rem; background-color: #0284c7; color: white; border-radius: 0.375rem; font-weight: 500; } .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; } .form-checkbox { border-radius: 0.25rem; border-color: #94a3b8; color: #0284c7; } .form-checkbox:focus { ring-color: #38bdf8; }`})]})};export{lt as default};
