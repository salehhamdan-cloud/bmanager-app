import{u as C,h as E,r as d,ao as S,ai as $,j as e,a as A,A as R,ad as L,L as m,S as y,p as v,$ as M,X as O}from"./index-D-cHbBwn.js";import{e as B}from"./pdfService-D-0A9fw7.js";import{f as G}from"./dateFormatter-CUKId3Gl.js";const f=({status:r,label:i,filter:l,setFilter:x})=>e.jsx("button",{onClick:()=>x(r),className:`px-4 py-1.5 rounded-md text-sm font-medium transition-colors ${l===r?"bg-sky-600 text-white shadow":"bg-white text-slate-700 hover:bg-slate-100"}`,children:i}),X=()=>{const{addToast:r}=C(),{settings:i}=E(),[l,x]=d.useState([]),[h,F]=d.useState([]),[P,j]=d.useState(!0),[c,g]=d.useState("pending"),b=d.useCallback(async()=>{j(!0);try{const[s,a]=await Promise.all([S(),$()]);x(s.sort((t,u)=>new Date(u.createdAt).getTime()-new Date(t.createdAt).getTime()));const n=new Date;n.setHours(0,0,0,0);const o=a.filter(t=>t.dueDate&&new Date(t.dueDate)<n);F(o.sort((t,u)=>new Date(t.dueDate).getTime()-new Date(u.dueDate).getTime()))}catch(s){console.error("Error fetching checklist data:",s),r("שגיאה בטעינת רשימת התקלות","error")}finally{j(!1)}},[r]);d.useEffect(()=>{b()},[b]);const k=async()=>{r("מכין PDF...","info");let s=[...l];if(i.pdfDateRangeStart||i.pdfDateRangeEnd){const a=i.pdfDateRangeStart?new Date(i.pdfDateRangeStart).getTime():0,n=i.pdfDateRangeEnd?new Date(i.pdfDateRangeEnd).getTime()+(1440*60*1e3-1):1/0;s=l.filter(o=>{if(!o.reportDate)return!1;const t=new Date(o.reportDate).getTime();return t>=a&&t<=n}),r("מסנן דוחות PDF לפי טווח תאריכים","info")}try{await B({settings:i,problems:s}),r("PDF נוצר והורד בהצלחה","success")}catch(a){console.error("Error generating checklist PDF:",a),r("שגיאה ביצירת PDF","error")}},T=async s=>{const a={...s,isFixed:!s.isFixed};x(n=>n.map(o=>o.id===s.id?{...o,isFixed:a.isFixed}:o));try{await O(a),r(a.isFixed?"התקלה סומנה כמתוקנת":"התקלה סומנה כלא מתוקנת","success")}catch{x(o=>o.map(t=>t.id===s.id?{...t,isFixed:s.isFixed}:t)),r("שגיאה בעדכון סטטוס התקלה","error")}},I=s=>"reportTitle"in s,w=d.useMemo(()=>{const s=l.filter(n=>!n.isFixed),a=l.filter(n=>n.isFixed);return c==="fixed"?a:c==="pending"?[...h,...s]:[...h,...s,...a]},[l,h,c]),N=d.useMemo(()=>l.filter(s=>s.isFixed).length,[l]),p=l.length,D=p>0?N/p*100:0;return P?e.jsx(A,{text:"טוען רשימת תקלות..."}):e.jsxs("div",{className:"animate-fadeIn space-y-6",children:[e.jsxs("section",{className:"bg-white p-4 rounded-lg shadow-md border",children:[e.jsxs("div",{className:"flex justify-between items-center flex-wrap gap-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-slate-800",children:"רשימת תקלות כללית"}),e.jsx("p",{className:"text-slate-500",children:"כל התקלות הפתוחות והקבצים שפג תוקפם מכל הבניינים"})]}),e.jsxs("button",{onClick:k,className:"bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg shadow flex items-center transition-colors",children:[e.jsx(R,{className:"w-5 h-5 me-2 rtl:ml-2"}),"יצא PDF"]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("span",{className:"text-sm font-medium text-slate-600",children:"התקדמות טיפול"}),e.jsxs("span",{className:"text-sm font-bold text-sky-600",children:[N," / ",p," (",D.toFixed(0),"%)"]})]}),e.jsx("div",{className:"w-full bg-slate-200 rounded-full h-2.5",children:e.jsx("div",{className:"bg-sky-500 h-2.5 rounded-full",style:{width:`${D}%`}})})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(f,{status:"pending",label:"לטיפול",filter:c,setFilter:g}),e.jsx(f,{status:"fixed",label:"טופלו",filter:c,setFilter:g}),e.jsx(f,{status:"all",label:"הכל",filter:c,setFilter:g})]}),w.length===0?e.jsx("div",{className:"text-center py-10 bg-white rounded-lg shadow",children:e.jsx("p",{className:"text-slate-500 text-lg",children:c==="fixed"?"לא נמצאו תקלות שטופלו.":"כל הכבוד! אין תקלות או קבצים לטיפול."})}):e.jsx("div",{className:"space-y-3",children:w.map(s=>I(s)?e.jsxs("div",{className:"bg-white shadow-sm rounded-lg flex items-center p-3 gap-4 border border-slate-200/60",children:[e.jsx("button",{onClick:()=>T(s),className:"flex-shrink-0 w-8 h-8 rounded-full border-2 flex items-center justify-center cursor-pointer group hover:bg-green-50",title:s.isFixed?"סמן כלא תוקן":"סמן כתוקן",children:s.isFixed?e.jsx(L,{className:"w-7 h-7 text-green-500"}):e.jsx("div",{className:"w-4 h-4 rounded-full bg-slate-200 group-hover:bg-green-300"})}),e.jsxs("div",{className:"flex-grow min-w-0",children:[e.jsx("p",{className:"font-semibold text-slate-800",children:s.description}),e.jsxs("p",{className:"text-sm text-slate-500",children:["בניין: ",e.jsx(m,{to:`/project/${s.projectId}`,className:"text-sky-600 hover:underline",children:s.projectName})]})]}),e.jsx("span",{className:`px-2 py-1 text-xs font-semibold rounded-full whitespace-nowrap ${y[s.severity].bg} ${y[s.severity].text}`,children:s.severity}),e.jsx(m,{to:`/project/${s.projectId}/report/${s.reportId}/problem/${s.id}/edit`,className:"p-2 text-slate-500 hover:text-sky-600 rounded-full hover:bg-sky-50",children:e.jsx(v,{className:"w-5 h-5"})})]},s.id):e.jsxs("div",{className:"bg-orange-50 border-orange-200 shadow-sm rounded-lg flex items-center p-3 gap-4 border",children:[e.jsx("div",{className:"flex-shrink-0 text-orange-500",children:e.jsx(M,{className:"w-6 h-6"})}),e.jsxs("div",{className:"flex-grow min-w-0",children:[e.jsxs("p",{className:"font-semibold text-orange-800",children:["פג תוקף: ",s.name]}),e.jsxs("p",{className:"text-sm text-orange-700 truncate",children:["בניין: ",e.jsx(m,{to:`/project/${s.projectId}`,className:"hover:underline",children:s.projectName})," | תוקף עד: ",G(s.dueDate)]})]}),e.jsx(m,{to:`/project/${s.projectId}/files`,className:"p-2 text-orange-600 hover:text-orange-800 rounded-full hover:bg-orange-100",children:e.jsx(v,{className:"w-5 h-5"})})]},s.id))})]})};export{X as default};
