import{r as o,u as _,h as q,a$ as G,g as K,j as s,a as R,p as V,P as B,A as W,af as H,T as J,b0 as E,l as Q,e as X,z as Y}from"./index-D-cHbBwn.js";import{C as Z}from"./CollapsibleSection-F92uqtdU.js";import{W as ee,a as se,A as te}from"./WorkerDetailsModal-BtMYlDHh.js";import{q as re}from"./pdfService-D-0A9fw7.js";import{e as oe}from"./exportUtils-Bak1EFUX.js";import"./ImageUploader-QK9p397g.js";import"./imageService-DERf2zoE.js";import"./AnnotationEditor-CCeRCJQ5.js";import"./shareUtils-BhFQGnPw.js";import"./ContactIcons-B1NAvYGF.js";import"./dateFormatter-CUKId3Gl.js";const he=()=>{const[c,I]=o.useState([]),[x,v]=o.useState([]),[S,k]=o.useState(!0),{addToast:a}=_(),{settings:P}=q(),[D,f]=o.useState(!1),[M,h]=o.useState(null),[b,w]=o.useState(null),[u,L]=o.useState(""),[l,T]=o.useState(!1),[p,y]=o.useState({}),n=Object.keys(p).length,m=o.useCallback(async()=>{k(!0);try{const[e,t]=await Promise.all([G(),K()]);I(e),v(t)}catch{a("שגיאה בטעינת עובדים","error")}finally{k(!1)}},[a]);o.useEffect(()=>{m()},[m]),o.useEffect(()=>{l||y({})},[l]);const N=(e=null)=>{h(e?{...e}:{projectId:x.length===1?x[0].id:""}),f(!0)},A=async e=>{if(window.confirm(`האם למחוק את העובד "${e.name}"?`))try{await E([e]),a("העובד נמחק","success"),m()}catch{a("שגיאה במחיקת העובד","error")}},$=async e=>{if(!e.projectId||!e.name?.trim()){a("יש לבחור בניין ולהזין שם עובד","warning");return}const t=await Q(e.projectId);if(!t){a("הבניין הנבחר לא נמצא","error");return}const{projectId:r,...i}=e;let j;if(i.id)j=(t.workers||[]).map(d=>d.id===i.id?{...d,...i}:d);else{const d={...i,id:i.id||X()};j=[...t.workers||[],d]}try{await Y({...t,workers:j}),a(i.id?"העובד עודכן":"העובד נוסף","success"),f(!1),h(null),m()}catch{a("שגיאה בשמירת העובד","error")}},C=o.useMemo(()=>{if(!u)return c;const e=u.toLowerCase();return c.filter(t=>t.name.toLowerCase().includes(e)||t.phone.toLowerCase().includes(e)||t.email.toLowerCase().includes(e)||t.idNumber?.toLowerCase().includes(e)||t.workerNumber?.toLowerCase().includes(e)||t.projectName.toLowerCase().includes(e))},[c,u]),g=o.useMemo(()=>C.reduce((e,t)=>{const r=t.projectName;return e[r]||(e[r]={projectId:t.projectId,workers:[]}),e[r].workers.push(t),e},{}),[C]),O=o.useMemo(()=>Object.keys(g).sort((e,t)=>e.localeCompare(t,"he")),[g]),z=async()=>{if(n!==0&&window.confirm(`האם למחוק ${n} עובדים נבחרים?`)){const e=c.filter(t=>p[t.id]);try{await E(e),a(`${n} עובדים נמחקו`,"success"),y({}),m()}catch{a("שגיאה במחיקת עובדים","error")}}},F=()=>{const e=l&&n>0?c.filter(t=>p[t.id]):c;if(e.length===0){a("לא נבחרו עובדים לייצוא.","warning");return}a("מכין PDF...","info"),re({settings:P,workers:e})},U=()=>{const e=l&&n>0?c.filter(r=>p[r.id]):c;if(e.length===0){a("לא נבחרו עובדים לייצוא.","warning");return}const t=e.map(r=>({בניין:r.projectName,שם:r.name,"ת.ז":r.idNumber,"מספר עובד":r.workerNumber,טלפון:r.phone,מייל:r.email,כתובת:r.address}));oe(t,"all_workers_list"),a("קובץ Excel יוצא...","success")};return S?s.jsx(R,{text:"טוען עובדים..."}):s.jsxs("div",{className:"space-y-6",children:[s.jsxs("div",{className:"flex justify-between items-center",children:[s.jsx("h1",{className:"text-2xl font-bold text-slate-800",children:"כל עובדי התחזוקה"}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs("button",{onClick:()=>T(!l),className:`btn-secondary text-sm flex items-center gap-2 ${l?"bg-sky-100 text-sky-700 ring-2 ring-sky-200":""}`,children:[s.jsx(V,{className:"w-4 h-4"})," ",l?"סיום עריכה":"ערוך"]}),s.jsxs("button",{onClick:()=>N(),className:"btn-primary flex items-center gap-2 text-sm",children:[s.jsx(B,{className:"w-4 h-4"})," הוסף עובד"]})]})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs("button",{onClick:F,className:"btn-secondary text-sm flex items-center gap-2",children:[s.jsx(W,{className:"w-4 h-4"}),"יצא ל-PDF ",l&&n>0&&`(${n})`]}),s.jsxs("button",{onClick:U,className:"btn-secondary text-sm flex items-center gap-2",children:[s.jsx(W,{className:"w-4 h-4"}),"יצא ל-Excel ",l&&n>0&&`(${n})`]})]}),s.jsxs("div",{className:"relative my-4",children:[s.jsx("span",{className:"absolute inset-y-0 left-0 flex items-center pl-3 rtl:right-0 rtl:pl-0 rtl:pr-3",children:s.jsx(H,{className:"w-5 h-5 text-slate-400"})}),s.jsx("input",{type:"search",placeholder:"חיפוש עובדים...",value:u,onChange:e=>L(e.target.value),className:"w-full pl-10 pr-4 py-2 rtl:pr-10 rtl:pl-4 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500"})]}),c.length===0?s.jsx("div",{className:"text-center p-10 bg-white rounded-lg shadow border",children:s.jsx("p",{className:"text-slate-500",children:"לא נמצאו עובדים."})}):s.jsx("div",{className:"space-y-4",children:O.map(e=>{const t=g[e];return s.jsx(Z,{count:t.workers.length,title:s.jsx("h3",{className:"text-xl font-semibold",children:e}),children:s.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:t.workers.map(r=>s.jsx(ee,{worker:r,onSelect:()=>w(r),onEdit:()=>N(r),onDelete:()=>A(r)},r.id))})},e)})}),l&&n>0&&s.jsxs("div",{className:"fixed bottom-24 inset-x-4 z-40 bg-slate-800 text-white rounded-lg shadow-lg p-4 flex justify-between items-center animate-fadeInUp",children:[s.jsxs("span",{children:[n," עובדים נבחרו"]}),s.jsxs("button",{onClick:z,className:"flex items-center gap-2 px-3 py-1.5 bg-red-500 hover:bg-red-600 rounded-md text-sm font-medium",children:[s.jsx(J,{className:"w-5 h-5"})," מחק נבחרים"]})]}),s.jsx(se,{isOpen:!!b,onClose:()=>w(null),worker:b}),s.jsx(te,{isOpen:D,onClose:()=>f(!1),onSave:$,worker:M,projects:x}),s.jsx("style",{children:`
                .btn-primary { padding: 0.5rem 1rem; background-color: #0284c7; color: white; border-radius: 0.375rem; font-weight: 500; }
                .btn-secondary { padding: 0.5rem 1rem; background-color: #f1f5f9; color: #334155; border: 1px solid #cbd5e1; border-radius: 0.375rem; font-weight: 500; }
            `})]})};export{he as default};
