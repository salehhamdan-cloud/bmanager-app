import{r as c,u as ie,h as de,aA as pe,g as me,j as e,a as $,p as F,P as ue,A as O,af as he,T as G,M as z,aB as R,l as U,e as _,z as B}from"./index-BU7E-q7q.js";import{C as xe}from"./CollapsibleSection-BbrEhqCk.js";import{e as fe}from"./exportUtils-Bak1EFUX.js";import{S as ge,a as je}from"./aiService-DenQ8rOv.js";import{c as be}from"./pdfUtils-CkvU2BMR.js";import{m as ye}from"./pdfService-Th-ePIZW.js";import{P as Ne,E as we}from"./ContactIcons-BhgvhBQE.js";import"./dateFormatter-CUKId3Gl.js";const Ee=()=>{const[u,K]=c.useState([]),[h,V]=c.useState([]),[W,S]=c.useState(!0),{addToast:o}=ie(),{settings:q}=de(),[H,T]=c.useState(!1),P=c.useRef(null),[b,A]=c.useState([]),[J,y]=c.useState(!1),[N,E]=c.useState(""),[Q,w]=c.useState(!1),[r,d]=c.useState(null),[v,X]=c.useState(""),[i,Y]=c.useState(!1),[x,C]=c.useState({}),p=Object.keys(x).length,g=c.useCallback(async()=>{S(!0);try{const[s,t]=await Promise.all([pe(),me()]);K(s),V(t)}catch{o("שגיאה בטעינת דיירים","error")}finally{S(!1)}},[o]);c.useEffect(()=>{g()},[g]),c.useEffect(()=>{i||C({})},[i]);const D=(s=null)=>{d(s?{...s}:{projectId:h.length===1?h[0].id:""}),w(!0)},Z=async s=>{if(window.confirm(`האם אתה בטוח שברצונך למחוק את הדייר "${s.name}"?`))try{await R([s]),o("הדייר נמחק בהצלחה","success"),g()}catch{o("שגיאה במחיקת הדייר","error")}},ee=async()=>{if(!r||!r.projectId||!r.name?.trim()){o("יש לבחור בניין ולהזין שם דייר","warning");return}const s=await U(r.projectId);if(!s){o("הבניין הנבחר לא נמצא","error");return}let t;if(r.id){const{projectId:l,projectName:n,...m}=r;t=(s.tenants||[]).map(f=>f.id===m.id?{...f,...m}:f)}else{const l={id:_(),name:r.name.trim(),phone:r.phone||"",email:r.email||"",building:r.building||"",floor:r.floor||"",officeNumber:r.officeNumber||"",officeSpace:r.officeSpace||"",companyId:r.companyId||""};t=[...s.tenants||[],l]}const a={...s,tenants:t,updatedAt:new Date().toISOString()};try{await B(a),o(r.id?"הדייר עודכן בהצלחה!":"הדייר נוסף בהצלחה!","success"),w(!1),d(null),g()}catch{o("שגיאה בשמירת הדייר","error")}},se=()=>{const s=p>0&&i?u.filter(a=>x[a.id]):u;if(s.length===0){o("לא נבחרו דיירים לייצוא","warning");return}const t=s.map(a=>({בניין:a.projectName,שם:a.name,טלפון:a.phone,מייל:a.email,אגף:a.building,קומה:a.floor,משרד:a.officeNumber,שטח:a.officeSpace,"ח.פ":a.companyId||""}));fe(t,p>0&&i?"selected_tenants_list":"all_tenants_list")},te=()=>{const s=p>0&&i?u.filter(t=>x[t.id]):u;if(s.length===0){o("לא נבחרו דיירים לייצוא","warning");return}o("מכין PDF...","info");try{ye({settings:q,tenants:s})}catch(t){o("שגיאה ביצירת PDF","error"),console.error("PDF generation failed:",t)}},ae=()=>{P.current?.click()},ne=async s=>{const t=s.target.files?.[0];if(t){T(!0),o("מעבד קובץ דיירים...","info");try{let a="";const l=new FileReader;if(t.type==="application/pdf"){const m=await new Promise((f,j)=>{l.onload=I=>f(I.target?.result),l.onerror=I=>j(I),l.readAsDataURL(t)});a=await be(m)}else if(t.type==="text/csv")a=await new Promise((m,f)=>{l.onload=j=>m(j.target?.result),l.onerror=j=>f(j),l.readAsText(t)});else throw new Error("סוג קובץ לא נתמך. יש להעלות PDF או CSV.");const n=await je(a);if(n.length===0){o("לא נמצאו דיירים בקובץ.","warning");return}A(n),E(h.length===1?h[0].id:""),y(!0)}catch(a){o(a instanceof Error?a.message:"שגיאה ביבוא הדיירים","error")}finally{T(!1),s.target&&(s.target.value="")}}},re=async()=>{if(!N||b.length===0){o("יש לבחור בניין","warning");return}const s=await U(N);if(!s){o("בניין לא נמצא","error");return}const t=b.map(l=>({id:_(),name:l.name||"N/A",phone:l.phone||"",email:l.email||"",building:l.building||"",floor:l.floor||"",officeNumber:l.officeNumber||"",officeSpace:l.officeSpace||"",companyId:l.companyId||""})),a={...s,tenants:[...s.tenants||[],...t],updatedAt:new Date().toISOString()};try{await B(a),o(`${t.length} דיירים נוספו בהצלחה לבניין "${s.name}"!`,"success"),y(!1),A([]),g()}catch{o("שגיאה בשמירת הדיירים","error")}},L=c.useMemo(()=>{if(!v)return u;const s=v.toLowerCase();return u.filter(t=>t.name.toLowerCase().includes(s)||t.phone.toLowerCase().includes(s)||t.email.toLowerCase().includes(s)||t.building.toLowerCase().includes(s)||t.floor.toLowerCase().includes(s)||t.officeNumber.toLowerCase().includes(s)||t.companyId?.toLowerCase().includes(s)||t.projectName.toLowerCase().includes(s))},[u,v]),k=c.useMemo(()=>L.reduce((s,t)=>{const a=t.projectName;return s[a]||(s[a]={projectId:t.projectId,tenants:[]}),s[a].tenants.push(t),s},{}),[L]),le=c.useMemo(()=>Object.keys(k).sort((s,t)=>s.localeCompare(t,"he")),[k]),oe=(s,t)=>{C(a=>{const l={...a};return s.forEach(n=>{t?l[n.id]=!0:delete l[n.id]}),l})},M=s=>{C(t=>{const a={...t};return a[s]?delete a[s]:a[s]=!0,a})},ce=async()=>{if(p!==0&&window.confirm(`האם למחוק ${p} דיירים נבחרים?`)){const s=u.filter(t=>x[t.id]);try{await R(s),o(`${p} דיירים נמחקו`,"success"),C({}),g()}catch{o("שגיאה במחיקת דיירים","error")}}};return W?e.jsx($,{text:"טוען דיירים..."}):e.jsxs("div",{className:"space-y-6",children:[H&&e.jsx("div",{className:"fixed inset-0 bg-slate-900 bg-opacity-60 backdrop-blur-sm z-[1001] flex items-center justify-center",children:e.jsx($,{text:"מייבא דיירים בעזרת AI..."})}),e.jsx("input",{type:"file",ref:P,onChange:ne,accept:"application/pdf,text/csv",className:"hidden"}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h1",{className:"text-2xl font-bold text-slate-800",children:"כל הדיירים"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:()=>Y(!i),className:`btn-secondary text-sm flex items-center gap-2 ${i?"bg-sky-100 text-sky-700 ring-2 ring-sky-200":""}`,children:[e.jsx(F,{className:"w-4 h-4"})," ",i?"סיום עריכה":"ערוך"]}),e.jsxs("button",{onClick:()=>D(),className:"btn-primary text-sm flex items-center gap-2",children:[e.jsx(ue,{className:"w-4 h-4"})," הוסף דייר"]}),e.jsxs("button",{onClick:ae,className:"btn-secondary text-sm flex items-center gap-2",children:[e.jsx(ge,{className:"w-4 h-4 text-purple-500"})," יבא"]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:te,className:"btn-secondary text-sm flex items-center gap-2",children:[e.jsx(O,{className:"w-4 h-4"})," יצא ל-PDF ",i&&p>0&&`(${p})`]}),e.jsxs("button",{onClick:se,className:"btn-secondary text-sm flex items-center gap-2",children:[e.jsx(O,{className:"w-4 h-4"})," יצא ל-Excel ",i&&p>0&&`(${p})`]})]}),e.jsxs("div",{className:"relative my-4",children:[e.jsx("span",{className:"absolute inset-y-0 left-0 flex items-center pl-3 rtl:right-0 rtl:pl-0 rtl:pr-3",children:e.jsx(he,{className:"w-5 h-5 text-slate-400"})}),e.jsx("input",{type:"search",placeholder:"חיפוש דיירים...",value:v,onChange:s=>X(s.target.value),className:"w-full pl-10 pr-4 py-2 rtl:pr-10 rtl:pl-4 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500"})]}),u.length===0?e.jsx("div",{className:"text-center p-10 bg-white rounded-lg shadow border",children:e.jsx("p",{className:"text-slate-500",children:"לא נמצאו דיירים."})}):e.jsx("div",{className:"space-y-4",children:le.map(s=>{const a=k[s].tenants,l=a.length>0&&a.every(n=>x[n.id]);return e.jsx(xe,{count:a.length,title:e.jsxs("div",{className:"flex items-center gap-3",children:[i&&e.jsx("input",{type:"checkbox",className:"form-checkbox h-5 w-5 rounded text-sky-600 focus:ring-sky-500",checked:l,onChange:n=>oe(a,n.target.checked),onClick:n=>n.stopPropagation()}),e.jsx("h3",{className:"text-xl font-semibold",children:s})]}),children:e.jsx("div",{className:"space-y-3",children:a.map(n=>e.jsxs("div",{className:`bg-white p-4 rounded-lg shadow-sm border flex items-center gap-4 transition-all duration-200 ${i?"cursor-pointer":""} ${x[n.id]?"bg-sky-50 border-sky-300 ring-2 ring-sky-200":"hover:shadow-md hover:border-sky-200"}`,onClick:i?()=>M(n.id):void 0,children:[i&&e.jsx("input",{type:"checkbox",className:"form-checkbox h-5 w-5 rounded text-sky-600 focus:ring-sky-500 flex-shrink-0",checked:!!x[n.id],onChange:()=>M(n.id),onClick:m=>m.stopPropagation()}),e.jsxs("div",{className:"flex-grow grid grid-cols-2 md:grid-cols-4 gap-x-4 gap-y-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-bold text-slate-800 text-base",children:n.name}),n.companyId&&e.jsxs("p",{className:"text-xs text-slate-500",children:["ח.פ: ",n.companyId]})]}),e.jsxs("div",{children:[e.jsxs("p",{className:"flex items-center gap-2",children:[e.jsx(Ne,{className:"w-4 h-4 text-slate-400"})," ",e.jsx("a",{href:`tel:${n.phone}`,className:"text-sky-600 hover:underline",children:n.phone})]}),e.jsxs("p",{className:"flex items-center gap-2 truncate",children:[e.jsx(we,{className:"w-4 h-4 text-slate-400"})," ",e.jsx("a",{href:`mailto:${n.email}`,className:"text-sky-600 hover:underline truncate",children:n.email})]})]}),e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"אגף:"})," ",n.building||"-"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"קומה:"})," ",n.floor||"-"]})]}),e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"משרד:"})," ",n.officeNumber||"-"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"שטח:"})," ",n.officeSpace||"-"]})]})]}),i&&e.jsxs("div",{className:"flex-shrink-0 flex items-center gap-2",children:[e.jsx("button",{onClick:m=>{m.stopPropagation(),D(n)},className:"p-1.5 text-slate-500 hover:bg-slate-100 rounded-full",children:e.jsx(F,{className:"w-4 h-4"})}),e.jsx("button",{onClick:m=>{m.stopPropagation(),Z(n)},className:"p-1.5 text-red-500 hover:bg-red-100 rounded-full",children:e.jsx(G,{className:"w-4 h-4"})})]})]},n.id))})},s)})}),i&&p>0&&e.jsxs("div",{className:"fixed bottom-24 inset-x-4 z-40 bg-slate-800 text-white rounded-lg shadow-lg p-4 flex justify-between items-center animate-fadeInUp",children:[e.jsxs("span",{children:[p," דיירים נבחרו"]}),e.jsxs("button",{onClick:ce,className:"flex items-center gap-2 px-3 py-1.5 bg-red-500 hover:bg-red-600 rounded-md text-sm font-medium",children:[e.jsx(G,{className:"w-5 h-5"})," מחק נבחרים"]})]}),e.jsx(z,{isOpen:J,onClose:()=>y(!1),title:`יבא ${b.length} דיירים`,children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("p",{children:["נמצאו ",b.length," דיירים בקובץ. לאיזה בניין תרצה לשייך אותם?"]}),e.jsxs("select",{value:N,onChange:s=>E(s.target.value),className:"input-class w-full",children:[e.jsx("option",{value:"",disabled:!0,children:"בחר בניין..."}),h.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4",children:[e.jsx("button",{onClick:()=>y(!1),className:"btn-secondary",children:"ביטול"}),e.jsx("button",{onClick:re,disabled:!N,className:"btn-primary",children:"יבא דיירים"})]})]})}),e.jsx(z,{isOpen:Q,onClose:()=>w(!1),title:r?.id?"עריכת דייר":"הוספת דייר חדש",size:"lg",children:r&&e.jsxs("div",{className:"space-y-4",children:[h.length>1&&e.jsxs("div",{children:[e.jsx("label",{className:"label-class",children:"בניין"}),e.jsxs("select",{value:r.projectId||"",onChange:s=>d(t=>({...t,projectId:s.target.value})),className:"input-class w-full",children:[e.jsx("option",{value:"",disabled:!0,children:"בחר בניין..."}),h.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsx("input",{type:"text",placeholder:"שם",value:r.name||"",onChange:s=>d(t=>({...t,name:s.target.value})),className:"input-class"}),e.jsx("input",{type:"tel",placeholder:"טלפון",value:r.phone||"",onChange:s=>d(t=>({...t,phone:s.target.value})),className:"input-class"}),e.jsx("input",{type:"email",placeholder:"אימייל",value:r.email||"",onChange:s=>d(t=>({...t,email:s.target.value})),className:"input-class"}),e.jsx("input",{type:"text",placeholder:"ח.פ",value:r.companyId||"",onChange:s=>d(t=>({...t,companyId:s.target.value})),className:"input-class"}),e.jsx("input",{type:"text",placeholder:"מבנה/אגף",value:r.building||"",onChange:s=>d(t=>({...t,building:s.target.value})),className:"input-class"}),e.jsx("input",{type:"text",placeholder:"קומה",value:r.floor||"",onChange:s=>d(t=>({...t,floor:s.target.value})),className:"input-class"}),e.jsx("input",{type:"text",placeholder:"מספר משרד",value:r.officeNumber||"",onChange:s=>d(t=>({...t,officeNumber:s.target.value})),className:"input-class"}),e.jsx("input",{type:"text",placeholder:"שטח משרד (לדוגמה: 150 מ״ר)",value:r.officeSpace||"",onChange:s=>d(t=>({...t,officeSpace:s.target.value})),className:"input-class"})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4",children:[e.jsx("button",{onClick:()=>w(!1),className:"btn-secondary",children:"ביטול"}),e.jsx("button",{onClick:ee,className:"btn-primary",children:"שמור"})]})]})}),e.jsx("style",{children:`
                .label-class { display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 500; color: #334155; }
                .input-class { display: block; width: 100%; border: 1px solid #cbd5e1; border-radius: 0.375rem; padding: 0.5rem 0.75rem; }
                .btn-primary { padding: 0.5rem 1rem; background-color: #0284c7; color: white; border-radius: 0.375rem; font-weight: 500; }
                .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }
                .btn-secondary { padding: 0.5rem 1rem; background-color: #f1f5f9; color: #334155; border: 1px solid #cbd5e1; border-radius: 0.375rem; font-weight: 500; }
            `})]})};export{Ee as default};
