import{k as B,u as M,h as O,r as i,l as G,b as H,o as V,j as t,a as X,A as Y,ad as _,L as N,S as I,p as T,$ as q,X as z}from"./index-BU7E-q7q.js";import{a as J}from"./pdfService-Th-ePIZW.js";import{f as K}from"./dateFormatter-CUKId3Gl.js";const y=({status:c,label:n,filter:l,setFilter:p})=>t.jsx("button",{onClick:()=>p(c),className:`px-4 py-1.5 rounded-md text-sm font-medium transition-colors ${l===c?"bg-sky-600 text-white shadow":"bg-white text-slate-700 hover:bg-slate-100"}`,children:n}),Z=()=>{const{projectId:c}=B(),{addToast:n}=M(),{settings:l}=O(),[p,E]=i.useState(null),[d,u]=i.useState([]),[g,R]=i.useState([]),[S,D]=i.useState(!0),[x,j]=i.useState("pending"),P=i.useCallback(async()=>{if(c){D(!0);try{const e=await G(c);if(!e)throw new Error("Project not found");E(e);const a=new Date;a.setHours(0,0,0,0);const o=(e.files||[]).filter(r=>r.dueDate&&new Date(r.dueDate)<a).map(r=>({...r,projectId:e.id,projectName:e.name}));R(o.sort((r,h)=>new Date(r.dueDate).getTime()-new Date(h.dueDate).getTime()));const m=(await H(c)).map(r=>V(r.id).then(h=>h.map(A=>({...A,reportTitle:r.title,reportDate:r.date,projectId:e.id,projectName:e.name})))),f=(await Promise.all(m)).flat().sort((r,h)=>new Date(h.createdAt).getTime()-new Date(r.createdAt).getTime());u(f)}catch(e){console.error("Error fetching checklist data:",e),n("שגיאה בטעינת רשימת התקלות","error")}finally{D(!1)}}},[c,n]);i.useEffect(()=>{P()},[P]);const C=async()=>{if(!p)return;n("מכין PDF...","info");let e=[...d];if(l.pdfDateRangeStart||l.pdfDateRangeEnd){const s=l.pdfDateRangeStart?new Date(l.pdfDateRangeStart).getTime():0,m=l.pdfDateRangeEnd?new Date(l.pdfDateRangeEnd).getTime()+(1440*60*1e3-1):1/0;e=d.filter(w=>{if(!w.reportDate)return!1;const f=new Date(w.reportDate).getTime();return f>=s&&f<=m}),n("מסנן דוחות PDF לפי טווח תאריכים","info")}const a=e.filter(s=>!s.isFixed),o=e.filter(s=>s.isFixed);try{await J({settings:l,project:p,problems:e,pendingProblems:a,fixedProblems:o,expiredFiles:g}),n("PDF נוצר והורד בהצלחה","success")}catch(s){console.error("Error generating checklist PDF:",s),n("שגיאה ביצירת PDF","error")}},$=async e=>{const a={...e,isFixed:!e.isFixed};u(o=>o.map(s=>s.id===e.id?{...s,isFixed:a.isFixed}:s));try{await z(a),n(a.isFixed?"התקלה סומנה כמתוקנת":"התקלה סומנה כלא מתוקנת","success")}catch{u(s=>s.map(m=>m.id===e.id?{...m,isFixed:e.isFixed}:m)),n("שגיאה בעדכון סטטוס התקלה","error")}},L=e=>"reportTitle"in e,v=i.useMemo(()=>{const e=d.filter(o=>!o.isFixed),a=d.filter(o=>o.isFixed);return x==="fixed"?a:x==="pending"?[...g,...e]:[...g,...e,...a]},[d,g,x]),F=i.useMemo(()=>d.filter(e=>e.isFixed).length,[d]),b=d.length,k=b>0?F/b*100:0;return S?t.jsx(X,{text:"טוען רשימת תקלות..."}):t.jsxs("div",{className:"animate-fadeIn space-y-6",children:[t.jsxs("section",{className:"bg-white p-4 rounded-lg shadow-md border",children:[t.jsxs("div",{className:"flex justify-between items-center flex-wrap gap-4",children:[t.jsxs("div",{children:[t.jsx("h2",{className:"text-2xl font-bold text-slate-800",children:p?.name}),t.jsx("p",{className:"text-slate-500",children:"רשימת תקלות וקבצים לטיפול"})]}),t.jsxs("button",{onClick:C,className:"bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg shadow flex items-center transition-colors",children:[t.jsx(Y,{className:"w-5 h-5 me-2 rtl:ml-2"}),"יצא PDF"]})]}),t.jsxs("div",{className:"mt-4",children:[t.jsxs("div",{className:"flex justify-between items-center mb-1",children:[t.jsx("span",{className:"text-sm font-medium text-slate-600",children:"התקדמות טיפול"}),t.jsxs("span",{className:"text-sm font-bold text-sky-600",children:[F," / ",b," (",k.toFixed(0),"%)"]})]}),t.jsx("div",{className:"w-full bg-slate-200 rounded-full h-2.5",children:t.jsx("div",{className:"bg-sky-500 h-2.5 rounded-full",style:{width:`${k}%`}})})]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(y,{status:"pending",label:"לטיפול",filter:x,setFilter:j}),t.jsx(y,{status:"fixed",label:"טופלו",filter:x,setFilter:j}),t.jsx(y,{status:"all",label:"הכל",filter:x,setFilter:j})]}),v.length===0?t.jsx("div",{className:"text-center py-10 bg-white rounded-lg shadow",children:t.jsx("p",{className:"text-slate-500 text-lg",children:x==="fixed"?"לא נמצאו תקלות שטופלו.":"כל הכבוד! אין תקלות או קבצים לטיפול."})}):t.jsx("div",{className:"space-y-3",children:v.map(e=>L(e)?t.jsxs("div",{className:"bg-white shadow-sm rounded-lg flex items-center p-3 gap-4 border border-slate-200/60",children:[t.jsx("button",{onClick:()=>$(e),className:"flex-shrink-0 w-8 h-8 rounded-full border-2 flex items-center justify-center cursor-pointer group hover:bg-green-50",title:e.isFixed?"סמן כלא תוקן":"סמן כתוקן",children:e.isFixed?t.jsx(_,{className:"w-7 h-7 text-green-500"}):t.jsx("div",{className:"w-4 h-4 rounded-full bg-slate-200 group-hover:bg-green-300"})}),t.jsxs("div",{className:"flex-grow",children:[t.jsx("p",{className:"font-semibold text-slate-800",children:e.description}),t.jsxs("p",{className:"text-sm text-slate-500",children:["דוח: ",t.jsx(N,{to:`/project/${e.projectId}/report/${e.reportId}`,className:"text-sky-600 hover:underline",children:e.reportTitle})]})]}),t.jsx("span",{className:`px-2 py-1 text-xs font-semibold rounded-full whitespace-nowrap ${I[e.severity].bg} ${I[e.severity].text}`,children:e.severity}),t.jsx(N,{to:`/project/${e.projectId}/report/${e.reportId}/problem/${e.id}/edit`,className:"p-2 text-slate-500 hover:text-sky-600 rounded-full hover:bg-sky-50",children:t.jsx(T,{className:"w-5 h-5"})})]},e.id):t.jsxs("div",{className:"bg-orange-50 border-orange-200 shadow-sm rounded-lg flex items-center p-3 gap-4 border",children:[t.jsx("div",{className:"flex-shrink-0 text-orange-500",children:t.jsx(q,{className:"w-6 h-6"})}),t.jsxs("div",{className:"flex-grow",children:[t.jsxs("p",{className:"font-semibold text-orange-800",children:["פג תוקף: ",e.name]}),t.jsxs("p",{className:"text-sm text-orange-700",children:["תוקף עד: ",K(e.dueDate)]})]}),t.jsx(N,{to:`/project/${e.projectId}/files`,className:"p-2 text-orange-600 hover:text-orange-800 rounded-full hover:bg-orange-100",children:t.jsx(T,{className:"w-5 h-5"})})]},e.id))})]})};export{Z as default};
