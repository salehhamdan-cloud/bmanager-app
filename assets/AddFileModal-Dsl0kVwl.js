import{r,u as A,j as e,M as z,T as W,aS as q,aT as _,a as R,aR as G,ar as K,p as Q,e as E,h as X}from"./index-D-cHbBwn.js";import{a as Y}from"./AnnotationEditor-CCeRCJQ5.js";import{o as Z}from"./pdfService-D-0A9fw7.js";import{R as ee}from"./RecurrenceEditor-rLx-RXEn.js";import{d as te}from"./shareUtils-BhFQGnPw.js";const P=({title:l,active:g,onClick:C,children:h})=>e.jsx("button",{type:"button",title:l,onClick:C,className:`p-2 rounded-lg transition-colors ${g?"bg-sky-600 text-white":"bg-slate-700 text-slate-300 hover:bg-slate-600"}`,children:h}),se=({isOpen:l,onClose:g,onSave:C,initialPages:h})=>{const o=r.useRef(null),{addToast:i}=A(),[c,d]=r.useState([]),[u,j]=r.useState(0),[N,v]=r.useState(null),[b,y]=r.useState(!0),[I,F]=r.useState("select"),[S,T]=r.useState({strokeColor:"#ff0000",strokeWidth:5,fillColor:"transparent"}),[D,w]=r.useState([]),[n,t]=r.useState([[]]),[s,m]=r.useState(0),f=c[u];r.useEffect(()=>{l&&(d(JSON.parse(JSON.stringify(h))),j(0))},[l,h]),r.useEffect(()=>{if(!l||!f){v(null);return}y(!0);const a=new window.Image;a.crossOrigin="Anonymous";const p=()=>{v(a),y(!1);try{const L=JSON.parse(f.annotationData||"[]"),U=Array.isArray(L)?L:[];w(U),t([U]),m(0)}catch{i("Could not load annotations for this page.","warning"),w([]),t([[]]),m(0)}};a.onload=p,a.onerror=()=>{i("Failed to load image for editing.","error"),y(!1)},a.src=f.editedDataUrl||f.originalDataUrl},[f,l,i]);const k=a=>{w(a);const p=n.slice(0,s+1);p.push(a),t(p),m(p.length-1)},x=async()=>{if(!o.current||!f)return!1;o.current.deselectShape();try{const a=await o.current.exportCanvas(),p=JSON.stringify(D);return d(L=>L.map((U,J)=>J===u?{...U,editedDataUrl:a,annotationData:p}:U)),!0}catch(a){return i("Failed to save page annotations.","error"),console.error(a),!1}},M=async a=>{await x()&&a>=0&&a<c.length&&j(a)},B=async()=>{await x()&&setTimeout(()=>{C(c)},50)},H=r.useCallback(()=>{if(s>0){const a=s-1;m(a),w(n[a])}},[n,s]),O=r.useCallback(()=>{if(s<n.length-1){const a=s+1;m(a),w(n[a])}},[n,s]),$=()=>{const a=o.current?.getSelectedShapeId();if(a){const p=D.filter(L=>L.id!==a);k(p),o.current?.deselectShape()}else i("Please select a shape to delete.","info")},V=[{name:"select",title:"Select/Move",icon:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",className:"w-5 h-5",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M15.042 21.672L13.684 16.6m0 0l-2.51 2.225.569-9.47 5.227 7.917-3.286-.672zM12 2.25a.75.75 0 01.75.75v.008l.008.008.008.008v.008l.008.008.008.008.008.008h.008a.75.75 0 010 1.5h-.008l-.008-.008L12 3.75l-.008.008-.008.008-.008.008v.008l-.008.008-.008.008H11.25a.75.75 0 010-1.5h.008l.008-.008.008-.008.008-.008V3a.75.75 0 01.75-.75z"})})},{name:"pencil",title:"Pencil",icon:e.jsx(G,{className:"w-5 h-5"})},{name:"rectangle",title:"Rectangle",icon:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",className:"w-5 h-5",children:[e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M21 12a9 9 0 11-18 0 9 9 0 0118 0z"}),e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M9 9.563C9 9.252 9.252 9 9.563 9h4.874c.311 0 .563.252.563.563v4.874c0 .311-.252.563-.563.563H9.563A.563.563 0 019 14.437V9.563z"})]})},{name:"circle",title:"Circle",icon:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",className:"w-5 h-5",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})})},{name:"arrow",title:"Arrow",icon:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",className:"w-5 h-5",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3"})})},{name:"text",title:"Text",icon:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",className:"w-5 h-5",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M7.5 8.25h9m-9 3H12m-6.75 3h9m-9 3h3.375c.621 0 1.125-.504 1.125-1.125V18.375m-3.375 2.25c.621 0 1.125-.504 1.125-1.125V18.375m-3.375 2.25h13.5m-13.5 0V6.75A2.25 2.25 0 015.25 4.5h9.5A2.25 2.25 0 0117.25 6.75v12.75"})})}];return e.jsx(z,{isOpen:l,onClose:g,title:"Document Editor",size:"full",children:e.jsxs("div",{className:"flex flex-col h-full bg-slate-800",children:[e.jsxs("header",{className:"flex-shrink-0 p-2 bg-slate-900 flex items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[V.map(a=>e.jsx(P,{title:a.title,active:I===a.name,onClick:()=>F(a.name),children:a.icon},a.name)),e.jsx(P,{title:"Delete Selected",active:!1,onClick:$,children:e.jsx(W,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"flex items-center gap-3 text-white",children:[e.jsx("button",{onClick:()=>M(u-1),disabled:u===0,className:"p-2 disabled:opacity-50",children:e.jsx(q,{className:"w-5 h-5"})}),e.jsxs("span",{children:["עמוד ",u+1," / ",c.length]}),e.jsx("button",{onClick:()=>M(u+1),disabled:u===c.length-1,className:"p-2 disabled:opacity-50",children:e.jsx(_,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("label",{className:"flex items-center gap-2 text-sm text-slate-300",children:["Color:",e.jsx("input",{type:"color",value:S.strokeColor,onChange:a=>T(p=>({...p,strokeColor:a.target.value})),className:"bg-transparent border-0 w-8 h-8 p-0"})]}),e.jsx(P,{title:"Undo",active:!1,onClick:H,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",className:"w-5 h-5",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M9 15L3 9m0 0l6-6M3 9h12a6 6 0 010 12h-3"})})}),e.jsx(P,{title:"Redo",active:!1,onClick:O,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",className:"w-5 h-5",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M15 15l6-6m0 0l-6-6m6 6H9a6 6 0 000 12h3"})})})]})]}),e.jsx("main",{className:"flex-grow relative flex items-center justify-center overflow-auto p-4 bg-slate-800",children:b||!N?e.jsx(R,{text:"טוען עמוד..."}):e.jsx(Y,{ref:o,image:N,shapes:D,onShapesChange:k,activeTool:I,toolSettings:S})}),e.jsxs("footer",{className:"flex-shrink-0 p-3 bg-slate-900 flex justify-end gap-3",children:[e.jsx("button",{type:"button",onClick:g,className:"px-4 py-2 text-sm font-medium text-slate-300 bg-slate-700 hover:bg-slate-600 rounded-md",children:"Cancel"}),e.jsx("button",{type:"button",onClick:B,className:"px-6 py-2 text-sm font-medium text-white bg-sky-600 hover:bg-sky-700 rounded-md shadow-sm",children:"Save & Close"})]})]})})},ae=({isOpen:l,onClose:g,onSave:C})=>{const{addToast:h}=A(),o=r.useRef(null),[i,c]=r.useState(null),[d,u]=r.useState([]),[j,N]=r.useState(!0),[v,b]=r.useState(!1),[y,I]=r.useState(`Scanned_Doc_${new Date().toISOString().split("T")[0]}`),F=r.useCallback(async()=>{if(!i){if(N(!0),!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){h("הדפדפן שלך אינו תומך בגישה למצלמה.","error"),g();return}try{if(navigator.permissions&&navigator.permissions.query&&(await navigator.permissions.query({name:"camera"})).state==="denied"){h("הגישה למצלמה נחסמה. יש לאפשר אותה בהגדרות הדפדפן.","error"),g();return}const t=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});c(t),o.current&&(o.current.srcObject=t)}catch(t){let s="שגיאה בגישה למצלמה. יש לוודא שניתנו הרשאות.";t instanceof DOMException&&(t.name==="NotAllowedError"?s="הגישה למצלמה נדחתה. יש לרענן ולאשר גישה.":t.name==="NotFoundError"?s="לא נמצאה מצלמה במכשיר זה.":t.name==="NotReadableError"&&(s="שגיאת חומרה במצלמה. ייתכן שאפליקציה אחרת משתמשת בה.")),console.error("Error accessing camera:",t),h(s,"error"),g()}finally{N(!1)}}},[h,g,i]),S=r.useCallback(()=>{i&&(i.getTracks().forEach(t=>t.stop()),c(null),o.current&&(o.current.srcObject=null))},[i]);r.useEffect(()=>(l?F():(S(),u([])),()=>S()),[l,F,S]);const T=()=>{const t=o.current;if(!t)return;const s=document.createElement("canvas");s.width=t.videoWidth,s.height=t.videoHeight;const m=s.getContext("2d");if(!m)return;m.drawImage(t,0,0,s.width,s.height);const f=s.toDataURL("image/jpeg",.9),k={id:E(),originalDataUrl:f,editedDataUrl:f,annotationData:"[]"};u(x=>[...x,k]),h(`עמוד ${d.length+1} צולם`,"success")},D=t=>{u(s=>s.filter(m=>m.id!==t))},w=t=>{u(t),b(!1)},n=()=>{if(d.length===0){h("יש לצלם לפחות עמוד אחד","warning");return}if(!y.trim()){h("יש להזין שם קובץ","warning");return}C(d,y)};return l?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fixed inset-0 bg-black z-[1000] flex flex-col p-4",role:"dialog","aria-modal":"true",children:[e.jsxs("header",{className:"flex-shrink-0 flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-xl font-semibold text-white",children:"סורק מסמכים"}),e.jsx("button",{onClick:g,className:"px-4 py-2 text-sm font-medium text-black bg-slate-200 hover:bg-slate-300 rounded-md shadow-sm",children:"ביטול"})]}),e.jsxs("main",{className:"flex-grow flex flex-col md:flex-row gap-4 overflow-hidden",children:[e.jsxs("div",{className:"flex-grow bg-slate-800 rounded-lg relative flex items-center justify-center",children:[j&&e.jsx(R,{text:"טוען מצלמה..."}),e.jsx("video",{ref:o,autoPlay:!0,playsInline:!0,muted:!0,className:`w-full h-full object-contain ${j?"hidden":""}`}),!j&&i&&e.jsx("button",{onClick:T,className:"absolute bottom-5 w-16 h-16 bg-white rounded-full border-4 border-slate-400 hover:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2 focus:ring-offset-slate-800 flex items-center justify-center",children:e.jsx(K,{className:"w-8 h-8 text-slate-700"})})]}),e.jsxs("aside",{className:"w-full md:w-64 flex-shrink-0 bg-slate-700 rounded-lg p-3 flex flex-col",children:[e.jsxs("h3",{className:"text-lg font-medium text-white mb-2",children:["עמודים שצולמו (",d.length,")"]}),e.jsxs("div",{className:"flex-grow overflow-y-auto space-y-2 pr-2 -mr-2",children:[d.map((t,s)=>e.jsxs("div",{className:"bg-slate-600 rounded p-2 flex items-center gap-3",children:[e.jsx("img",{src:t.editedDataUrl,alt:`עמוד ${s+1}`,className:"w-12 h-16 object-cover rounded-sm border-2 border-slate-500"}),e.jsxs("span",{className:"text-white font-medium flex-grow",children:["עמוד ",s+1]}),e.jsx("button",{onClick:()=>D(t.id),className:"p-1.5 text-red-300 hover:text-white hover:bg-red-500 rounded-full",children:e.jsx(W,{className:"w-4 h-4"})})]},t.id)),d.length===0&&e.jsx("p",{className:"text-slate-400 text-sm text-center pt-8",children:"עדיין לא צולמו עמודים."})]})]})]}),e.jsxs("footer",{className:"flex-shrink-0 mt-4 pt-4 border-t border-slate-600 flex flex-wrap justify-between items-center gap-4",children:[e.jsx("input",{type:"text",value:y,onChange:t=>I(t.target.value),placeholder:"שם הקובץ (PDF)",className:"input-class bg-slate-800 border-slate-600 text-white px-3 py-2 rounded-md focus:ring-sky-500 focus:border-sky-500"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("button",{onClick:()=>b(!0),disabled:d.length===0,className:"btn-secondary disabled:opacity-50 flex items-center gap-2",children:[e.jsx(Q,{className:"w-5 h-5"}),"עריכה וחתימה"]}),e.jsx("button",{onClick:n,disabled:d.length===0,className:"btn-primary disabled:opacity-50",children:"שמור כמסמך PDF"})]})]})]}),v&&e.jsx(se,{isOpen:v,onClose:()=>b(!1),onSave:w,initialPages:d}),e.jsx("style",{children:`
                .input-class { border: 1px solid #cbd5e1; border-radius: 0.375rem; }
                .btn-primary { padding: 0.5rem 1rem; background-color: #0284c7; color: white; border-radius: 0.375rem; font-weight: 500; }
                .btn-primary:hover:not(:disabled) { background-color: #0369a1; }
                .btn-secondary { padding: 0.5rem 1rem; background-color: #f1f5f9; color: #334155; border: 1px solid #cbd5e1; border-radius: 0.375rem; font-weight: 500; }
                .btn-secondary:hover:not(:disabled) { background-color: #e2e8f0; }
            `})]}):null},re=l=>e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",...l,children:[e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M6 20.25h12m-7.5-3v3m3-3v3m-10.125-3h14.25c.621 0 1.125-.504 1.125-1.125V9.75c0-.621-.504-1.125-1.125-1.125H3.875c-.621 0-1.125.504-1.125 1.125v6.375c0 .621.504 1.125 1.125 1.125zM12 15.75a.75.75 0 01.75-.75h.008a.75.75 0 01.75.75v.008a.75.75 0 01-.75.75h-.008a.75.75 0 01-.75-.75v-.008z"}),e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M3.375 10.125V7.5c0-1.036.84-1.875 1.875-1.875h.375m13.5 0h.375c1.036 0 1.875.84 1.875 1.875v2.625"})]}),de=({isOpen:l,onClose:g,onSave:C,hideDateFields:h=!1})=>{const[o,i]=r.useState([]),[c,d]=r.useState({}),[u,j]=r.useState(!1),[N,v]=r.useState(!1),{addToast:b}=A(),{settings:y}=X();r.useEffect(()=>{l&&(i([]),d({id:E(),group:"",startDate:new Date().toISOString(),recurrenceType:"one-time",recurrence:{unit:"years",interval:1},duration:{unit:"days",value:30}}))},[l]);const I=n=>{const t=Array.from(n.target.files||[]);t.length>0&&i(s=>[...s,...t])},F=n=>{i(t=>t.filter(s=>s.name!==n))},S=n=>{d(t=>({...t,...n}))},T=async()=>{if(o.length===0){b("יש לבחור לפחות קובץ אחד להעלאה.","warning");return}j(!0);try{const n=await Promise.all(o.map(async t=>{const s=await new Promise((f,k)=>{const x=new FileReader;x.onload=M=>{M.target?.result?f(M.target.result):k(new Error("File reading failed"))},x.onerror=k,x.readAsDataURL(t)}),m={id:E(),name:t.name,mimeType:t.type,dataUrl:s,uploadedAt:new Date().toISOString(),createdAt:new Date().toISOString(),startDate:c.startDate,dueDate:c.dueDate,group:c.group?.trim()||void 0,recurrenceType:c.recurrenceType,recurrence:c.recurrence,duration:c.duration};return m.mimeType.startsWith("image/")&&(m.annotationData="[]",m.originalDataUrl=s),m}));await C(n),w()}catch(n){console.error("Error processing files:",n),b("שגיאה בעיבוד הקבצים","error")}finally{j(!1)}},D=async(n,t)=>{b("יוצר קובץ PDF...","info");try{const s=n.map(x=>x.editedDataUrl),m=await Z(s,t,y),f=t.endsWith(".pdf")?t:`${t}.pdf`,k=await te(m,f);i([k]),d(x=>({...x,name:void 0})),v(!1),b("המסמך הסרוק מוכן להעלאה","success")}catch{b("שגיאה בשמירת המסמך הסרוק","error")}},w=()=>{g()};return e.jsxs(e.Fragment,{children:[e.jsx(z,{isOpen:l,onClose:w,title:"הוספת קבצים חדשים",size:"lg",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label-class",children:"שלב 1: בחר קבצים או סרוק מסמך"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("label",{className:"flex-grow cursor-pointer w-full text-sm text-slate-500 file:mr-4 file:rtl:ml-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100 border border-slate-300 rounded-lg flex items-center justify-center p-2",children:[e.jsx("span",{children:"בחר קבצים..."}),e.jsx("input",{type:"file",onChange:I,className:"hidden",multiple:!0})]}),e.jsxs("button",{type:"button",onClick:()=>v(!0),className:"flex items-center gap-2 px-3 py-1.5 text-sm bg-blue-100 text-blue-800 rounded-md hover:bg-blue-200",children:[e.jsx(re,{className:"w-5 h-5"}),"סרוק"]})]}),o.length>0&&e.jsx("div",{className:"mt-2 space-y-1 max-h-32 overflow-y-auto border p-2 rounded-md",children:o.map((n,t)=>e.jsxs("div",{className:"text-xs flex justify-between items-center bg-slate-100 p-1.5 rounded",children:[e.jsx("span",{children:n.name}),e.jsx("button",{onClick:()=>F(n.name),className:"text-red-500",children:"×"})]},`${n.name}-${t}`))})]}),o.length>0&&e.jsxs("div",{className:"space-y-4 animate-fadeIn",children:[e.jsxs("p",{className:"text-sm text-slate-600",children:["שלב 2: הגדר פרטים (יחול על כל ",o.length," הקבצים)"]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"file-modal-group",className:"label-class",children:"קבוצה (אופציונלי)"}),e.jsx("input",{id:"file-modal-group",name:"file-modal-group",type:"text",value:c.group||"",onChange:n=>d(t=>({...t,group:n.target.value})),className:"input-class w-full"})]}),!h&&e.jsx(ee,{type:"file",details:c,onUpdate:S})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4",children:[e.jsx("button",{type:"button",onClick:w,className:"btn-secondary",disabled:u,children:"ביטול"}),e.jsx("button",{type:"button",onClick:T,className:"btn-primary",disabled:u||o.length===0,children:u?e.jsx(R,{size:"sm"}):`שמור ${o.length} קבצים`})]}),e.jsx("style",{children:".label-class { display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 500; color: #334155; } .input-class { display: block; width: 100%; border: 1px solid #cbd5e1; border-radius: 0.375rem; padding: 0.5rem 0.75rem; } .btn-primary { padding: 0.5rem 1rem; background-color: #0284c7; color: white; border-radius: 0.375rem; font-weight: 500; } .btn-primary:hover:not(:disabled) { background-color: #0369a1; } .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; } .btn-secondary { padding: 0.5rem 1rem; background-color: #f1f5f9; color: #334155; border: 1px solid #cbd5e1; border-radius: 0.375rem; font-weight: 500; } .btn-secondary:hover:not(:disabled) { background-color: #e2e8f0; } .animate-fadeIn { animation: fadeIn 0.3s ease-out; } @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; }}"})]})}),N&&e.jsx(ae,{isOpen:N,onClose:()=>v(!1),onSave:D})]})};export{de as A};
