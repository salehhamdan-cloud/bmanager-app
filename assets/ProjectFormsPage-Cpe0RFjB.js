import{k as _,B as W,r as o,u as V,h as q,l as z,b as H,G as J,m as K,j as t,a as Q,L as U,A as I,P as X,M as Y,ah as Z,e as ee,N as te}from"./index-BU7E-q7q.js";import{P as se}from"./ProjectFormItem-BouZ19kC.js";import{b as re,j as ae}from"./pdfService-Th-ePIZW.js";import{e as S}from"./exportUtils-Bak1EFUX.js";import{a as oe,f as ne}from"./dateFormatter-CUKId3Gl.js";const pe=()=>{const{projectId:c}=_(),v=W(),[n,D]=o.useState(null),[g,T]=o.useState([]),[i,k]=o.useState([]),[w,C]=o.useState([]),[E,N]=o.useState(!0),{addToast:a}=V(),{settings:b}=q(),[A,y]=o.useState(!1),[p,F]=o.useState(""),[f,P]=o.useState(""),x=o.useCallback(async()=>{if(c){N(!0);try{const[e,s,r]=await Promise.all([z(c),H(c),J()]);if(!e){a("Bניין לא נמצא","error"),v("/");return}const h=(await K(c)).map(l=>({form:l,template:r.find(j=>j.id===l.formTemplateId)})).filter(l=>l.template);D(e),T(s),C(r),k(h)}catch{a("שגיאה בטעינת טפסים","error")}finally{N(!1)}}},[c,a,v]);o.useEffect(()=>{x()},[x]);const L=async e=>{if(window.confirm("Are you sure you want to delete this form?"))try{await Z(e),a("Form deleted successfully.","success"),x()}catch{a("Error deleting form.","error")}},O=async()=>{if(!p||!f||!n)return;const e=w.find(r=>r.id===f);if(!e){a("Template not found","error");return}const s={id:ee(),projectId:n.id,reportId:p,formTemplateId:f,formTemplateName:e.name,answers:[],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),formDate:new Date().toISOString()};try{await te(s),a(`Form "${e.name}" added successfully.`,"success"),y(!1),F(""),P(""),x()}catch{a("Error adding form","error")}},$=async e=>{if(!(!n||!b)){a(`מכין PDF עבור טופס: ${e.template.name}...`,"info");try{await ae({settings:b,project:n,formWithTemplate:e}),a("PDF של הטופס נוצר והורד בהצלחה","success")}catch{a("שגיאה ביצירת PDF לטופס","error")}}},R=e=>{const{form:s,template:r}=e;if(!s||!r)return;const u=[];r.groups.forEach(h=>{h.items.forEach(l=>{const j=s.answers.find(G=>G.formItemId===l.id),d=j?.value;let m="-";typeof d=="boolean"?m=d?"כן":"לא":d==="ok"?m="תקין":d==="not-ok"?m="לא תקין":d==="na"?m="לא רלוונטי":d&&(m=String(d)),u.push({קבוצה:h.name,שאלה:l.label,תשובה:m,הערות:j?.description||""})})}),s.reporterComments&&u.push({קבוצה:"סיכום",שאלה:"הערות מדווח",תשובה:s.reporterComments,הערות:""}),s.managerComments&&u.push({קבוצה:"סיכום",שאלה:"הערות מנהל",תשובה:s.managerComments,הערות:""}),S(u,`form_${r.name}_${ne(s.formDate)}`),a("הטופס יוצא לקובץ Excel...","success")},B=()=>{if(i.length===0)return;const e=i.map(s=>({...s.form,projectName:n?.name||"",reportGroup:g.find(r=>r.id===s.form.reportId)?.group}));re({settings:b,forms:e})},M=()=>{if(i.length===0)return;const e=i.map(s=>({"שם הטופס":s.form.formTemplateName,דוח:g.find(r=>r.id===s.form.reportId)?.title||"N/A","תאריך יצירה":oe(s.form.createdAt)}));S(e,`forms_${n?.name}`)};return E?t.jsx(Q,{text:"טוען טפסים..."}):t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"flex justify-between items-center flex-wrap gap-4",children:[t.jsxs("div",{children:[t.jsx("nav",{className:"text-sm mb-1",children:t.jsx(U,{to:`/project/${c}`,className:"text-sky-600 hover:underline",children:"חזרה לבניין"})}),t.jsxs("h2",{className:"text-2xl font-semibold text-slate-700",children:["טפסים עבור: ",n?.name]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("button",{onClick:B,className:"btn-secondary flex items-center gap-2",children:[t.jsx(I,{className:"w-5 h-5"}),"יצא PDF"]}),t.jsxs("button",{onClick:M,className:"btn-secondary flex items-center gap-2",children:[t.jsx(I,{className:"w-5 h-5"}),"יצא Excel"]}),t.jsxs("button",{onClick:()=>y(!0),className:"btn-primary flex items-center",children:[t.jsx(X,{className:"w-5 h-5 me-2 rtl:ml-2"})," הוסף טופס"]})]})]}),i.length>0?t.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6",children:i.map(({form:e,template:s})=>t.jsx(se,{form:e,template:s,onDelete:L,onExportPdf:()=>$({form:e,template:s}),onExportCsv:()=>R({form:e,template:s})},e.id))}):t.jsx("div",{className:"text-center p-10 bg-white rounded-lg shadow border",children:t.jsx("p",{className:"text-slate-500",children:"לא נמצאו טפסים עבור בניין זה."})}),t.jsx(Y,{isOpen:A,onClose:()=>y(!1),title:"הוסף טופס חדש",children:t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-slate-700",children:"שלב 1: בחר דוח"}),t.jsxs("select",{value:p,onChange:e=>F(e.target.value),className:"w-full border-slate-300 rounded-md shadow-sm mt-1",children:[t.jsx("option",{value:"",disabled:!0,children:"בחר דוח לשיוך..."}),g.map(e=>t.jsx("option",{value:e.id,children:e.title},e.id))]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-slate-700",children:"שלב 2: בחר תבנית טופס"}),t.jsxs("select",{value:f,onChange:e=>P(e.target.value),className:"w-full border-slate-300 rounded-md shadow-sm mt-1",disabled:!p,children:[t.jsx("option",{value:"",disabled:!0,children:"בחר תבנית..."}),w.map(e=>t.jsx("option",{value:e.id,children:e.name},e.id))]})]}),t.jsx("div",{className:"flex justify-end pt-4",children:t.jsx("button",{onClick:O,disabled:!p||!f,className:"px-4 py-2 bg-sky-600 text-white rounded-md hover:bg-sky-700 disabled:opacity-50",children:"הוסף טופס"})})]})}),t.jsx("style",{children:`
                .btn-primary { padding: 0.5rem 1rem; background-color: #0284c7; color: white; border-radius: 0.375rem; font-weight: 500; }
                .btn-secondary { padding: 0.5rem 1rem; background-color: #f1f5f9; color: #334155; border: 1px solid #cbd5e1; border-radius: 0.375rem; font-weight: 500; }
            `})]})};export{pe as default};
