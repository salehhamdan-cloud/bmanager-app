import{j as e,L as O,T as D,r as i,u as E,g as T,a as U,A as L,P as M,M as B,b as R,d as J,c as $,e as q,f as z}from"./index-D-cHbBwn.js";import{f as G}from"./dateFormatter-CUKId3Gl.js";import{I as H}from"./ImageUploader-QK9p397g.js";import"./imageService-DERf2zoE.js";import"./AnnotationEditor-CCeRCJQ5.js";import"./shareUtils-BhFQGnPw.js";const K=r=>r?r.split(" ").map(d=>d[0]).slice(0,2).join("").toUpperCase():"",Q=({project:r,onDelete:d})=>{const m=r.images?.[0];return e.jsxs("div",{className:"bg-white rounded-xl shadow-md border border-slate-200/80 overflow-hidden flex flex-col transition-all duration-300 hover:shadow-lg hover:border-sky-200",children:[e.jsx(O,{to:`/project/${r.id}`,className:"block",children:e.jsxs("div",{className:"h-40 bg-slate-200 flex items-center justify-center relative group",children:[m?.url||m?.dataUrl?e.jsx("img",{src:m.url||m.dataUrl,alt:r.name,className:"w-full h-full object-cover"}):e.jsx("span",{className:"text-4xl font-bold text-slate-400",children:K(r.name)}),e.jsx("div",{className:"absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center",children:e.jsx("span",{className:"text-white font-semibold",children:"צפה בפרטים"})})]})}),e.jsxs("div",{className:"p-4 flex-grow flex flex-col",children:[e.jsx("h3",{className:"font-bold text-lg text-slate-800 truncate",title:r.name,children:r.name}),e.jsx("p",{className:"text-sm text-slate-500 truncate mb-2",children:r.address}),e.jsxs("div",{className:"mt-auto pt-4 flex justify-between items-center text-xs text-slate-400",children:[e.jsxs("span",{children:["עודכן: ",G(r.updatedAt)]}),e.jsx("div",{className:"flex items-center gap-1",children:e.jsx("button",{onClick:x=>{x.stopPropagation(),d(r.id)},className:"p-1.5 hover:bg-red-100 rounded-full",title:"מחק בניין",children:e.jsx(D,{className:"w-4 h-4 text-red-500"})})})]})]})]})},V=({label:r,value:d,currentSort:m,setSort:x})=>e.jsx("button",{onClick:()=>x(d),className:`px-3 py-1.5 text-sm font-medium rounded-md transition-colors ${m===d?"bg-white shadow text-sky-600":"text-slate-600 hover:bg-white/60"}`,children:r}),te=()=>{const[r,d]=i.useState([]),[m,x]=i.useState(!0),[w,f]=i.useState(!1),[j,y]=i.useState("createdAt-desc"),[a,h]=i.useState({name:"",address:"",clientInfo:"",images:[],files:[],todos:[],numberOfFloors:void 0,buildingArea:void 0,parkingSpots:void 0,managerName:"",managerPhone:"",managerEmail:""}),{addToast:n}=E(),v=i.useRef(null),b=i.useCallback(async()=>{x(!0);try{const t=await T();d(t)}catch(t){console.error("Error fetching page data:",t),n("שגיאה בטעינת נתונים","error")}finally{x(!1)}},[n]);i.useEffect(()=>{b()},[b]);const k=i.useMemo(()=>[{value:"createdAt-desc",label:"החדש ביותר"},{value:"createdAt-asc",label:"הישן ביותר"},{value:"updatedAt-desc",label:"עודכן לאחרונה"},{value:"name-asc",label:"שם (א-ת)"},{value:"name-desc",label:"שם (ת-א)"}],[]),N=i.useMemo(()=>{const t=[...r],[l,s]=j.split("-");return t.sort((o,u)=>{let p,g;switch(l){case"name":p=o.name.toLowerCase(),g=u.name.toLowerCase();break;case"updatedAt":p=new Date(o.updatedAt).getTime(),g=new Date(u.updatedAt).getTime();break;case"createdAt":default:p=new Date(o.createdAt).getTime(),g=new Date(u.createdAt).getTime();break}return p<g?s==="asc"?-1:1:p>g?s==="asc"?1:-1:0}),t},[r,j]),A=async t=>{if(window.confirm("האם אתה בטוח שברצונך למחוק בניין זה וכל הדוחות הקשורים אליו?"))try{const l=await R(t);for(const s of l)await J(s.id);await $(t),n("הבניין נמחק בהצלחה","success"),b()}catch(l){console.error("Error deleting project:",l),n("שגיאה במחיקת הבניין","error")}},c=t=>{const{name:l,value:s,type:o}=t.target;h(o==="number"?u=>({...u,[l]:s===""?void 0:parseFloat(s)}):u=>({...u,[l]:s}))},I=t=>{const l=t.map(s=>({id:s.id,dataUrl:s.dataUrl,name:s.name,mimeType:s.mimeType,uploadedAt:s.createdAt}));h(s=>({...s,images:l}))},S=async t=>{if(t.preventDefault(),!a.name){n("שם הבניין הוא שדה חובה","warning");return}const l={id:q(),name:a.name,address:a.address||"",clientInfo:a.clientInfo||"",status:"פעיל",managerName:a.managerName||"",managerPhone:a.managerPhone||"",managerEmail:a.managerEmail||"",numberOfFloors:a.numberOfFloors,buildingArea:a.buildingArea,parkingSpots:a.parkingSpots,images:a.images||[],files:[],todos:[],inventory:[],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};try{await z(l),n("בניין חדש נוסף בהצלחה","success"),f(!1),h({name:"",address:"",clientInfo:"",images:[],files:[],todos:[],numberOfFloors:void 0,buildingArea:void 0,parkingSpots:void 0,managerName:"",managerPhone:"",managerEmail:""}),b()}catch(s){console.error("Error adding project:",s),n("שגיאה בהוספת הבניין","error")}},C=()=>{v.current?.click()},P=async t=>{const l=t.target.files?.[0];if(l){if(l.type!=="application/json"){n("נא לבחור קובץ JSON תקין.","error");return}try{const s=await l.text(),o=JSON.parse(s);if(!o.project||!o.reports||!o.problems||!o.forms)throw new Error("Invalid backup file structure.");n("ייבוא פרויקט בודד אינו נתמך כרגע. השתמש בייבוא גלובלי מהגדרות.","warning")}catch(s){console.error("Error importing project:",s),n("שגיאה בייבוא הבניין. הקובץ עשוי להיות פגום.","error")}finally{t.target&&(t.target.value="")}}};if(m)return e.jsx(U,{text:"טוען נתונים..."});const F=(a.images||[]).map(t=>({id:t.id,dataUrl:t.dataUrl,originalDataUrl:t.dataUrl,annotationData:"[]",name:t.name,mimeType:t.mimeType||"image/jpeg",createdAt:t.uploadedAt}));return e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-6 flex-wrap gap-4",children:[e.jsxs("div",{className:"flex items-center gap-4 flex-wrap",children:[e.jsx("h2",{className:"text-2xl font-semibold text-slate-700",children:"רשימת בניינים"}),e.jsx("div",{className:"flex items-center gap-1 bg-slate-100 p-1 rounded-lg flex-wrap",children:k.map(t=>e.jsx(V,{label:t.label,value:t.value,currentSort:j,setSort:y},t.value))})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:C,className:"inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 transition-transform transform hover:-translate-y-px text-green-700 bg-green-100 hover:bg-green-200 focus:ring-green-500",title:"ייבא בניין מקובץ גיבוי",children:[e.jsx(L,{className:"w-5 h-5 me-2 rtl:ml-2"}),"ייבוא"]}),e.jsxs("button",{onClick:()=>f(!0),className:"inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 transition-transform transform hover:-translate-y-px text-white bg-sky-600 hover:bg-sky-700 focus:ring-sky-500",children:[e.jsx(M,{className:"w-5 h-5 me-2 rtl:ml-2"}),"הוסף בניין"]})]})]}),e.jsx("input",{type:"file",ref:v,onChange:P,className:"hidden",accept:".json,application/json"}),N.length===0?e.jsxs("div",{className:"text-center py-16 bg-white rounded-lg shadow-md border",children:[e.jsx("h3",{className:"text-2xl font-semibold text-slate-700",children:"אין בניינים להצגה"}),e.jsx("p",{className:"text-slate-500 mt-2",children:"התחל על ידי הוספת בניין חדש או ייבוא מקובץ גיבוי."})]}):e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6",children:N.map(t=>e.jsx(Q,{project:t,onDelete:A},t.id))}),e.jsxs(B,{isOpen:w,onClose:()=>f(!1),title:"הוספת בניין חדש",size:"lg",children:[e.jsxs("form",{onSubmit:S,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"project-name",className:"block text-sm font-medium text-slate-700",children:"שם הבניין*"}),e.jsx("input",{type:"text",id:"project-name",name:"name",value:a.name||"",onChange:c,required:!0,className:"mt-1 block w-full input-class"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"project-address",className:"block text-sm font-medium text-slate-700",children:"כתובת"}),e.jsx("input",{type:"text",id:"project-address",name:"address",value:a.address||"",onChange:c,className:"mt-1 block w-full input-class"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"project-clientInfo",className:"block text-sm font-medium text-slate-700",children:"פרטי לקוח"}),e.jsx("textarea",{id:"project-clientInfo",name:"clientInfo",value:a.clientInfo||"",onChange:c,rows:3,className:"mt-1 block w-full input-class"})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"numberOfFloors",className:"block text-sm font-medium text-slate-700",children:"קומות"}),e.jsx("input",{type:"number",id:"numberOfFloors",name:"numberOfFloors",value:a.numberOfFloors||"",onChange:c,className:"mt-1 block w-full input-class"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"buildingArea",className:"block text-sm font-medium text-slate-700",children:'שטח (מ"ר)'}),e.jsx("input",{type:"number",id:"buildingArea",name:"buildingArea",value:a.buildingArea||"",onChange:c,className:"mt-1 block w-full input-class"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"parkingSpots",className:"block text-sm font-medium text-slate-700",children:"חניות"}),e.jsx("input",{type:"number",id:"parkingSpots",name:"parkingSpots",value:a.parkingSpots||"",onChange:c,className:"mt-1 block w-full input-class"})]})]}),e.jsxs("div",{className:"pt-4 border-t",children:[e.jsx("h3",{className:"text-md font-medium text-slate-800 mb-2",children:"פרטי מנהל בניין"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"managerName",className:"block text-sm font-medium text-slate-700",children:"שם מנהל"}),e.jsx("input",{type:"text",id:"managerName",name:"managerName",value:a.managerName||"",onChange:c,className:"mt-1 block w-full input-class"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"managerPhone",className:"block text-sm font-medium text-slate-700",children:"טלפון"}),e.jsx("input",{type:"tel",id:"managerPhone",name:"managerPhone",value:a.managerPhone||"",onChange:c,className:"mt-1 block w-full input-class"})]}),e.jsxs("div",{className:"sm:col-span-2",children:[e.jsx("label",{htmlFor:"managerEmail",className:"block text-sm font-medium text-slate-700",children:"אימייל"}),e.jsx("input",{type:"email",id:"managerEmail",name:"managerEmail",value:a.managerEmail||"",onChange:c,className:"mt-1 block w-full input-class"})]})]})]}),e.jsx("div",{className:"pt-4 border-t",children:e.jsx(H,{images:F,onImagesChange:I,maxImages:5,allowNotes:!1})}),e.jsxs("div",{className:"flex justify-end space-x-3 rtl:space-x-reverse pt-2",children:[e.jsx("button",{type:"button",onClick:()=>f(!1),className:"px-4 py-2 text-sm font-medium text-slate-700 bg-slate-100 hover:bg-slate-200 rounded-md shadow-sm",children:"ביטול"}),e.jsx("button",{type:"submit",className:"px-4 py-2 text-sm font-medium text-white bg-sky-600 hover:bg-sky-700 rounded-md shadow-sm",children:"צור בניין"})]})]}),e.jsx("style",{children:".input-class { border: 1px solid #cbd5e1; border-radius: 0.375rem; padding: 0.5rem 0.75rem; width: 100%; } .input-class:focus { outline: none; border-color: #0284c7; box-shadow: 0 0 0 1px #0284c7; }"})]})]})};export{te as default};
