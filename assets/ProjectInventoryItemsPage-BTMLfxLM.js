import{k as W,B as X,u as Y,r as l,l as Z,j as t,a as _,L as N,P as ee,p as te,T as ae,M as I,z as P,e as se}from"./index-D-cHbBwn.js";import{I as ne}from"./ImageUploader-QK9p397g.js";import{f as re}from"./dateFormatter-CUKId3Gl.js";import"./imageService-DERf2zoE.js";import"./AnnotationEditor-CCeRCJQ5.js";import"./shareUtils-BhFQGnPw.js";const pe=()=>{const{projectId:x,locationId:f,groupId:h}=W(),y=X(),{addToast:p}=Y(),[d,D]=l.useState(null),[r,S]=l.useState(null),[c,C]=l.useState(null),[T,k]=l.useState(!0),[b,le]=l.useState("name-asc"),[$,j]=l.useState(!1),[s,m]=l.useState(null),[F,O]=l.useState(!1),[V,G]=l.useState(!1),[U,z]=l.useState(null),[w,R]=l.useState(null),g=l.useCallback(async()=>{if(!(!x||!f||!h)){k(!0);try{const e=await Z(x);if(!e)throw y("/all-inventory"),new Error("Project not found");const a=e.inventory?.find(n=>n.id===f);if(!a)throw y(`/project/${x}/inventory`),new Error("Location not found");const o=a.itemGroups.find(n=>n.id===h);if(!o)throw y(`/project/${x}/inventory/location/${f}`),new Error("Group not found");D(e),C(a),S(o)}catch(e){p(e.message||"שגיאה בטעינת הפריטים","error")}finally{k(!1)}}},[x,f,h,p,y]);l.useEffect(()=>{g()},[g]);const E=(e=null)=>{m(e?JSON.parse(JSON.stringify(e)):{name:"",description:"",model:"",company:"",quantity:1,images:[],warrantyInfo:"",warrantyEndDate:""}),j(!0)},J=async()=>{if(!s||!s.name?.trim()||!d||!c||!r){p("שם הפריט הוא שדה חובה","warning");return}let e;if(s.id)e={...r,items:r.items.map(n=>n.id===s.id?s:n)};else{const n={id:se(),name:s.name.trim(),description:s.description||"",model:s.model||"",company:s.company||"",quantity:s.quantity||0,images:s.images||[],createdAt:new Date().toISOString(),warrantyInfo:s.warrantyInfo,warrantyEndDate:s.warrantyEndDate,manualPdf:s.manualPdf};e={...r,items:[...r.items,n]}}const a={...c,itemGroups:c.itemGroups.map(n=>n.id===h?e:n)},o={...d,inventory:(d.inventory||[]).map(n=>n.id===f?a:n),updatedAt:new Date().toISOString()};try{await P(o),p("הפריט נשמר","success"),j(!1),m(null),g()}catch{p("שגיאה בשמירת הפריט","error")}},Q=async e=>{if(!d||!c||!r||!window.confirm("האם למחוק פריט זה?"))return;const a={...r,items:r.items.filter(i=>i.id!==e)},o={...c,itemGroups:c.itemGroups.map(i=>i.id===h?a:i)},n={...d,inventory:(d.inventory||[]).map(i=>i.id===f?o:i),updatedAt:new Date().toISOString()};try{await P(n),p("הפריט נמחק","success"),g()}catch{p("שגיאה במחיקת הפריט","error")}},L=async(e,a)=>{if(!d||!c||!r)return;const o=r.items.find(u=>u.id===e);if(!o)return;const n=Math.max(0,o.quantity+a);if(n===o.quantity)return;const i={...o,quantity:n},v={...r,items:r.items.map(u=>u.id===e?i:u)},A={...c,itemGroups:c.itemGroups.map(u=>u.id===h?v:u)},q={...d,inventory:(d.inventory||[]).map(u=>u.id===f?A:u),updatedAt:new Date().toISOString()};D(q),S(v),C(A);try{await P(q)}catch{p("שגיאה בעדכון הכמות","error"),g()}},B=e=>{s&&m(a=>({...a,images:e}))},H=e=>{const a=e.target.files?.[0];if(a&&a.type==="application/pdf"){const o=new FileReader;o.onload=n=>{const i={name:a.name,dataUrl:n.target?.result,mimeType:a.type};m(v=>({...v,manualPdf:i}))},o.readAsDataURL(a)}else a&&p("יש להעלות קובץ PDF בלבד","warning")},M=l.useMemo(()=>r?[...r.items].sort((e,a)=>b==="name-asc"?e.name.localeCompare(a.name,"he"):b==="createdAt-desc"?new Date(a.createdAt).getTime()-new Date(e.createdAt).getTime():0):[],[r,b]),K=l.useMemo(()=>s?.images?s.images.map(e=>({...e,id:e.id,originalDataUrl:e.originalDataUrl||e.dataUrl,originalUrl:e.originalUrl||e.url,annotationData:e.annotationData||"[]",createdAt:e.createdAt||new Date().toISOString()})):[],[s]);return T?t.jsx(_,{text:"טוען פריטים..."}):!d||!c||!r?t.jsx("div",{className:"text-center p-8",children:"Data not found."}):t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsxs("div",{children:[t.jsxs("nav",{className:"text-sm mb-1",children:[t.jsx(N,{to:`/project/${x}`,className:"text-sky-600 hover:underline",children:d.name}),t.jsx("span",{className:"text-slate-500 mx-2",children:"/"}),t.jsx(N,{to:`/project/${x}/inventory`,className:"text-sky-600 hover:underline",children:"מלאי"}),t.jsx("span",{className:"text-slate-500 mx-2",children:"/"}),t.jsx(N,{to:`/project/${x}/inventory/location/${f}`,className:"text-sky-600 hover:underline",children:c.name})]}),t.jsx("h1",{className:"text-2xl font-bold text-slate-800",children:r.name})]}),t.jsxs("button",{onClick:()=>E(),className:"btn-primary flex items-center gap-2",children:[t.jsx(ee,{className:"w-5 h-5"}),"הוסף פריט"]})]}),M.length===0?t.jsx("div",{className:"text-center p-10 bg-white rounded-lg shadow border",children:t.jsx("p",{className:"text-slate-500",children:"לא נמצאו פריטים בקבוצה זו."})}):t.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:M.map(e=>t.jsxs("div",{className:"bg-white p-4 rounded-lg shadow-md border flex flex-col",children:[t.jsxs("div",{className:"flex-grow",children:[t.jsxs("div",{className:"flex justify-between items-start",children:[t.jsx("h3",{className:"text-lg font-semibold text-sky-700",children:e.name}),t.jsx("span",{className:"text-xl font-bold text-slate-600 bg-slate-100 rounded-full px-3 py-1",children:e.quantity})]}),t.jsxs("p",{className:"text-sm text-slate-500",children:[e.company," ",e.model]}),t.jsx("p",{className:"text-sm text-slate-600 mt-2",children:e.description}),e.warrantyEndDate&&t.jsxs("p",{className:"text-xs text-slate-500 mt-2",children:["אחריות עד: ",re(e.warrantyEndDate)]})]}),t.jsxs("div",{className:"flex justify-between items-center mt-4 pt-3 border-t",children:[t.jsxs("div",{children:[e.images.length>0&&t.jsxs("button",{onClick:()=>{z(e),O(!0)},className:"text-xs font-medium text-blue-600 hover:underline",children:["הצג תמונות (",e.images.length,")"]}),e.manualPdf&&t.jsx("button",{onClick:()=>{const a=e.manualPdf?.url||e.manualPdf?.dataUrl;a&&(R({name:e.manualPdf.name,dataUrl:a}),G(!0))},className:"text-xs font-medium text-blue-600 hover:underline ml-2",children:"הצג מדריך"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx("button",{onClick:()=>L(e.id,-1),className:"p-1.5 text-slate-500 hover:bg-slate-100 rounded-full text-xl font-bold",children:"-"}),t.jsx("button",{onClick:()=>L(e.id,1),className:"p-1.5 text-slate-500 hover:bg-slate-100 rounded-full text-xl font-bold",children:"+"}),t.jsx("button",{onClick:()=>E(e),className:"p-1.5 text-slate-500 hover:bg-slate-100 rounded-full",children:t.jsx(te,{className:"w-4 h-4"})}),t.jsx("button",{onClick:()=>Q(e.id),className:"p-1.5 text-red-500 hover:bg-red-100 rounded-full",children:t.jsx(ae,{className:"w-4 h-4"})})]})]})]},e.id))}),t.jsx(I,{isOpen:$,onClose:()=>j(!1),title:s?.id?"עריכת פריט":"הוספת פריט חדש",size:"lg",children:t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsx("input",{type:"text",placeholder:"שם הפריט*",value:s?.name||"",onChange:e=>m(a=>({...a,name:e.target.value})),className:"input-class"}),t.jsx("input",{type:"number",placeholder:"כמות",value:s?.quantity??1,min:"0",onChange:e=>m(a=>({...a,quantity:parseInt(e.target.value)||0})),className:"input-class"}),t.jsx("input",{type:"text",placeholder:"חברה",value:s?.company||"",onChange:e=>m(a=>({...a,company:e.target.value})),className:"input-class"}),t.jsx("input",{type:"text",placeholder:"דגם",value:s?.model||"",onChange:e=>m(a=>({...a,model:e.target.value})),className:"input-class"})]}),t.jsx("textarea",{placeholder:"תיאור",value:s?.description||"",onChange:e=>m(a=>({...a,description:e.target.value})),className:"input-class w-full",rows:3}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsx("input",{type:"text",placeholder:"פרטי אחריות",value:s?.warrantyInfo||"",onChange:e=>m(a=>({...a,warrantyInfo:e.target.value})),className:"input-class"}),t.jsxs("div",{children:[t.jsx("label",{className:"text-xs text-slate-500",children:"תאריך סיום אחריות"}),t.jsx("input",{type:"date",value:s?.warrantyEndDate?s.warrantyEndDate.split("T")[0]:"",onChange:e=>m(a=>({...a,warrantyEndDate:e.target.value})),className:"input-class w-full"})]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:"מדריך למשתמש (PDF)"}),t.jsx("input",{type:"file",accept:"application/pdf",onChange:H,className:"file-input-class"}),s?.manualPdf&&t.jsx("p",{className:"text-xs mt-1",children:s.manualPdf.name})]}),t.jsx(ne,{images:K,onImagesChange:B,maxImages:5,allowNotes:!0}),t.jsxs("div",{className:"flex justify-end gap-2 pt-4",children:[t.jsx("button",{onClick:()=>j(!1),className:"btn-secondary",children:"ביטול"}),t.jsx("button",{onClick:J,className:"btn-primary",children:"שמור"})]})]})}),t.jsx(I,{isOpen:F,onClose:()=>O(!1),title:`תמונות עבור: ${U?.name}`,children:t.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4",children:U?.images.map(e=>t.jsx("img",{src:e.url||e.dataUrl,alt:e.name,className:"w-full h-40 object-cover rounded-md"},e.id))})}),t.jsx(I,{isOpen:V,onClose:()=>G(!1),title:`מדריך: ${w?.name}`,size:"xl",children:w?.dataUrl&&t.jsx("iframe",{src:w.dataUrl,title:w.name,className:"w-full h-[75vh]",border:"0"})}),t.jsx("style",{children:`
                .input-class { display: block; width: 100%; border: 1px solid #cbd5e1; border-radius: 0.375rem; padding: 0.5rem 0.75rem; }
                .file-input-class { display: block; width: 100%; text-sm text-slate-500 file:mr-4 file:rtl:ml-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100 }
                .btn-primary { padding: 0.5rem 1rem; background-color: #0284c7; color: white; border-radius: 0.375rem; font-weight: 500; }
                .btn-secondary { padding: 0.5rem 1rem; background-color: #f1f5f9; color: #334155; border: 1px solid #cbd5e1; border-radius: 0.375rem; font-weight: 500; }
            `})]})};export{pe as ProjectInventoryItemsPage};
