import{k as _,B,r as o,u as V,h as q,E as z,l as H,G as J,w as K,j as e,a as Q,L as v,A as I,P as U,M as W,ah as X,e as Y,N as Z}from"./index-D-cHbBwn.js";import{P as ee}from"./ProjectFormItem-pAMF6o7r.js";import{b as te,j as se}from"./pdfService-D-0A9fw7.js";import{e as P}from"./exportUtils-Bak1EFUX.js";import{a as re,f as ae}from"./dateFormatter-CUKId3Gl.js";const ie=()=>{const{projectId:u,reportId:m}=_();B();const[c,D]=o.useState(null),[g,E]=o.useState(null),[d,S]=o.useState([]),[y,T]=o.useState([]),[k,N]=o.useState(!0),{addToast:r}=V(),{settings:w}=q(),[C,b]=o.useState(!1),[p,F]=o.useState(""),x=o.useCallback(async()=>{if(!(!m||!u)){N(!0);try{const t=await z(m),s=await H(u),a=await J(),h=(await K(m)).map(n=>({form:n,template:a.find(j=>j.id===n.formTemplateId)})).filter(n=>n.template);D(t),E(s),T(a),S(h)}catch{r("Error fetching forms","error")}finally{N(!1)}}},[m,u,r]);o.useEffect(()=>{x()},[x]);const A=async t=>{if(window.confirm("Are you sure you want to delete this form?"))try{await X(t),r("Form deleted successfully.","success"),x()}catch{r("Error deleting form.","error")}},L=async()=>{if(!p||!c)return;const t=y.find(a=>a.id===p);if(!t){r("Template not found","error");return}const s={id:Y(),projectId:c.projectId,reportId:c.id,formTemplateId:p,formTemplateName:t.name,answers:[],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),formDate:new Date().toISOString()};try{await Z(s),r(`Form "${t.name}" added successfully.`,"success"),b(!1),F(""),x()}catch{r("Error adding form","error")}},$=async t=>{if(!(!g||!w)){r(`מכין PDF עבור טופס: ${t.template.name}...`,"info");try{await se({settings:w,project:g,formWithTemplate:t}),r("PDF של הטופס נוצר והורד בהצלחה","success")}catch{r("שגיאה ביצירת PDF לטופס","error")}}},O=t=>{const{form:s,template:a}=t;if(!s||!a)return;const f=[];a.groups.forEach(h=>{h.items.forEach(n=>{const j=s.answers.find(G=>G.formItemId===n.id),l=j?.value;let i="-";typeof l=="boolean"?i=l?"כן":"לא":l==="ok"?i="תקין":l==="not-ok"?i="לא תקין":l==="na"?i="לא רלוונטי":l&&(i=String(l)),f.push({קבוצה:h.name,שאלה:n.label,תשובה:i,הערות:j?.description||""})})}),s.reporterComments&&f.push({קבוצה:"סיכום",שאלה:"הערות מדווח",תשובה:s.reporterComments,הערות:""}),s.managerComments&&f.push({קבוצה:"סיכום",שאלה:"הערות מנהל",תשובה:s.managerComments,הערות:""}),P(f,`form_${a.name}_${ae(s.formDate)}`),r("הטופס יוצא לקובץ Excel...","success")},R=()=>{if(d.length===0)return;const t=d.map(s=>({...s.form,projectName:g?.name||"",reportGroup:c?.group}));te({settings:w,forms:t})},M=()=>{if(d.length===0)return;const t=d.map(s=>({"שם הטופס":s.form.formTemplateName,"תאריך יצירה":re(s.form.createdAt)}));P(t,`forms_${c?.title}`)};return k?e.jsx(Q,{text:"טוען טפסים..."}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center flex-wrap gap-4",children:[e.jsxs("div",{children:[e.jsx("nav",{className:"text-sm mb-1",children:e.jsx(v,{to:`/project/${u}/report/${m}`,className:"text-sky-600 hover:underline",children:"חזרה לדוח"})}),e.jsxs("h2",{className:"text-2xl font-semibold text-slate-700",children:["טפסים בדוח: ",c?.title]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:R,className:"btn-secondary flex items-center gap-2",children:[e.jsx(I,{className:"w-5 h-5"}),"יצא PDF"]}),e.jsxs("button",{onClick:M,className:"btn-secondary flex items-center gap-2",children:[e.jsx(I,{className:"w-5 h-5"}),"יצא Excel"]}),e.jsxs("button",{onClick:()=>b(!0),className:"btn-primary flex items-center",children:[e.jsx(U,{className:"w-5 h-5 me-2 rtl:ml-2"})," הוסף טופס"]})]})]}),d.length>0?e.jsx("div",{className:"space-y-3",children:d.map(({form:t,template:s})=>e.jsx(ee,{form:t,template:s,onDelete:A,onExportPdf:()=>$({form:t,template:s}),onExportCsv:()=>O({form:t,template:s})},t.id))}):e.jsx("div",{className:"text-center p-10 bg-white rounded-lg shadow border",children:e.jsx("p",{className:"text-slate-500",children:"אין טפסים מצורפים לדוח זה."})}),e.jsx(W,{isOpen:C,onClose:()=>b(!1),title:"הוסף טופס לדוח",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"text-lg font-medium",children:"בחר תבנית טופס"}),y.length>0?e.jsxs("select",{value:p,onChange:t=>F(t.target.value),className:"w-full border-slate-300 rounded-md shadow-sm",children:[e.jsx("option",{value:"",disabled:!0,children:"בחר תבנית..."}),y.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}):e.jsxs("p",{className:"text-slate-500",children:["אין תבניות זמינות. ",e.jsx(v,{to:"/form-templates",className:"text-sky-600",children:"צור תבנית חדשה"}),"."]}),e.jsx("div",{className:"flex justify-end pt-4",children:e.jsx("button",{onClick:L,disabled:!p,className:"px-4 py-2 bg-sky-600 text-white rounded-md hover:bg-sky-700 disabled:opacity-50",children:"הוסף טופס"})})]})}),e.jsx("style",{children:`
                .btn-primary { padding: 0.5rem 1rem; background-color: #0284c7; color: white; border-radius: 0.375rem; font-weight: 500; }
                .btn-secondary { padding: 0.5rem 1rem; background-color: #f1f5f9; color: #334155; border: 1px solid #cbd5e1; border-radius: 0.375rem; font-weight: 500; }
            `})]})};export{ie as default};
