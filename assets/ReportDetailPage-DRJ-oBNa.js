import{r as t,i as l,S as v,j as e,k as ce,B as de,u as me,h as ue,E as pe,l as xe,o as ge,G as he,H as fe,g as je,n as be,w as ye,a as B,L as _,p as ve,A as z,J as Ce,s as Ie,M as Se,K as J,e as Ne,N as we}from"./index-D-cHbBwn.js";import{f as De}from"./dateFormatter-CUKId3Gl.js";import{g as Re}from"./pdfService-D-0A9fw7.js";import{S as Pe,b as Ee}from"./aiService-BGt51fXt.js";import{C as E,r as ke}from"./chart-Zj-L_LRF.js";import{C as Te}from"./CollapsibleSection-F92uqtdU.js";import{N as K}from"./NavigationCard-5VvEbhy9.js";import{D as Ae}from"./Dashboard-BnFonGuj.js";import{e as Le}from"./exportUtils-Bak1EFUX.js";import"./emailService-Ce1ZuM1T.js";import"./ContactIcons-B1NAvYGF.js";E.register(...ke);const Fe=({problems:i,chartRef:u})=>{const C=t.useRef(null),o=u||C,p=t.useMemo(()=>{const r={[l.LOW]:0,[l.MEDIUM]:0,[l.HIGH]:0,[l.CRITICAL]:0};return i.forEach(d=>{r[d.severity]=(r[d.severity]||0)+1}),{totalProblems:i.length,severityCounts:r}},[i]),a=t.useMemo(()=>{const r=Object.values(l),d=r.map(x=>p.severityCounts[x]),n=r.map(x=>v[x]?.pdfFill||"#cccccc"),g=r.map(x=>v[x]?.pdfText||"#666666");return{labels:r,datasets:[{label:"Problems by Severity",data:d,backgroundColor:n,borderColor:g,borderWidth:1}]}},[p.severityCounts]);t.useEffect(()=>{let r=null;if(o.current){const d=E.getChart(o.current);d&&d.destroy(),r=new E(o.current,{type:"doughnut",data:a,options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"right",labels:{font:{family:"Heebo"},generateLabels:function(n){const g=n.data;if(g.labels&&g.labels.length&&g.datasets.length){const x=E.defaults.plugins.legend.labels.generateLabels(n);return x.forEach(j=>{if(j.index!==void 0){const I=g.datasets[0].data[j.index];j.text=`${j.text}: ${I}`}}),x}return[]}}},title:{display:!0,text:"התפלגות תקלות לפי חומרה",font:{family:"Heebo",size:16}}}}})}return()=>r?.destroy()},[a,o]);const h=({title:r,value:d,colorClass:n})=>e.jsxs("div",{className:"bg-white p-3 rounded-lg shadow-sm text-center border",children:[e.jsx("p",{className:"text-2xl font-bold text-slate-800",children:d}),e.jsx("p",{className:`text-xs font-medium ${n}`,children:r})]});return e.jsxs("section",{className:"mb-6 p-4 bg-slate-50 rounded-lg shadow-inner border border-slate-200",children:[e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-5 gap-4 mb-4",children:[e.jsx(h,{title:"סה״כ תקלות",value:p.totalProblems,colorClass:"text-slate-500"}),e.jsx(h,{title:l.CRITICAL,value:p.severityCounts[l.CRITICAL],colorClass:v[l.CRITICAL].text}),e.jsx(h,{title:l.HIGH,value:p.severityCounts[l.HIGH],colorClass:v[l.HIGH].text}),e.jsx(h,{title:l.MEDIUM,value:p.severityCounts[l.MEDIUM],colorClass:v[l.MEDIUM].text}),e.jsx(h,{title:l.LOW,value:p.severityCounts[l.LOW],colorClass:v[l.LOW].text})]}),e.jsx("div",{className:"bg-white p-2 rounded-lg shadow-sm border",children:e.jsx("div",{className:"relative h-64",children:i.length>0?e.jsx("canvas",{ref:o}):e.jsx("p",{className:"text-center text-slate-400 pt-24",children:"אין תקלות בדוח זה."})})})]})},rt=()=>{const{projectId:i,reportId:u}=ce(),C=de(),{addToast:o}=me(),{settings:p}=ue(),[a,h]=t.useState(null),[r,d]=t.useState(null),[n,g]=t.useState([]),[x,j]=t.useState([]),[I,V]=t.useState([]),[N,Y]=t.useState([]),[q,M]=t.useState(!0),[Q,k]=t.useState(!1),[S,O]=t.useState(""),[Me,Oe]=t.useState(!1),[$e,He]=t.useState(!1),[Ge,Ue]=t.useState([]),[We,Be]=t.useState(!1),[w,$]=t.useState(!1),[b,H]=t.useState(""),[_e,G]=t.useState(!1),[ze,U]=t.useState({}),T=t.useRef(null),[D,X]=t.useState(null),[W,Z]=t.useState([]),A=t.useRef(null),L=t.useRef(null),F=t.useCallback(async()=>{if(!(!u||!i)){M(!0);try{const[s,c,m,f,R,oe,le]=await Promise.all([pe(u),xe(i),ge(u),he(),fe(),je(),be()]);if(s&&c){h(s),d(c),g(m.sort((y,P)=>y.order-P.order)),V(f),X(R),Z(oe),Y(le);const ne=(await ye(u)).map(y=>{const P=f.find(ie=>ie.id===y.formTemplateId);return P?{form:y,template:P}:null}).filter(y=>y!==null);j(ne)}else o("דוח או בניין לא נמצאו","error"),C(`/project/${i}`)}catch(s){console.error("Error fetching report details:",s),o("שגיאה בטעינת פרטי הדוח","error")}finally{M(!1)}}},[u,i,o,C]);t.useEffect(()=>{F()},[F]),t.useMemo(()=>!a?.workerIds||!r?.workers?[]:r.workers.filter(s=>a.workerIds.includes(s.id)),[a,r]),t.useMemo(()=>!a?.supplierIds||!N?[]:N.filter(s=>a.supplierIds.includes(s.id)),[a,N]),t.useMemo(()=>!a?.tenantIds||!r?.tenants?[]:r.tenants.filter(s=>a.tenantIds.includes(s.id)),[a,r]);const ee=async()=>{if(!r||!a||!p)return;o("מכין PDF לדוח...","info");let s;T.current&&(s=T.current.toDataURL("image/png"));let c;D&&A.current&&L.current&&(c={stats:D,statusChartImage:A.current.toDataURL("image/png"),issuesChartImage:L.current.toDataURL("image/png")});try{const m={settings:p,project:r,report:a,problems:n,allSuppliers:N,reportDashboardImageUrl:s,globalDashboard:c},{failedImages:f}=await Re(m);if(f.length>0){const R=`PDF נוצר, אך ${f.length} תמונות לא נטענו.`;o(R,"warning"),J(`אזהרת טעינת תמונות ב-PDF לדוח: ${a.title}`,R)}else o("PDF של הדוח נוצר והורד בהצלחה","success")}catch(m){console.error("Error generating PDF:",m);const f=m instanceof Error?m.message:String(m);o("שגיאה ביצירת PDF. בדוק ביומן הפעילות לפרטים.","error"),J(`שגיאה קריטית ביצירת PDF לדוח: ${a.title}`,f)}},te=()=>{if(n.length===0){o("אין תקלות לייצוא","warning");return}const s=n.map(c=>({תיאור:c.description,חומרה:c.severity,מיקום:c.locationTag||"",הערות:c.notes}));Le(s,`report_${a?.title}_problems`),o("קובץ Excel יוצא...","success")},se=async()=>{if(!S||!r||!a)return;const s=I.find(m=>m.id===S);if(!s){o("Template not found","error");return}const c={id:Ne(),projectId:r.id,reportId:a.id,formTemplateId:S,formTemplateName:s.name,answers:[],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),formDate:new Date().toISOString()};try{await we(c),o(`Form "${s.name}" added successfully.`,"success"),k(!1),O(""),F()}catch{o("Error adding form","error")}},ae=async()=>{if(n.length===0){o("יש להוסיף תקלות לדוח לפני יצירת סיכום.","warning");return}$(!0),H("");try{const s=await Ee(n);H(s)}catch(s){o(s instanceof Error?s.message:"שגיאה ביצירת סיכום AI","error")}finally{$(!1)}},re=()=>{a&&(U({...a,description:b}),G(!0))};return q||!a||!r?e.jsx(B,{text:"טוען פרטי דוח..."}):e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{style:{display:"none"},children:D&&W&&e.jsx(Ae,{stats:D,projects:W,statusChartRef:A,issuesChartRef:L})}),e.jsxs("section",{className:"bg-white p-6 rounded-lg shadow-md",children:[e.jsxs("div",{className:"flex justify-between items-start flex-wrap gap-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-slate-800",children:a.title}),e.jsx("p",{className:"text-slate-500",children:e.jsx(_,{to:`/project/${r.id}`,className:"text-sky-600 hover:underline",children:r.name})}),e.jsxs("p",{className:"text-sm text-slate-500 mt-1",children:[De(a.date),a.group&&e.jsx("span",{className:"text-xs bg-sky-100 text-sky-800 px-2 py-0.5 rounded-full ml-2 rtl:mr-2",children:a.group})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>{U(a),G(!0)},className:"p-2 text-slate-500 hover:text-sky-600 rounded-full hover:bg-sky-50",title:"ערוך פרטי דוח",children:e.jsx(ve,{className:"w-5 h-5"})}),e.jsx("button",{onClick:ee,className:"p-2 text-slate-500 hover:text-red-600 rounded-full hover:bg-red-50",title:"יצא PDF",children:e.jsx(z,{className:"w-5 h-5"})}),e.jsx("button",{onClick:te,className:"p-2 text-slate-500 hover:text-green-600 rounded-full hover:bg-green-50",title:"יצא Excel",children:e.jsx(z,{className:"w-5 h-5"})})]})]}),a.description&&e.jsx("p",{className:"mt-4 text-slate-700 whitespace-pre-wrap",children:a.description})]}),e.jsx(Fe,{problems:n,chartRef:T}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx(K,{to:`/project/${i}/report/${u}/problems`,icon:e.jsx(Ce,{className:"w-6 h-6"}),title:"תקלות בדוח",count:n.length,actionText:"הוסף תקלה",onActionClick:()=>C(`/project/${i}/report/${u}/problem/new`)}),e.jsx(K,{to:`/project/${i}/report/${u}/forms`,icon:e.jsx(Ie,{className:"w-6 h-6"}),title:"טפסים מצורפים",count:x.length,actionText:"הוסף טופס",onActionClick:()=>k(!0)})]}),e.jsx(Se,{isOpen:Q,onClose:()=>k(!1),title:"הוסף טופס לדוח",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"text-lg font-medium",children:"בחר תבנית טופס"}),I.length>0?e.jsxs("select",{value:S,onChange:s=>O(s.target.value),className:"w-full border-slate-300 rounded-md shadow-sm",children:[e.jsx("option",{value:"",disabled:!0,children:"בחר תבנית..."}),I.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]}):e.jsxs("p",{className:"text-slate-500",children:["אין תבניות זמינות. ",e.jsx(_,{to:"/form-templates",className:"text-sky-600",children:"צור תבנית חדשה"}),"."]}),e.jsx("div",{className:"flex justify-end pt-4",children:e.jsx("button",{onClick:se,disabled:!S,className:"px-4 py-2 bg-sky-600 text-white rounded-md hover:bg-sky-700 disabled:opacity-50",children:"הוסף טופס"})})]})}),e.jsx(Te,{title:e.jsx("h3",{className:"text-lg font-semibold text-slate-800",children:"סיכום AI"}),defaultOpen:!!b,children:e.jsxs("div",{className:"space-y-4",children:[w?e.jsx(B,{text:"מייצר סיכום..."}):b?e.jsx("div",{className:"prose max-w-none text-slate-700 whitespace-pre-wrap",children:b}):e.jsx("p",{className:"text-slate-500",children:"לחץ על הכפתור כדי ליצור סיכום מנהלים אוטומטי של התקלות בדוח."}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("button",{onClick:ae,disabled:w,className:"flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-purple-700 bg-purple-100 rounded-md hover:bg-purple-200 disabled:opacity-50",children:[e.jsx(Pe,{className:"w-5 h-5"}),w?"מעבד...":b?"צור סיכום חדש":"צור סיכום"]}),b&&!w&&e.jsx("button",{onClick:re,className:"text-sm font-medium text-sky-600 hover:underline",children:"החל סיכום זה על הדוח"})]})]})})]})};export{rt as default};
