import{r,u as X,h as Y,ag as Z,g as ee,ae as te,G as se,j as e,a as ae,A as M,P as re,L as le,T as oe,M as ne,ah as ce,N as ie,e as de}from"./index-BU7E-q7q.js";import{a as _,f as me}from"./dateFormatter-CUKId3Gl.js";import{C as ue}from"./CollapsibleSection-BbrEhqCk.js";import{e as pe}from"./exportUtils-Bak1EFUX.js";import{b as xe}from"./pdfService-Th-ePIZW.js";const c=({label:n,value:h,currentValue:w,onClick:v})=>e.jsx("button",{onClick:()=>v(h),className:`px-3 py-1.5 text-sm font-medium rounded-md transition-colors ${w===h?"bg-sky-600 text-white shadow":"bg-slate-100 text-slate-700 hover:bg-slate-200"}`,children:n}),Ne=()=>{const[n,h]=r.useState([]),[w,v]=r.useState([]),[V,R]=r.useState([]),[T,$]=r.useState([]),[B,A]=r.useState(!0),[i,j]=r.useState("createdAt-desc"),[o,y]=r.useState(""),{addToast:l}=X(),{settings:q}=Y(),[K,D]=r.useState(!1),[k,u]=r.useState(1),[b,F]=r.useState(""),[C,P]=r.useState(""),[f,O]=r.useState(""),[E,G]=r.useState(new Date().toISOString().split("T")[0]),g=r.useCallback(async()=>{A(!0);try{const[t,s,a,N]=await Promise.all([Z(),ee(),te(),se()]);h(t),v(s),R(a),$(N)}catch(t){console.error("Error fetching all forms data:",t),l("שגיאה בטעינת הנתונים","error")}finally{A(!1)}},[l]);r.useEffect(()=>{g()},[g]);const W=async t=>{if(window.confirm("האם אתה בטוח שברצונך למחוק טופס זה?"))try{await ce(t),l("הטופס נמחק בהצלחה","success"),g()}catch(s){console.error("Error deleting form:",s),l("שגיאה במחיקת הטופס","error")}},L=()=>{D(!1),u(1),F(""),P(""),O(""),G(new Date().toISOString().split("T")[0])},z=async()=>{const t=T.find(s=>s.id===f);if(t)try{await ie({id:de(),projectId:b,reportId:C,formTemplateId:f,formTemplateName:t.name,formDate:new Date(E).toISOString(),answers:[],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}),l("הטופס נוסף בהצלחה","success"),L(),g()}catch{l("שגיאה בהוספת הטופס","error")}},H=r.useMemo(()=>{const t=new Set(n.map(s=>s.reportGroup).filter(Boolean));return Array.from(t).sort((s,a)=>s.localeCompare(a,"he"))},[n]),d=r.useMemo(()=>{const s=[...n.filter(m=>o?o==="__none__"?!m.reportGroup:m.reportGroup===o:!0)],[a,N]=i.split("-");return s.sort((m,I)=>{let p,x;switch(a){case"projectName":p=m.projectName.toLowerCase(),x=I.projectName.toLowerCase();break;case"formTemplateName":p=m.formTemplateName.toLowerCase(),x=I.formTemplateName.toLowerCase();break;case"createdAt":default:p=new Date(m.createdAt).getTime(),x=new Date(I.createdAt).getTime();break}return p<x?N==="asc"?-1:1:p>x?N==="asc"?1:-1:0}),s},[n,i,o]),S=r.useMemo(()=>d.reduce((t,s)=>{const a=s.projectName;return t[a]||(t[a]={projectId:s.projectId,forms:[]}),t[a].forms.push(s),t},{}),[d]),J=r.useMemo(()=>Object.keys(S).sort((t,s)=>t.localeCompare(s,"he")),[S]),Q=()=>{if(d.length===0){l("אין טפסים לייצוא","warning");return}l("מכין PDF...","info"),xe({settings:q,forms:d})},U=()=>{if(d.length===0){l("אין טפסים לייצוא","warning");return}const t=d.map(s=>({"שם הטופס":s.formTemplateName,בניין:s.projectName,"קבוצת דוח":s.reportGroup||"-","תאריך יצירה":_(s.createdAt)}));pe(t,"forms_list"),l("קובץ Excel יוצא...","success")};return B?e.jsx(ae,{text:"טוען טפסים..."}):e.jsxs("div",{className:"animate-fadeIn",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6 flex-wrap gap-4",children:[e.jsx("h2",{className:"text-2xl font-bold text-slate-800",children:"כל הטפסים"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:Q,className:"btn-secondary flex items-center gap-2",children:[e.jsx(M,{className:"w-5 h-5"}),"יצא PDF"]}),e.jsxs("button",{onClick:U,className:"btn-secondary flex items-center gap-2",children:[e.jsx(M,{className:"w-5 h-5"}),"יצא Excel"]}),e.jsxs("button",{onClick:()=>D(!0),className:"btn-primary flex items-center",children:[e.jsx(re,{className:"w-5 h-5 me-2 rtl:ml-2"}),"הוסף טופס"]})]})]}),e.jsxs("div",{className:"bg-white p-4 rounded-lg shadow-md border mb-6 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 mb-2",children:"סנן לפי קבוצת דוח:"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(c,{label:"הכל",value:"",currentValue:o,onClick:y}),e.jsx(c,{label:"ללא קבוצה",value:"__none__",currentValue:o,onClick:y}),H.map(t=>e.jsx(c,{label:t,value:t,currentValue:o,onClick:y},t))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 mb-2",children:"מיין לפי:"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(c,{label:"החדש ביותר",value:"createdAt-desc",currentValue:i,onClick:j}),e.jsx(c,{label:"הישן ביותר",value:"createdAt-asc",currentValue:i,onClick:j}),e.jsx(c,{label:"בניין (א-ת)",value:"projectName-asc",currentValue:i,onClick:j}),e.jsx(c,{label:"שם טופס (א-ת)",value:"formTemplateName-asc",currentValue:i,onClick:j})]})]})]}),n.length===0?e.jsxs("div",{className:"text-center py-16 bg-white rounded-lg shadow-md border",children:[e.jsx("h3",{className:"text-2xl font-semibold text-slate-700",children:"לא נמצאו טפסים"}),e.jsx("p",{className:"text-slate-500 mt-2",children:o?"אין טפסים התואמים לסינון שנבחר.":"עדיין לא מולאו טפסים באף דוח."})]}):e.jsx("div",{className:"space-y-4",children:J.map(t=>{const s=S[t];return e.jsx(ue,{count:s.forms.length,title:e.jsx("h3",{className:"text-xl font-semibold text-slate-700",children:t}),children:e.jsx("div",{className:"space-y-3 pt-2",children:s.forms.map(a=>e.jsxs("div",{className:"bg-white border border-slate-200/80 rounded-xl p-4 transition-all duration-300 hover:shadow-lg hover:border-sky-200 flex justify-between items-center gap-4",children:[e.jsxs(le,{to:`/project/${a.projectId}/report/${a.reportId}/form/${a.id}`,className:"flex-grow min-w-0",children:[e.jsx("h4",{className:"font-semibold text-slate-800 truncate hover:text-sky-600",title:a.formTemplateName,children:a.formTemplateName}),e.jsxs("div",{className:"flex items-center gap-3 text-sm text-slate-500 mt-1 flex-wrap",children:[e.jsx("span",{children:_(a.createdAt)}),a.reportGroup&&e.jsx("span",{className:"text-xs bg-sky-100 text-sky-800 px-2 py-0.5 rounded-full",children:a.reportGroup})]})]}),e.jsx("button",{onClick:()=>W(a.id),className:"p-2 text-slate-400 hover:text-red-600 transition-colors rounded-full hover:bg-red-50 flex-shrink-0",title:"מחק טופס",children:e.jsx(oe,{className:"w-5 h-5"})})]},a.id))})},t)})}),e.jsx(ne,{isOpen:K,onClose:L,title:"הוספת טופס חדש",children:e.jsxs("div",{className:"space-y-4",children:[k===1&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"שלב 1: בחר בניין"}),e.jsxs("select",{value:b,onChange:t=>F(t.target.value),className:"w-full input-class",children:[e.jsx("option",{value:"",disabled:!0,children:"בחר..."}),w.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),e.jsx("button",{onClick:()=>u(2),disabled:!b,className:"btn-primary mt-4",children:"הבא"})]}),k===2&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"שלב 2: בחר דוח"}),e.jsxs("select",{value:C,onChange:t=>P(t.target.value),className:"w-full input-class",children:[e.jsx("option",{value:"",disabled:!0,children:"בחר..."}),V.filter(t=>t.projectId===b).map(t=>e.jsxs("option",{value:t.id,children:[t.title," (",me(t.date),")"]},t.id))]}),e.jsxs("div",{className:"flex justify-between mt-4",children:[e.jsx("button",{onClick:()=>u(1),className:"btn-secondary",children:"הקודם"}),e.jsx("button",{onClick:()=>u(3),disabled:!C,className:"btn-primary",children:"הבא"})]})]}),k===3&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"שלב 3: בחר תבנית טופס ותאריך"}),e.jsx("input",{type:"date",value:E,onChange:t=>G(t.target.value),required:!0,className:"w-full input-class mb-4"}),e.jsxs("select",{value:f,onChange:t=>O(t.target.value),className:"w-full input-class",children:[e.jsx("option",{value:"",disabled:!0,children:"בחר..."}),T.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),e.jsxs("div",{className:"flex justify-between mt-4",children:[e.jsx("button",{onClick:()=>u(2),className:"btn-secondary",children:"הקודם"}),e.jsx("button",{onClick:z,disabled:!f,className:"btn-primary",children:"הוסף טופס"})]})]})]})}),e.jsx("style",{children:`
                .btn-primary { padding: 0.5rem 1rem; background-color: #0284c7; color: white; border-radius: 0.375rem; font-weight: 500; }
                .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }
                .btn-secondary { padding: 0.5rem 1rem; background-color: #f1f5f9; color: #334155; border: 1px solid #cbd5e1; border-radius: 0.375rem; font-weight: 500; }
                .input-class { display: block; width: 100%; border: 1px solid #cbd5e1; border-radius: 0.375rem; padding: 0.5rem 0.75rem; }
            `})]})};export{Ne as default};
