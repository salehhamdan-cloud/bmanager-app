import{r as o,S as C,j as e,M as D,k as L,u as O,a4 as E,a5 as U,ar as R,L as $,p as H,T as A,ad as G,B as F,E as W,l as z,o as B,n as V,i as r,a as Y,P as _,as as q,at as J}from"./index-D-cHbBwn.js";import{s as K}from"./shareUtils-BhFQGnPw.js";const Q=({image:s,onClose:c})=>e.jsx("div",{className:"fixed inset-0 bg-black/80 z-[1001] flex items-center justify-center p-4 animate-fadeIn",style:{animationDuration:"0.2s"},onClick:c,children:e.jsxs("div",{className:"relative max-w-4xl max-h-[90vh]",onClick:m=>m.stopPropagation(),children:[e.jsx("img",{src:s.url||s.dataUrl,alt:s.caption||s.name,className:"max-w-full max-h-[85vh] object-contain rounded-lg shadow-2xl"}),s.caption&&e.jsx("p",{className:"text-white text-center mt-3 bg-black/50 p-2 rounded-md",children:s.caption}),e.jsx("button",{onClick:c,className:"absolute -top-3 -right-3 bg-white/80 text-black p-1 rounded-full text-2xl w-8 h-8 flex items-center justify-center leading-none hover:bg-white transition-colors","aria-label":"Close image viewer",children:"×"})]})}),X=({problem:s,project:c,allSuppliers:m,isOpen:k,onClose:b})=>{const[w,f]=o.useState(null),j=o.useMemo(()=>!s?.workerIds||!c?.workers?[]:c.workers.filter(t=>s.workerIds.includes(t.id)),[s,c]),d=o.useMemo(()=>!s?.supplierIds||!m?[]:m.filter(t=>s.supplierIds.includes(t.id)),[s,m]),u=o.useMemo(()=>!s?.tenantIds||!c?.tenants?[]:c.tenants.filter(t=>s.tenantIds.includes(t.id)),[s,c]);if(!s)return null;const N=()=>{f(null),b()},p=C[s.severity]||{bg:"bg-slate-100",text:"text-slate-700"};return e.jsxs(e.Fragment,{children:[e.jsx(D,{isOpen:k,onClose:N,title:"פרטי תקלה",size:"xl",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("header",{className:"pb-4 border-b",children:[e.jsx("p",{className:"text-lg font-semibold text-slate-800",children:s.description}),e.jsxs("div",{className:"flex items-center gap-4 mt-2 text-sm text-slate-600",children:[e.jsxs("span",{className:`px-3 py-1 text-xs font-semibold rounded-full ${p.bg} ${p.text}`,children:["חומרה: ",s.severity]}),s.locationTag&&e.jsxs("span",{children:[e.jsx("strong",{children:"מיקום:"})," ",s.locationTag]})]})]}),s.notes&&e.jsxs("div",{className:"prose max-w-none",children:[e.jsx("h3",{className:"text-md font-semibold text-slate-700",children:"הערות נוספות:"}),e.jsx("p",{className:"text-slate-600",children:s.notes})]}),(j.length>0||d.length>0||u.length>0)&&e.jsxs("div",{className:"pt-4 border-t",children:[e.jsx("h3",{className:"text-md font-semibold text-slate-700 mb-2",children:"גורמים משויכים"}),e.jsxs("div",{className:"flex flex-wrap gap-x-8 gap-y-4 text-sm",children:[j.length>0&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-slate-600",children:"עובדים:"}),e.jsx("ul",{className:"list-disc list-inside text-slate-800",children:j.map(t=>e.jsx("li",{children:t.name},t.id))})]}),d.length>0&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-slate-600",children:"ספקים:"}),e.jsx("ul",{className:"list-disc list-inside text-slate-800",children:d.map(t=>e.jsxs("li",{children:[t.name," (",t.group,")"]},t.id))})]}),u.length>0&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-slate-600",children:"דיירים:"}),e.jsx("ul",{className:"list-disc list-inside text-slate-800",children:u.map(t=>e.jsx("li",{children:t.name},t.id))})]})]})]}),e.jsxs("div",{children:[e.jsxs("h3",{className:"text-md font-semibold text-slate-700 mb-2",children:["תמונות (",s.images.length,"):"]}),s.images.length>0?e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4",children:s.images.map(t=>e.jsxs("div",{children:[e.jsx("button",{type:"button",onClick:()=>f(t),className:"border rounded-lg overflow-hidden shadow-sm block w-full hover:shadow-lg transition-shadow",children:e.jsx("img",{src:t.url||t.dataUrl,alt:t.caption||t.name,className:"w-full h-48 object-cover"})}),t.caption&&e.jsx("p",{className:"text-xs text-slate-600 mt-1 text-center bg-slate-50 p-1 rounded-b-md",children:t.caption})]},t.id))}):e.jsx("p",{className:"text-slate-500 text-center py-4",children:"אין תמונות מצורפות לתקלה זו."})]})]})}),w&&e.jsx(Q,{image:w,onClose:()=>f(null)})]})},Z=({problem:s,project:c,allSuppliers:m,onDelete:k,onMove:b,isFirst:w,isLast:f})=>{const{projectId:j,reportId:d}=L(),[u,N]=o.useState(!1),[p,t]=o.useState(!1),[h,S]=o.useState([]),{addToast:y}=O(),P=C[s.severity]||{bg:"bg-slate-100",text:"text-slate-700"},T=s.images.length>0,g=T?s.images[0].url||s.images[0].dataUrl:"",M=l=>{S(a=>a.includes(l)?a.filter(n=>n!==l):[...a,l])},v=async()=>{const l=s.images.filter(a=>h.includes(a.id));if(l.length===0){y("יש לבחור לפחות תמונה אחת לשיתוף","warning");return}try{const a=l.map(n=>({dataUrl:n.url||n.dataUrl,name:n.name}));await K(a,`תמונות עבור תקלה: ${s.description}`),S([])}catch(a){y(a.message,"error")}},i=()=>{S([]),N(!0)};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"bg-white shadow-md rounded-xl flex items-start p-4 gap-4 border border-slate-200/80 transition-shadow hover:shadow-xl",children:[e.jsx("button",{type:"button",onClick:()=>t(!0),className:"w-20 h-20 flex-shrink-0 rounded-lg overflow-hidden bg-slate-100 group transition-transform hover:scale-105",title:"הצג פרטים ותמונות",children:T&&g?e.jsx("img",{src:g,alt:`תמונת תקלה: ${s.description.substring(0,30)}`,className:"w-full h-full object-cover"}):e.jsx("div",{className:"w-full h-full flex items-center justify-center text-center",children:e.jsx("span",{className:"text-xs font-semibold text-slate-400",children:"אין תמונה"})})}),e.jsxs("div",{className:"flex-grow flex flex-col self-stretch min-w-0",children:[e.jsxs("div",{className:"flex justify-between items-start mb-1",children:[e.jsx("h5",{className:"text-md font-semibold text-slate-800 flex-grow",title:s.description,children:s.description}),e.jsx("span",{className:`ms-2 rtl:mr-2 px-2 py-0.5 text-xs font-semibold rounded-full whitespace-nowrap ${P.bg} ${P.text}`,children:s.severity})]}),s.locationTag&&e.jsxs("p",{className:"text-xs text-slate-500 mb-1",children:[e.jsx("span",{className:"font-medium",children:"מיקום:"})," ",s.locationTag]}),e.jsx("p",{className:"text-sm text-slate-600 mb-2 text-ellipsis overflow-hidden leading-tight flex-grow",children:s.notes||"אין הערות נוספות."}),e.jsxs("div",{className:"flex items-center justify-between mt-auto pt-2 border-t border-slate-200/60",children:[e.jsxs("div",{className:"flex items-center space-x-1 rtl:space-x-reverse",children:[e.jsx("button",{onClick:()=>b(s.id,"up"),disabled:w,className:"p-2 text-slate-500 rounded-full hover:bg-slate-100 disabled:opacity-30 disabled:cursor-not-allowed",children:e.jsx(E,{className:"w-5 h-5"})}),e.jsx("button",{onClick:()=>b(s.id,"down"),disabled:f,className:"p-2 text-slate-500 rounded-full hover:bg-slate-100 disabled:opacity-30 disabled:cursor-not-allowed",children:e.jsx(U,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"flex items-center space-x-1 rtl:space-x-reverse",children:[s.images.length>0&&e.jsxs("button",{onClick:i,className:"p-2 text-slate-500 hover:text-sky-600 transition-colors rounded-full hover:bg-sky-50 flex items-center gap-1",title:"צפה ושתף תמונות",children:[e.jsx(R,{className:"w-5 h-5"}),e.jsx("span",{className:"text-xs font-semibold",children:s.images.length})]}),e.jsx($,{to:`/project/${j}/report/${d}/problem/${s.id}/edit`,className:"p-2 text-slate-500 hover:text-sky-600 transition-colors rounded-full hover:bg-sky-50",title:"ערוך תקלה",children:e.jsx(H,{className:"w-5 h-5"})}),e.jsx("button",{onClick:()=>k(s.id),className:"p-2 text-slate-500 hover:text-red-600 transition-colors rounded-full hover:bg-red-50",title:"מחק תקלה",children:e.jsx(A,{className:"w-5 h-5"})})]})]})]})]}),e.jsx(X,{isOpen:p,onClose:()=>t(!1),problem:s,project:c,allSuppliers:m}),u&&e.jsxs(D,{isOpen:u,onClose:()=>N(!1),title:"בחר תמונות לשיתוף",size:"xl",children:[e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4 p-2 max-h-[65vh] overflow-y-auto",children:s.images.map(l=>e.jsxs("div",{className:"relative group border-2 rounded-lg overflow-hidden shadow-sm cursor-pointer",onClick:()=>M(l.id),style:{borderColor:h.includes(l.id)?"#0284c7":"transparent"},children:[e.jsx("img",{src:l.url||l.dataUrl,alt:l.name,className:"w-full h-40 object-cover"}),e.jsx("div",{className:"absolute top-2 right-2 bg-white/80 rounded-full p-1 transition-opacity opacity-75 group-hover:opacity-100",children:e.jsx("div",{className:`w-5 h-5 rounded-full border-2 transition-colors ${h.includes(l.id)?"bg-sky-500 border-sky-600":"bg-white border-slate-400"}`,children:h.includes(l.id)&&e.jsx(G,{className:"w-full h-full text-white"})})})]},l.id))}),e.jsx("div",{className:"mt-4 pt-4 border-t flex justify-end",children:e.jsxs("button",{onClick:v,disabled:h.length===0,className:"px-6 py-2 text-sm font-medium text-white bg-sky-600 hover:bg-sky-700 rounded-md shadow-sm disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2",children:["שתף (",h.length,") תמונות"]})})]})]})},le=()=>{const{projectId:s,reportId:c}=L();F();const[m,k]=o.useState(null),[b,w]=o.useState(null),[f,j]=o.useState([]),[d,u]=o.useState([]),[N,p]=o.useState(!0),{addToast:t}=O(),[h,S]=o.useState("all"),y=o.useCallback(async()=>{if(!(!c||!s)){p(!0);try{const[i,l,a,n]=await Promise.all([W(c),z(s),B(c),V()]);k(i),w(l),u(a.sort((x,I)=>x.order-I.order)),j(n)}catch{t("Error fetching problems","error")}finally{p(!1)}}},[c,s,t]);o.useEffect(()=>{y()},[y]);const P=async i=>{if(window.confirm("האם אתה בטוח שברצונך למחוק תקלה זו?"))try{await J(i),t("התקלה נמחקה בהצלחה","success"),y()}catch{t("שגיאה במחיקת התקלה","error")}},T=async(i,l)=>{const a=d.findIndex(I=>I.id===i);if(a===-1)return;const n=l==="up"?a-1:a+1;if(n<0||n>=d.length)return;const x=[...d];[x[a],x[n]]=[x[n],x[a]],x[a].order=a,x[n].order=n,u(x);try{await q([x[a],x[n]])}catch{t("שגיאה בעדכון סדר התקלות","error"),u(d)}},g=o.useMemo(()=>{const i={[r.CRITICAL]:0,[r.HIGH]:0,[r.MEDIUM]:0,[r.LOW]:0,all:d.length};return d.forEach(l=>{i[l.severity]++}),i},[d]),M=o.useMemo(()=>h==="all"?d:d.filter(i=>i.severity===h),[d,h]),v=({label:i,value:l,count:a,color:n})=>{const x=h===i,I=n?`${n.bg} ${n.text} ring-2 ring-offset-1 ${n.text.replace("text","ring")}`:"bg-sky-600 text-white ring-2 ring-offset-1 ring-sky-600";return e.jsxs("button",{onClick:()=>S(i),className:`px-3 py-1.5 rounded-full text-sm font-semibold transition-all flex items-center gap-2 ${x?I:"bg-white text-slate-700 hover:bg-slate-100"}`,children:[l,e.jsx("span",{className:`px-2 py-0.5 rounded-full text-xs ${x?"bg-white/20":"bg-slate-200"}`,children:a})]})};return N?e.jsx(Y,{text:"טוען תקלות..."}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("nav",{className:"text-sm mb-1",children:e.jsx($,{to:`/project/${s}/report/${c}`,className:"text-sky-600 hover:underline",children:"חזרה לדוח"})}),e.jsxs("h2",{className:"text-2xl font-semibold text-slate-700",children:["תקלות בדוח: ",m?.title]})]}),e.jsxs($,{to:`/project/${s}/report/${c}/problem/new`,className:"bg-sky-600 hover:bg-sky-700 text-white font-medium py-2 px-4 rounded-lg shadow-md flex items-center transition-colors",children:[e.jsx(_,{className:"w-5 h-5 me-2 rtl:ml-2"})," הוסף תקלה"]})]}),e.jsxs("div",{className:"bg-slate-100 p-2 rounded-lg flex items-center justify-center gap-2 flex-wrap",children:[e.jsx(v,{label:"all",value:"הכל",count:g.all}),e.jsx(v,{label:r.CRITICAL,value:r.CRITICAL,count:g[r.CRITICAL],color:C[r.CRITICAL]}),e.jsx(v,{label:r.HIGH,value:r.HIGH,count:g[r.HIGH],color:C[r.HIGH]}),e.jsx(v,{label:r.MEDIUM,value:r.MEDIUM,count:g[r.MEDIUM],color:C[r.MEDIUM]}),e.jsx(v,{label:r.LOW,value:r.LOW,count:g[r.LOW],color:C[r.LOW]})]}),M.length>0?e.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4",children:M.map((i,l)=>e.jsx(Z,{problem:i,project:b,allSuppliers:f,onDelete:P,onMove:T,isFirst:l===0,isLast:l===M.length-1},i.id))}):e.jsx("div",{className:"text-center p-10 bg-white rounded-lg shadow border",children:e.jsx("p",{className:"text-slate-500",children:h==="all"?"לא נמצאו תקלות בדוח זה.":"אין תקלות ברמת חומרה זו."})})]})};export{le as default};
